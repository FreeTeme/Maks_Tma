<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/USDT ‚Äî –ü–æ–∏—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-0: #0f1419;
            --bg-1: #11161c;
            --bg-2: #131a21;
            --bg-3: #0b1015;
            --panel: #0f151b;
            --border: #1c2631;
            --muted: #8b99a8;
            --text: #e5edf5;
            --accent: #f7931a;
            --green: #22c55e;
            --red: #ef4444;
        }

        html, body { 
            height: 100%; 
            margin: 0;
            padding: 0;
        }
        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: radial-gradient(1200px 600px at 20% -10%, #0b1117 0%, #0a0f14 45%, #070b0f 100%);
            color: var(--text);
            overflow: hidden;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(17,22,28,0.85), rgba(17,22,28,0.65));
            backdrop-filter: blur(6px);
            flex-shrink: 0;
            flex-wrap: wrap; /* –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            gap: 10px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        }

        .brand { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-shrink: 0;
        }

        .kpis { 
            display: flex; 
            gap: 12px; 
            align-items: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–∏–º–≤–æ–ª–∞ */
        .symbol-selector {
            margin-left: 15px;
            flex-shrink: 0;
        }

        .symbol-select {
            background: #1a222c;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            min-width: 120px;
        }

        .symbol-select option {
            background: var(--bg-2);
            color: var(--text);
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            overflow: hidden;
            flex: 1;
            margin: 12px;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, var(--bg-2), var(--bg-3));
            flex-shrink: 0;
        }
        .left-tools, .right-tools { display: flex; gap: 6px; align-items: center; }
        .left-tools { justify-content: space-between; width: 100%; flex-wrap: wrap; }
        .right-tools { flex-wrap: nowrap; }
        .btn {
            background: #1a222c;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.15s ease;
            white-space: nowrap;
        }
        .tf .btn { flex: 1; }
        .btn:hover { background: #212a34; }
        .btn.primary { background: var(--accent); border-color: #ffb547; color: #0c0f12; font-weight: 600; }
        .btn.primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.analyze { 
            background: #22c55e !important; 
            border-color: #16a34a !important; 
            color: #ffffff !important; 
            font-weight: 600; 
            padding: 8px 12px; 
            font-size: 13px; 
        }
        .btn.analyze:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background: #22c55e !important; 
        }
        .btn.analyze:hover { 
            background: #16a34a !important; 
            border-color: #15803d !important;
        }
        .btn.clear { 
            background: #dc2626 !important; 
            border-color: #b91c1c !important; 
            color: #ffffff !important; 
            font-weight: 600; 
        }
        .btn.clear:hover { 
            background: #b91c1c !important; 
            border-color: #991b1b !important;
        }
        .tf { display: flex; gap: 6px; flex: 1; }
        .tf .btn.active { background: #2a3542; border-color: #334153; }
        .sep { width: 1px; height: 22px; background: var(--border); }
        .counter { font-size: 12px; color: var(--muted); }
        .counter strong { color: var(--text); }

        .chart-wrap { 
            position: relative; 
            flex: 1; 
            min-height: 300px; 
        }
        #chart { 
            width: 100%; 
            height: 100%; 
            touch-action: pan-x pan-y pinch-zoom;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .side {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 0 12px 60px;
            overflow-y: auto;
        }
        .side.active {
            display: flex;
        }
        .card { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            padding: 10px; 
        }
        .card h3 { margin: 0 0 6px; font-size: 13px; color: var(--muted); font-weight: 600; }
        .stat-list { display: grid; gap: 6px; }
        .stat { display: flex; justify-content: space-between; font-size: 12px; }
        .stat .val { color: var(--text); font-weight: 600; }

        .matches { display: grid; gap: 8px; }
        .match {
            border: 1px solid var(--border);
            border-radius: 8px; 
            padding: 8px;
            background: #0f151b;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .match:hover { 
            background: #131a21; 
            border-color: #2a3847; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .match::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        .match:hover::before {
            left: 100%;
        }
        .match.active {
            background: linear-gradient(135deg, #1a222c, #131a21);
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(247, 147, 26, 0.3);
            transform: translateY(-2px);
        }
        .match.active::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--accent);
            font-weight: bold;
            font-size: 14px;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π */
        .selected-candles-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b35, #ff8c42);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 6px 16px rgba(255, 107, 53, 0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4); }
        }
        .match .hdr { display: flex; justify-content: space-between; align-items: center; }
        .match .range { font-size: 11px; color: var(--muted); }
        .badge { 
            padding: 4px 8px; 
            border-radius: 999px; 
            font-size: 11px; 
            font-weight: 700; 
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .badge.up { 
            background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.1)); 
            color: var(--green); 
            border-color: rgba(34,197,94,0.3);
            box-shadow: 0 2px 8px rgba(34,197,94,0.2);
        }
        .badge.down { 
            background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.1)); 
            color: var(--red); 
            border-color: rgba(239,68,68,0.3);
            box-shadow: 0 2px 8px rgba(239,68,68,0.2);
        }

        .footer-note { font-size: 11px; color: var(--muted); text-align: center; padding-top: 4px; }
        
        /* –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ */
        .pattern-distribution {
            margin: 12px 0;
            display: grid;
            gap: 8px;
        }
        
        .distribution-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .distribution-label {
            flex: 1;
            color: var(--muted);
            font-weight: 500;
        }
        
        .distribution-bar {
            flex: 2;
            height: 8px;
            background: var(--bg-2);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .distribution-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
            position: relative;
        }
        
        .distribution-fill.bullish {
            background: linear-gradient(90deg, #22c55e, #16a34a);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
        }
        
        .distribution-fill.bearish {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }
        
        .distribution-value {
            min-width: 30px;
            text-align: right;
            color: var(--text);
            font-weight: 600;
            font-size: 11px;
        }
        
        /* –ù–µ–¥–∞–≤–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã */
        .recent-patterns {
            display: grid;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .recent-pattern {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .recent-pattern:hover {
            background: var(--bg-3);
            border-color: #334153;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .recent-pattern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s ease;
        }
        
        .recent-pattern:hover::before {
            left: 100%;
        }
        
        .recent-pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .recent-pattern-dates {
            font-size: 11px;
            color: var(--muted);
        }
        
        .recent-pattern-direction {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .recent-pattern-direction.bullish {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .recent-pattern-direction.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .recent-pattern-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 11px;
        }
        
        .recent-pattern-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recent-pattern-stat-label {
            color: var(--muted);
        }
        
        .recent-pattern-stat-value {
            color: var(--text);
            font-weight: 600;
        }
        
        .recent-pattern-stat-value.positive {
            color: var(--green);
        }
        
        .recent-pattern-stat-value.negative {
            color: var(--red);
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ */
        .general-analysis-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--muted);
        }
        
        .general-analysis-loading i {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }
        
        /* –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ */
        .mini-chart-container {
            margin: 12px 0;
            padding: 8px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
        }
        
        .mini-chart-container canvas {
            border-radius: 4px;
            background: var(--bg-3);
        }
        
        .mini-chart-label {
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px;
            font-weight: 500;
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ */
        .performance-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: grid;
            gap: 8px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .summary-label {
            color: var(--muted);
            font-weight: 500;
        }
        
        .summary-value {
            font-weight: 600;
            font-size: 13px;
        }
        
        .summary-value.bullish {
            color: var(--green);
        }
        
        .summary-value.bearish {
            color: var(--red);
        }

        
        .chart-controls {
            display: none;
            position: absolute;
            bottom: 12px;
            left: 12px;
            right: 12px;
            background: rgba(17, 22, 28, 0.95);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            z-index: 50;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        .chart-controls.visible {
            display: flex;
            flex-direction: row;
            gap: 8px;
            align-items: center;
        }
        .chart-controls.collapsed {
            left: 50%;
            right: auto;
            transform: translateX(-50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chart-controls.collapsed .control-btn {
            display: none;
        }
        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 14px;
            background: #1a222c;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: 500;
            flex: 1;
        }
        .control-btn:hover {
            background: #212a34;
            border-color: #334153;
        }
        .control-btn i {
            font-size: 14px;
            width: 18px;
            text-align: center;
        }
        .toggle-controls-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: var(--accent);
            border: 1px solid #ffb547;
            border-radius: 8px;
            color: #0c0f12;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            min-width: 38px;
            flex-shrink: 0;
        }
        .toggle-controls-btn:hover {
            background: #ffb547;
        }
        .chart-controls.collapsed .toggle-controls-btn {
            border-radius: 50%;
            width: 100%;
            height: 100%;
            min-width: 48px;
        }

        /* Mobile bottom navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-1);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px 16px;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(17, 22, 28, 0.9);
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 24px;
            font-size: 13px;
            color: #ffffff;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            font-weight: 600;
        }
        .nav-btn.active {
            color: var(--accent);
            background: rgba(247, 147, 26, 0.1);
        }
        .nav-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        #nav-analysis {
            background: #22c55e !important;
            border: 1px solid #16a34a;
        }
        #nav-analysis:hover {
            background: #16a34a !important;
        }
        #nav-volume {
            background: #1a222c !important;
            border: 1px solid var(--border);
        }
        #nav-volume:hover {
            background: #212a34 !important;
        }
        #nav-clear {
            background: #dc2626 !important;
            border: 1px solid #b91c1c;
        }
        #nav-clear:hover {
            background: #b91c1c !important;
        }

        /* Modal for patterns */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(7, 11, 15, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--panel);
            border-radius: 12px;
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        /* Clear Modal Styles */
        .clear-modal-content {
            max-width: 450px;
            text-align: center;
        }
        
        .clear-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }
        
        .clear-icon i {
            font-size: 32px;
            color: #ffffff;
        }
        
        .clear-modal-content h3 {
            margin: 0 0 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
        }
        
        .clear-modal-content p {
            margin: 0 0 24px;
            font-size: 14px;
            color: var(--muted);
            line-height: 1.5;
        }
        
        .clear-stats {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin: 0 0 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }
        
        .clear-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .btn.clear-confirm {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .btn.clear-confirm:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        }
        
        .btn.clear-cancel {
            background: var(--bg-2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn.clear-cancel:hover {
            background: var(--bg-3);
            border-color: #334153;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title {
            font-weight: 600;
            font-size: 16px;
        }
        .close-modal {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .close-modal:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        /* Overlay + toast */
        .loading {
            position: fixed; 
            inset: 0; 
            display: none; 
            align-items: center; 
            justify-content: center;
            background: rgba(3,6,9,0.55); 
            backdrop-filter: blur(2px); 
            z-index: 50;
        }
        .spinner { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: 3px solid rgba(255,255,255,0.12); 
            border-top-color: var(--accent); 
            animation: spin 0.9s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { 
            position: fixed; 
            bottom: 70px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #111821; 
            border: 1px solid #223041; 
            color: #e3edf7; 
            padding: 10px 14px; 
            border-radius: 10px; 
            font-size: 13px; 
            display: none; 
            z-index: 60;
            max-width: 80%;
            text-align: center;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .app {
                display: grid;
                grid-template-rows: auto 1fr;
            }
            
            .main {
                display: grid;
                grid-template-columns: 1fr 320px;
                gap: 12px;
                padding: 12px;
                overflow: hidden;
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
            #nav-analysis-overlay {
                display: none !important;
            }
            
            .panel {
                margin: 0;
            }
            
            .side {
                display: flex;
                padding: 0;
                overflow-y: auto;
            }
            
            .mobile-nav {
                display: none;
            }
            
            .topbar {
                padding: 16px 20px;
            }
            
            .brand .logo {
                width: 28px; 
                height: 28px;
            }
            
            .brand .title {
                font-size: 16px;
            }
            
            .kpis {
                gap: 16px;
                font-size: 13px;
            }
            
            .toolbar {
                padding: 10px 12px;
            }
            
            .btn {
                padding: 8px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            .chart-controls {
                bottom: 80px;
            }
            
            .chart-controls.collapsed {
                bottom: 80px;
            }
            
            .control-btn span {
                display: none;
            }
            
            .control-btn {
                padding: 8px;
                min-width: 40px;
                justify-content: center;
            }
            
            /* Hide desktop action buttons on mobile (use mobile-nav instead) */
            #toggle-volume-btn, #analyze-btn, #clear-btn {
                display: none !important;
            }
        }

        @media (max-width: 380px) {
            .toolbar {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .left-tools, .right-tools {
                flex-wrap: wrap;
            }
            
            .btn {
                font-size: 11px;
                padding: 5px 6px;
            }
            
            .counter {
                font-size: 11px;
            }
            
            .chart-controls {
                gap: 6px;
                padding: 8px;
                left: 8px;
                right: 8px;
            }
            
            .chart-controls.collapsed {
                width: 44px;
                height: 44px;
            }
            
            .control-btn {
                padding: 6px;
                min-width: 36px;
            }
            
            .toggle-controls-btn {
                padding: 6px;
                min-width: 34px;
                font-size: 14px;
            }
            
            .chart-controls.collapsed .toggle-controls-btn {
                min-width: 44px;
            }
        }

        .symbol-selector {
            margin-left: 15px;
        }

        .symbol-select {
            background: #1a222c;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            min-width: 120px;
        }

        .symbol-select option {
            background: var(--bg-2);
            color: var(--text);
        }

        .update-status {
            font-size: 12px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="topbar">
            <div class="brand">
                <div class="logo"></div>
                <!-- –í —Ä–∞–∑–¥–µ–ª–µ .brand, –ø–æ—Å–ª–µ .title -->
                <div class="title" id="page-title">–ü–æ–∏—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</div>
                <div class="symbol-selector">
                    <select id="symbol-select" class="symbol-select">
                        <option value="BTC#USDT">BTC/USDT</option>
                        <option value="ETH#USDT">ETH/USDT</option>
                        <option value="XRP#USDT">XRP/USDT</option>
                        <option value="SOL#USDT">SOL/USDT</option>
                        <option value="BNB#USDT">BNB/USDT</option>
                        <option value="TRX#USDT">TRX/USDT</option>
                        <option value="ADA#USDT">ADA/USDT</option>
                        <option value="SUI#USDT">SUI/USDT</option>
                        <option value="LINK#USDT">LINK/USDT</option>
                        <option value="LTC#USDT">LTC/USDT</option>
                        <option value="TON#USDT">TON/USDT</option>
                    </select>
                </div>
            </div>
            <div id="update-status" class="update-status" style="display: none;">
                <i class="fas fa-sync fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...
            </div>
        </div>

        <div class="main">
            <div class="panel">
                <div class="toolbar">
                    <div class="left-tools">
                        <div class="tf">
                            <button class="btn" data-tf="1h">1 —á–∞—Å</button>
                            <button class="btn" data-tf="4h">4 —á–∞—Å–∞</button>
                            <button class="btn active" data-tf="1d">1 –¥–µ–Ω—å</button>
                            <button class="btn" data-tf="1w">1 –Ω–µ–¥–µ–ª—è</button>
                        </div>
                        <div class="right-tools">
                            <button id="toggle-volume-btn" class="btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ–±—ä–µ–º">
                                <i class="fas fa-chart-bar"></i> –û–±—ä–µ–º
                            </button>
                            <!-- <button id="reset-view-btn" class="btn">–°–±—Ä–æ—Å</button> -->
                            <button id="analyze-btn" class="btn analyze" disabled>
                                <i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏–∑
                            </button>
                            <button id="clear-btn" class="btn clear">
                                <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                            <!-- <button id="test-update-btn" class="btn" style="background: #8b5cf6;">
                                <i class="fas fa-bolt"></i> –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            </button> -->
                        </div>
                    </div>
                </div>
                <div class="chart-wrap">
                    <div id="chart"></div>
                    <!-- Chart Controls Overlay -->
                    <div class="chart-controls" id="chart-controls">
                        <button class="control-btn" id="nav-prev">
                            <i class="fas fa-chevron-left"></i>
                            <span>–ù–∞–∑–∞–¥</span>
                        </button>
                        <button class="control-btn" id="nav-next">
                            <i class="fas fa-chevron-right"></i>
                            <span>–í–ø–µ—Ä–µ–¥</span>
                        </button>
                        <button class="control-btn" id="nav-to-selected">
                            <i class="fas fa-search"></i>
                            <span>–ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º</span>
                        </button>
                        <button class="control-btn" id="nav-analysis-overlay">
                            <i class="fas fa-chart-line"></i>
                            <span>–ê–Ω–∞–ª–∏–∑</span>
                        </button>
                        <button class="control-btn" id="nav-patterns">
                            <i class="fas fa-shapes"></i>
                            <span>–ü–∞—Ç—Ç–µ—Ä–Ω—ã</span>
                        </button>
                        <button class="toggle-controls-btn" id="toggle-controls-btn" title="–°–≤–µ—Ä–Ω—É—Ç—å/–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="side" id="side-panel">
                <!-- –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ -->
                <div class="card" id="general-analysis-card">
                    <h3>–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</h3>
                    <div class="stat-list" id="general-stats">
                        <div class="stat"><span>–í—Å–µ–≥–æ —Å–≤–µ—á–µ–π</span><span class="val" id="total-candles">-</span></div>
                        <div class="stat"><span>–ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö</span><span class="val" id="data-period">-</span></div>
                        <div class="stat"><span>–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</span><span class="val" id="volatility">-</span></div>
                        <div class="stat"><span>–°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º</span><span class="val" id="avg-volume">-</span></div>
                    </div>
                    <div class="pattern-distribution">
                        <div class="distribution-item">
                            <span class="distribution-label">–ë—ã—á—å–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</span>
                            <div class="distribution-bar">
                                <div class="distribution-fill bullish" id="bullish-bar"></div>
                            </div>
                            <span class="distribution-value" id="bullish-count">0</span>
                        </div>
                        <div class="distribution-item">
                            <span class="distribution-label">–ú–µ–¥–≤–µ–∂—å–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</span>
                            <div class="distribution-bar">
                                <div class="distribution-fill bearish" id="bearish-bar"></div>
                            </div>
                            <span class="distribution-value" id="bearish-count">0</span>
                        </div>
                    </div>
                    <div class="mini-chart-container" id="mini-chart-container" style="display: none;">
                        <canvas id="mini-chart" width="280" height="80"></canvas>
                        <div class="mini-chart-label">–¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</div>
                    </div>
                    <!-- <button class="btn analyze" id="load-general-analysis" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-chart-pie"></i> –ê–Ω–∞–ª–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
                    </button> -->
                </div>
                
                <!-- –ù–µ–¥–∞–≤–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã -->
                <div class="card" id="recent-patterns-card" style="display:none">
                    <h3>–ù–µ–¥–∞–≤–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</h3>
                    <div class="recent-patterns" id="recent-patterns-list"></div>
                </div>
                
                <div class="card">
                    <h3>–ò—Ç–æ–≥–∏ –∞–Ω–∞–ª–∏–∑–∞</h3>
                    <div class="stat-list">
                        <div class="stat"><span>–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</span><span class="val" id="matches-found">0</span></div>
                        <div class="stat"><span>–î–ª–∏–Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞</span><span class="val" id="pattern-length">0</span></div>
                        <div class="stat"><span>–°—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å</span><span class="val" id="accuracy">0%</span></div>
                    </div>
                    <div class="footer-note">–í—ã–±–µ—Ä–∏—Ç–µ 1‚Äì6 —Å–≤–µ—á–µ–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑</div>
                </div>
                <div class="card" id="pattern-info-card" style="display:none">
                    <h3>–ü–∞—Ç—Ç–µ—Ä–Ω</h3>
                    <div class="stat-list" id="pattern-info"></div>
                </div>
                <div class="card">
                    <h3>–°–æ–≤–ø–∞–¥–µ–Ω–∏—è</h3>
                    <div class="matches" id="matches"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <button class="nav-btn" id="nav-volume">
            <i class="fas fa-chart-bar"></i>
            <span>–û–±—ä–µ–º</span>
        </button>
        <button class="nav-btn" id="nav-analysis">
            <i class="fas fa-chart-line"></i>
            <span>–ê–Ω–∞–ª–∏–∑</span>
        </button>
        <button class="nav-btn" id="nav-clear">
            <i class="fas fa-trash"></i>
            <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
        </button>
    </div>

    <!-- Patterns Modal -->
    <div class="modal" id="patterns-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="pattern-stats" id="modal-pattern-stats" style="margin-bottom: 16px; padding: 12px; background: var(--bg-2); border-radius: 8px; border: 1px solid var(--border);">
                    <!-- Pattern statistics will be inserted here -->
                </div>
                <div id="modal-patterns-list">
                    <!-- Patterns will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Confirmation Modal -->
    <div class="modal" id="clear-confirmation-modal">
        <div class="modal-content clear-modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-trash-alt" style="margin-right: 8px; color: #dc2626;"></i>
                    –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
                </div>
                <button class="close-modal" id="close-clear-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="clear-modal-content">
                    <div class="clear-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <h3>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?</h3>
                    <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Å–±—Ä–æ—Å–∏—Ç –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—á–∏ –∏ –∞–Ω–∞–ª–∏–∑. –í—ã —Å–º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.</p>
                    <div class="clear-stats" id="clear-stats">
                        <div class="stat-item">
                            <span class="stat-label">–í—ã–±—Ä–∞–Ω–æ —Å–≤–µ—á–µ–π:</span>
                            <span class="stat-value" id="selected-count-modal">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–ù–∞–π–¥–µ–Ω–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:</span>
                            <span class="stat-value" id="patterns-count-modal">0</span>
                        </div>
                    </div>
                    <div class="clear-actions">
                        <button class="btn clear-confirm" id="confirm-clear-btn">
                            <i class="fas fa-sync-alt"></i>
                            <span>–î–∞, –æ–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                        <button class="btn clear-cancel" id="cancel-clear-btn">
                            <i class="fas fa-times"></i>
                            <span>–û—Ç–º–µ–Ω–∞</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
		// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è textContent
        function safeSetTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        function safeSetInnerHTML(elementId, html) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = html;
            }
        }

        function safeSetStyle(elementId, property, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style[property] = value;
            }
        }

        class SmartChartUpdater {
            constructor(chartInstance) {
                this.chart = chartInstance;
                this.lastKnownTimestamp = null;
                this.updateIntervals = {
                    '1h': 30000,    // 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    '4h': 60000,    // 1 –º–∏–Ω—É—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è  
                    '1d': 120000,   // 2 –º–∏–Ω—É—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    '1w': 300000    // 5 –º–∏–Ω—É—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                };
                this.isUpdating = false;
                this.updateTimer = null;
                this.symbol = 'BTC#USDT';
                this.timeframe = '1d';
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            initialize(symbol, timeframe) {
                console.log(`üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${symbol}, ${timeframe}`);
                this.symbol = symbol;
                this.timeframe = timeframe;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∞–π–º—Å—Ç–∞–º–ø
                if (this.chart.allCandles && this.chart.allCandles.length > 0) {
                    const lastCandle = this.chart.allCandles[this.chart.allCandles.length - 1];
                    this.lastKnownTimestamp = lastCandle.open_time;
                    console.log(`üìÖ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–≤–µ—á–∞: ${this.lastKnownTimestamp}`);
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤–µ—á–µ–π, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É –∫–∞–∫ —Ç–æ—á–∫—É –æ—Ç—Å—á–µ—Ç–∞
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    this.lastKnownTimestamp = yesterday.toISOString();
                    console.log(`üìÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${this.lastKnownTimestamp}`);
                }
                
                this.startAutoUpdates();
            }

            // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            startAutoUpdates() {
                if (this.updateTimer) {
                    clearInterval(this.updateTimer);
                }
                
                const interval = this.updateIntervals[this.timeframe] || 30000;
                console.log(`‚è∞ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ ${interval}ms`);
                
                // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(() => {
                    this.smartUpdate();
                }, 5000);
                
                this.updateTimer = setInterval(() => {
                    this.smartUpdate();
                }, interval);
            }

            // –£–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            async smartUpdate() {
                if (this.isUpdating) {
                    console.log('‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–µ–∂–µ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                const freshness = this.checkDataFreshness();
                
                this.isUpdating = true;
                console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...');
                
                try {
                    // –ï–°–õ–ò –î–ê–ù–ù–´–ï –°–ò–õ–¨–ù–û –£–°–¢–ê–†–ï–õ–ò - –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –û–ë–ù–û–í–õ–Ø–ï–ú –°–ï–†–í–ï–†
                    if (freshness === 'stale') {
                        console.log('üîÑ –î–∞–Ω–Ω—ã–µ —Å–∏–ª—å–Ω–æ —É—Å—Ç–∞—Ä–µ–ª–∏, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...');
                        
                        try {
                            const refreshResult = await this.forceRefreshServerData();
                            console.log('‚úÖ –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', refreshResult);
                            
                            // –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º lastKnownTimestamp –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                            this.lastKnownTimestamp = null;
                            
                        } catch (refreshError) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', refreshError);
                            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
                        }
                    }
                    
                    const updateCheck = await this.checkForUpdates();
                    console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:', updateCheck);
                    
                    if (!updateCheck.has_updates) {
                        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã');
                        return;
                    }
                    
                    console.log(`üÜï –ù–∞–π–¥–µ–Ω–æ ${updateCheck.new_candles_count} –Ω–æ–≤—ã—Ö —Å–≤–µ—á–µ–π`);
                    
                    const newData = await this.loadIncrementalData();
                    
                    if (newData && newData.has_updates && newData.new_candles && newData.new_candles.length > 0) {
                        await this.updateChartWithNewData(newData.new_candles);
                        this.lastKnownTimestamp = newData.latest_timestamp;
                        
                        console.log(`‚úÖ –ì—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω —Å ${newData.new_candles.length} –Ω–æ–≤—ã–º–∏ —Å–≤–µ—á–∞–º–∏`);
                        this.showUpdateNotification(newData.new_candles.length);
                    } else {
                        console.log('‚ÑπÔ∏è –ù–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç');
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                } finally {
                    this.isUpdating = false;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            async checkForUpdates() {
                try {
                    const url = `/api/pattern/check_updates?symbol=${encodeURIComponent(this.symbol)}&timeframe=${this.timeframe}&last_known=${encodeURIComponent(this.lastKnownTimestamp)}`;
                    console.log('üîó URL –ø—Ä–æ–≤–µ—Ä–∫–∏:', url);
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
                    return { has_updates: false, error: error.message };
                }
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            async loadIncrementalData() {
                try {
                    const url = `/api/pattern/incremental_update?symbol=${encodeURIComponent(this.symbol)}&timeframe=${this.timeframe}&last_known=${encodeURIComponent(this.lastKnownTimestamp)}`;
                    console.log('üîó URL –∑–∞–≥—Ä—É–∑–∫–∏:', url);
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
                    return { has_updates: false, error: error.message };
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            async updateChartWithNewData(newCandles) {
                if (!this.chart || !this.chart.allCandles) {
                    console.error('‚ùå –ì—Ä–∞—Ñ–∏–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    return;
                }
                
                console.log(`üîÑ –î–æ–±–∞–≤–ª—è–µ–º ${newCandles.length} –Ω–æ–≤—ã—Ö —Å–≤–µ—á–µ–π`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–≤–µ—á–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–∞–Ω–Ω—ã–º
                let addedCount = 0;
                newCandles.forEach(newCandle => {
                    const exists = this.chart.allCandles.some(candle => 
                        candle.open_time === newCandle.open_time
                    );
                    
                    if (!exists) {
                        this.chart.allCandles.push(newCandle);
                        addedCount++;
                        console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–≤–µ—á–∞: ${newCandle.open_time}`);
                    }
                });
                
                if (addedCount === 0) {
                    console.log('‚ÑπÔ∏è –í—Å–µ —Å–≤–µ—á–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç');
                    return;
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
                this.chart.allCandles.sort((a, b) => new Date(a.open_time) - new Date(b.open_time));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                const k = this.chart.allCandles.map(c => ({
                    time: Math.floor(new Date(c.open_time).getTime() / 1000),
                    open: parseFloat(c.open_price),
                    high: parseFloat(c.high),
                    low: parseFloat(c.low),
                    close: parseFloat(c.close_price),
                }));
                
                this.chart.candleSeries.setData(k);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–º –µ—Å–ª–∏ –æ–Ω –≤–∏–¥–∏–º
                if (this.chart.volumeVisible) {
                    const v = this.chart.allCandles.map(c => ({
                        time: Math.floor(new Date(c.open_time).getTime() / 1000),
                        value: parseFloat(c.volume),
                        color: (parseFloat(c.close_price) >= parseFloat(c.open_price)) ? 'rgba(34,197,94,0.25)' : 'rgba(239,68,68,0.25)'
                    }));
                    this.chart.volumeSeries.setData(v);
                }
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
                this.chart.redrawOverlay();
                
                console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
            }

            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showUpdateNotification(newCandlesCount) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π toast
                if (this.chart.toast) {
                    this.chart.toast(`üìà –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${newCandlesCount} –Ω–æ–≤—ã—Ö —Å–≤–µ—á–µ–π`);
                }
            }

            // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            stop() {
                if (this.updateTimer) {
                    console.log('‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π');
                    clearInterval(this.updateTimer);
                    this.updateTimer = null;
                }
            }


            checkDataFreshness() {
                if (!this.lastKnownTimestamp) return 'unknown';
                
                const lastKnown = new Date(this.lastKnownTimestamp);
                const now = new Date();
                const diffMs = now - lastKnown;
                const diffHours = diffMs / (1000 * 60 * 60);
                const diffDays = diffHours / 24;
                
                console.log(`‚è∞ –°–≤–µ–∂–µ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: ${diffHours.toFixed(1)} —á–∞—Å–æ–≤ (${diffDays.toFixed(1)} –¥–Ω–µ–π) —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`);
                
                // –ë–û–õ–ï–ï –ê–ì–†–ï–°–°–ò–í–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò - –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 1 –¥–Ω—è, —Å—á–∏—Ç–∞–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏
                let freshnessThreshold;
                switch(this.timeframe) {
                    case '1h': freshnessThreshold = 1; break;    // 1 —á–∞—Å –¥–ª—è —á–∞—Å–æ–≤—ã—Ö
                    case '4h': freshnessThreshold = 4; break;    // 4 —á–∞—Å–∞ –¥–ª—è 4-—á–∞—Å–æ–≤—ã—Ö
                    case '1d': freshnessThreshold = 24; break;   // 24 —á–∞—Å–∞ –¥–ª—è –¥–Ω–µ–≤–Ω—ã—Ö
                    case '1w': freshnessThreshold = 24; break;   // 24 —á–∞—Å–∞ –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω—ã—Ö (–æ–±–Ω–æ–≤–ª—è–µ–º —Ö–æ—Ç—è –±—ã —Ä–∞–∑ –≤ –¥–µ–Ω—å)
                    default: freshnessThreshold = 24;
                }
                
                if (diffHours > freshnessThreshold) {
                    console.warn(`‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ ${freshnessThreshold} —á–∞—Å–æ–≤! –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.`);
                    return 'stale';
                } else if (diffHours > freshnessThreshold / 2) {
                    console.log('‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞—Ä–µ–ª–∏');
                    return 'outdated';
                } else {
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã');
                    return 'fresh';
                }
            }         
            
            async forceRefreshServerData() {
                console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...');
                
                try {
                    const response = await fetch('/api/pattern/force_data_refresh', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            symbol: this.symbol,
                            timeframe: this.timeframe
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('‚úÖ –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', result);
                        return result;
                    } else {
                        throw new Error(result.message);
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
                    throw error;
                }
            }
    }	
        
        class PatternChart {
            constructor() {
                this.chart = null;
                this.candleSeries = null;
                this.volumeSeries = null;
                this.volumeVisible = true;
                this.allCandles = [];
				this.selectedIndices = new Set();
				this.selectedMarkers = new Map();
				this.patternMarkers = new Map();
				
				// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
				const savedTimeframe = localStorage.getItem('savedTimeframe');
				this.currentTimeframe = savedTimeframe || '1d';
				
				// –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
				if (savedTimeframe) {
					localStorage.removeItem('savedTimeframe');
				}

                const savedSymbol = localStorage.getItem('savedSymbol');
                this.currentSymbol = savedSymbol || 'BTC#USDT';
                
                // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                if (savedSymbol) {
                    localStorage.removeItem('savedSymbol');
                }
				this.chartUpdater = new SmartChartUpdater(this);
                this.freshnessChecked = false;
                this.initChart();
                this.loadData();
				this.bindUI();
				this.toastEl = null;
				this.overlay = null;
				this.matchedHighlightPoints = [];
				this.selectedHighlightPoints = [];
				this.currentMatchIndex = -1;
				this.matchedRanges = [];
				this.isAnalysisMode = false; // –†–µ–∂–∏–º: false = –≤—ã–±–æ—Ä —Å–≤–µ—á–µ–π, true = –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            }

            async switchSymbol(newSymbol) {
                if (newSymbol === this.currentSymbol) return;
                
                console.log(`üîÑ –°–º–µ–Ω–∞ —Å–∏–º–≤–æ–ª–∞: ${this.currentSymbol} -> ${newSymbol}`);
                this.chartUpdater.stop();
                this.freshnessChecked = false;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Å–∏–º–≤–æ–ª
                this.currentSymbol = newSymbol;
            
                
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                this.clearSelection();
                this.patternMarkers.clear();
                this.matchedHighlightPoints = [];
                this.matchedRanges = [];
                this.currentMatchIndex = -1;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                const loader = this.ensureLoader();
                loader.style.display = 'flex';
                
                try {
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –Ω–æ–≤—ã–º —Å–∏–º–≤–æ–ª–æ–º
                    await this.loadData();
                    
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    safeSetTextContent('matches-found', '0');
                    safeSetTextContent('pattern-length', '0');
                    safeSetTextContent('accuracy', '0%');
                    safeSetStyle('pattern-info-card', 'display', 'none');
                    safeSetInnerHTML('matches', '');
                    
                    this.toast(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${newSymbol.replace('#', '/')}`);
                } catch (e) {
                    this.toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
                } finally {
                    loader.style.display = 'none';
                }

                if (this.allCandles.length > 0) {
                    this.chartUpdater.initialize(this.currentSymbol, this.currentTimeframe);
                }
            }


            initChart() {
				const el = document.getElementById('chart');
				this.chart = LightweightCharts.createChart(el, {
					width: el.clientWidth,
					height: el.clientHeight,
					layout: { backgroundColor: '#0a0f14', textColor: '#d6dee6', fontFamily: 'Inter' },
					grid: { vertLines: { color: 'rgba(32,42,54,0.85)' }, horzLines: { color: 'rgba(32,42,54,0.85)' } },
					crosshair: { mode: LightweightCharts.CrosshairMode.Magnet, vertLine: { color: '#3a4654' }, horzLine: { color: '#3a4654' } },
					rightPriceScale: { borderColor: '#243142' },
					timeScale: { 
						borderColor: '#243142', 
						rightOffset: 6, 
						barSpacing: 60, // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Å–∏–ª—å–Ω–æ–≥–æ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
						minBarSpacing: 15, // –°—Ä–µ–¥–Ω—è—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞
						fixLeftEdge: false,
						fixRightEdge: false,
						lockVisibleTimeRangeOnResize: true,
						shiftVisibleRangeOnNewBar: true,
						timeVisible: true,
						secondsVisible: false
					},
					handleScroll: { 
						mouseWheel: true, 
						pressedMouseMove: true,
						horzTouchDrag: true,
						vertTouchDrag: true
					},
					handleScale: { 
						axisPressedMouseMove: { time: true, price: true },
						axisDoubleClickReset: { time: true, price: true },
						mouseWheel: true,
						pinch: true
					},
					kineticScroll: {
						touch: true,
						mouse: false
					}
                });
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª—ë—Å–∏–∫–æ–º –º—ã—à–∏
                const timeScale = this.chart.timeScale();
                const originalScrollPosition = timeScale.scrollPosition.bind(timeScale);
                const originalScrollToPosition = timeScale.scrollToPosition.bind(timeScale);
                
                // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫–æ–ª—ë—Å–∏–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
                el.addEventListener('wheel', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∑–∞–∂–∞—Ç—ã–º Ctrl/Cmd
                        e.preventDefault();
                        const delta = e.deltaY;
                        const currentRange = timeScale.getVisibleLogicalRange();
                        if (currentRange) {
                            const center = (currentRange.from + currentRange.to) / 2;
                            // –í —Ä–µ–∂–∏–º–µ –∞–Ω–∞–ª–∏–∑–∞ - –≤—ã—Å–æ–∫–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤ —Ä–µ–∂–∏–º–µ –≤—ã–±–æ—Ä–∞ - —Å—Ä–µ–¥–Ω—è—è
                            const scaleFactor = this.isAnalysisMode 
                                ? (delta > 0 ? 1.15 : 0.85)  // –í—ã—Å–æ–∫–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                                : (delta > 0 ? 1.08 : 0.92); // –°—Ä–µ–¥–Ω—è—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                            const newRange = {
                                from: center - (center - currentRange.from) * scaleFactor,
                                to: center + (currentRange.to - center) * scaleFactor
                            };
                            timeScale.setVisibleLogicalRange(newRange);
                        }
                    }
                }, { passive: false });
                
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞—á-–∂–µ—Å—Ç–æ–≤ –¥–ª—è –±–æ–ª—å—à–µ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                let touchStartDistance = 0;
                let touchStartRange = null;
                
                el.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        touchStartDistance = Math.hypot(
                            touch2.clientX - touch1.clientX,
                            touch2.clientY - touch1.clientY
                        );
                        touchStartRange = timeScale.getVisibleLogicalRange();
                    }
                }, { passive: true });
                
                el.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 2 && touchStartRange) {
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        const currentDistance = Math.hypot(
                            touch2.clientX - touch1.clientX,
                            touch2.clientY - touch1.clientY
                        );
                        
                        if (touchStartDistance > 0) {
                            const scaleFactor = currentDistance / touchStartDistance;
                            const rangeSize = touchStartRange.to - touchStartRange.from;
                            const center = (touchStartRange.from + touchStartRange.to) / 2;
                            // –í —Ä–µ–∂–∏–º–µ –∞–Ω–∞–ª–∏–∑–∞ - –≤—ã—Å–æ–∫–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤ —Ä–µ–∂–∏–º–µ –≤—ã–±–æ—Ä–∞ - —Å—Ä–µ–¥–Ω—è—è
                            const sensitivity = this.isAnalysisMode ? 1.3 : 1.05;
                            const newRangeSize = rangeSize / (scaleFactor * sensitivity);
                            
                            const newRange = {
                                from: center - newRangeSize / 2,
                                to: center + newRangeSize / 2
                            };
                            
                            timeScale.setVisibleLogicalRange(newRange);
                        }
                    }
                }, { passive: true });
                
                el.addEventListener('touchend', () => {
                    touchStartDistance = 0;
                    touchStartRange = null;
                }, { passive: true });

                this.candleSeries = this.chart.addCandlestickSeries({
					upColor: '#21d07a',
					downColor: '#f04444',
					borderUpColor: '#1ac46f',
					borderDownColor: '#e73c3c',
					wickUpColor: '#24e084',
					wickDownColor: '#ff5050',
                    priceLineVisible: false,
                });
                this.volumeSeries = this.chart.addHistogramSeries({
                    priceScaleId: '',
					scaleMargins: { top: 0.85, bottom: 0 },
					priceFormat: { type: 'volume' },
				});

				this.chart.subscribeClick(this.onClick.bind(this));
				window.addEventListener('resize', () => { this.chart.applyOptions({ width: el.clientWidth }); this.resizeOverlay(); this.redrawOverlay(); });
				this.ensureOverlay();
				
				// –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
				this.chart.timeScale().subscribeVisibleTimeRangeChange(() => {
					setTimeout(() => this.redrawOverlay(), 10);
				});
				
				// –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
				this.animationFrame = null;
				this.startAnimation();
            }

            async loadData() {
                try {
                    // –£–∑–Ω–∞—ë–º —Ä–µ–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–∞—Ç–∞—Å–µ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—Å—è
                    let dsStart = new Date('2018-01-01T00:00:00Z');
                    let dsEnd = new Date();
                    try {
                        const b = await fetch(`/api/pattern/bounds?timeframe=${this.currentTimeframe}&symbol=${this.currentSymbol}`);
                        if (b.ok) {
                            const j = await b.json();
                            if (j.success) { 
                                dsStart = new Date(j.start + 'T00:00:00Z'); 
                                dsEnd = new Date(j.end + 'T23:59:59Z'); 
                            }
                        }
                    } catch(_) {}
                    
                    this.datasetStart = dsStart; 
                    this.datasetEnd = dsEnd;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º 1 –¥–µ–Ω—å –∫ –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç–µ
                    const nextDay = new Date(dsEnd);
                    nextDay.setDate(dsEnd.getDate() + 1);
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å–≤–µ—á–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                    const api = await fetch(
                        `/api/pattern/ohlcv?source=binance` +
                        `&from=${dsStart.toISOString().slice(0,10)}` +
                        `&to=${nextDay.toISOString().slice(0,10)}` +
                        `&timeframe=${this.currentTimeframe}` +
                        `&symbol=${this.currentSymbol}`  // ‚Üê –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
                    );
                    
                    if (!api.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å OHLCV');
                    const aj = await api.json();
                    if (!aj.success) throw new Error(aj.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ OHLCV');
                    this.allCandles = aj.candles || [];

                    if (!Array.isArray(this.allCandles) || this.allCandles.length === 0) {
                        throw new Error('–ü—É—Å—Ç–æ–π –Ω–∞–±–æ—Ä —Å–≤–µ—á–µ–π');
                    }
                    
                    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤
                    this.allCandles = this.allCandles.map(c => ({
                        open_time: c.open_time,
                        close_time: c.close_time,
                        open_price: Number(c.open_price),
                        close_price: Number(c.close_price),
                        high: Number(c.high),
                        low: Number(c.low),
                        volume: Number(c.volume),
                    }));
                    
                    const k = this.allCandles.map(c => ({
                        time: Math.floor(new Date(c.open_time).getTime() / 1000),
                        open: c.open_price, high: c.high, low: c.low, close: c.close_price,
                    }));
                    this.candleSeries.setData(k);

                    const v = this.allCandles.map(c => ({
                        time: Math.floor(new Date(c.open_time).getTime() / 1000),
                        value: c.volume,
                        color: (c.close_price >= c.open_price) ? 'rgba(34,197,94,0.25)' : 'rgba(239,68,68,0.25)'
                    }));
                    this.volumeSeries.setData(v);
                    
                    this.chart.timeScale().fitContent();
                    setTimeout(() => { 
                        try { 
                            this.chart.timeScale().fitContent(); 
                        } catch(_){} 
                    }, 0);
                    
                    // Zoom-in to make candles visually larger (60% closer for easier interaction)
                    setTimeout(() => {
                        const range = this.chart.timeScale().getVisibleRange();
                        if (range) {
                            const pad = Math.floor((range.to - range.from) * 0.60);
                            this.chart.timeScale().setVisibleRange({ from: range.from + pad, to: range.to - pad });
                        }
                        this.redrawOverlay();
                    }, 100);

                    if (!this.freshnessChecked && this.allCandles.length > 0) {
                        this.freshnessChecked = true;
                        await this.checkDataFreshness();
                    }

                    if (this.allCandles.length > 0) {
                        console.log('üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                        this.chartUpdater.initialize(this.currentSymbol, this.currentTimeframe);
                    }
                    
                } catch (e) {
                    console.error(e);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ.');
                }
            }

            async checkDataFreshness() {
                console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö...');
                
                const loader = this.ensureLoader();
                loader.style.display = 'flex';
                
                try {
                    const response = await fetch(
                        `/api/pattern/check_freshness?symbol=${encodeURIComponent(this.currentSymbol)}&timeframe=${this.currentTimeframe}&auto_update=true`
                    );
                    
                    const result = await response.json();
                    console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–µ–∂–µ—Å—Ç–∏:', result);
                    
                    if (result.success) {
                        if (result.needs_update && result.auto_updated) {
                            console.log('üîÑ –î–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                            this.toast(`–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã! +${result.fresh_data_count} –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π`);
                            
                            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
                            await this.reloadChartData();
                            
                        } else if (result.needs_update && !result.auto_updated) {
                            console.log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏, –Ω–æ –Ω–µ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
                            this.toast('–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏, –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"');
                        } else {
                            console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã (–≤–æ–∑—Ä–∞—Å—Ç: ${result.data_age_hours} —á–∞—Å–æ–≤)`);
                        }
                    } else {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–µ–∂–µ—Å—Ç–∏:', result.message);
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–≤–µ–∂–µ—Å—Ç–∏:', error);
                } finally {
                    loader.style.display = 'none';
                }
            }

            async reloadChartData() {
                console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞...');
                
                const loader = this.ensureLoader();
                loader.style.display = 'flex';
                
                try {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
                    const hadSelection = this.selectedIndices.size > 0;
                    const selectedIndices = [...this.selectedIndices];
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    await this.loadData();
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
                    if (hadSelection) {
                        this.selectedIndices.clear();
                        selectedIndices.forEach(idx => {
                            if (idx < this.allCandles.length) {
                                this.selectedIndices.add(idx);
                            }
                        });
                        this.updateSelected();
                        console.log(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ: ${this.selectedIndices.size} —Å–≤–µ—á–µ–π`);
                    }
                    
                    this.toast('–ì—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏');
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                    this.toast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞');
                } finally {
                    loader.style.display = 'none';
                }
            }

			generateData(startDate = new Date('2018-01-01T00:00:00Z'), endDate = new Date()) {
				const out = [];
				let d = new Date(startDate);
				let price = 300;
				while (d <= endDate) {
					const vol = 10000 + Math.random()*50000;
					const volat = 0.025;
                    const open = price;
					const delta = (Math.random()-0.5)*volat;
					const close = open * (1 + delta);
					const high = Math.max(open, close) * (1 + Math.random()*volat*0.6);
					const low = Math.min(open, close) * (1 - Math.random()*volat*0.6);
					out.push({
						open_time: d.toISOString(),
						close_time: new Date(d.getTime()+24*60*60*1000-1).toISOString(),
						open_price: open.toFixed(2), close_price: close.toFixed(2),
						high: high.toFixed(2), low: low.toFixed(2), volume: vol.toFixed(2)
					});
					price = close;
					d.setUTCDate(d.getUTCDate()+1);
				}
				return out;
			}

			bindUI() {
				// Old toolbar buttons (if they exist)
				const analyzeBtn = document.getElementById('analyze-btn'); if (analyzeBtn) analyzeBtn.addEventListener('click', () => this.analyze());
				const clearBtn = document.getElementById('clear-btn'); if (clearBtn) clearBtn.addEventListener('click', () => this.showClearConfirmationModal());
				const resetBtn = document.getElementById('reset-view-btn'); if (resetBtn) resetBtn.addEventListener('click', () => this.resetView());
				const toggleVolumeBtn = document.getElementById('toggle-volume-btn'); if (toggleVolumeBtn) toggleVolumeBtn.addEventListener('click', () => this.toggleVolume());
				const toSelectedBtn = document.getElementById('to-selected-btn'); if (toSelectedBtn) toSelectedBtn.addEventListener('click', () => this.zoomToSelected());
				const prevMatchBtn = document.getElementById('prev-match-btn'); if (prevMatchBtn) prevMatchBtn.addEventListener('click', () => this.gotoMatch(-1));
				const nextMatchBtn = document.getElementById('next-match-btn'); if (nextMatchBtn) nextMatchBtn.addEventListener('click', () => this.gotoMatch(1));
				const symbolSelect = document.getElementById('symbol-select');
                    if (symbolSelect) {
                        symbolSelect.value = this.currentSymbol;
                        symbolSelect.addEventListener('change', (e) => {
                            this.switchSymbol(e.target.value);
                        });
                    }
                
                const testUpdateBtn = document.getElementById('test-update-btn');
                if (testUpdateBtn) {
                    testUpdateBtn.addEventListener('click', () => {
                        console.log('üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                        if (this.chartUpdater) {
                            this.chartUpdater.smartUpdate();
                        } else {
                            console.error('‚ùå chartUpdater –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                        }
                    });
                }

                document.querySelectorAll('[data-tf]').forEach(b => b.addEventListener('click', (e) => {
					document.querySelectorAll('[data-tf]').forEach(x => x.classList.remove('active'));
                        e.target.classList.add('active');
					const newTF = e.target.getAttribute('data-tf');
					if (newTF !== this.currentTimeframe) {
						this.switchTimeframe(newTF);
					}
				}));

				// Mobile navigation buttons (reduced)
				const navVolume = document.getElementById('nav-volume'); if (navVolume) navVolume.addEventListener('click', () => this.toggleVolume());
				const navAnalysis = document.getElementById('nav-analysis'); if (navAnalysis) navAnalysis.addEventListener('click', () => this.analyze());
				const navClear = document.getElementById('nav-clear'); if (navClear) navClear.addEventListener('click', () => this.showClearConfirmationModal());
				
				// Chart controls overlay buttons
				const navPrev = document.getElementById('nav-prev'); if (navPrev) navPrev.addEventListener('click', () => this.gotoMatch(-1));
				const navNext = document.getElementById('nav-next'); if (navNext) navNext.addEventListener('click', () => this.gotoMatch(1));
				const navToSelected = document.getElementById('nav-to-selected'); if (navToSelected) navToSelected.addEventListener('click', () => this.zoomToSelected());
				const navAnalysisOverlay = document.getElementById('nav-analysis-overlay'); if (navAnalysisOverlay) navAnalysisOverlay.addEventListener('click', () => this.toggleAnalysisPanel());
				const navPatterns = document.getElementById('nav-patterns'); if (navPatterns) navPatterns.addEventListener('click', () => this.showPatternsModal());
				const toggleControlsBtn = document.getElementById('toggle-controls-btn'); if (toggleControlsBtn) toggleControlsBtn.addEventListener('click', () => this.toggleChartControls());
				
				// –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
				const loadGeneralAnalysisBtn = document.getElementById('load-general-analysis');
				if (loadGeneralAnalysisBtn) {
					loadGeneralAnalysisBtn.addEventListener('click', () => this.loadGeneralAnalysis());
				}

				// Clear confirmation modal buttons
				document.getElementById('confirm-clear-btn').addEventListener('click', () => {
					// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
					localStorage.setItem('savedTimeframe', this.currentTimeframe);
					window.location.reload();
				});
				document.getElementById('cancel-clear-btn').addEventListener('click', () => this.hideClearConfirmationModal());
				document.getElementById('close-clear-modal').addEventListener('click', () => this.hideClearConfirmationModal());

				// Modal close button
				document.querySelector('.close-modal').addEventListener('click', () => this.hidePatternsModal());
				
				// Close modal when clicking outside
				document.getElementById('patterns-modal').addEventListener('click', (e) => {
					if (e.target.id === 'patterns-modal') {
						this.hidePatternsModal();
					}
				});
				document.getElementById('clear-confirmation-modal').addEventListener('click', (e) => {
					if (e.target.id === 'clear-confirmation-modal') {
						this.hideClearConfirmationModal();
					}
				});
				
				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –≤ UI
				this.setActiveTimeframe();
            }

			onClick(param) {
                if (!param || !param.time) return;
				const ts = param.time;
				const idx = this.allCandles.findIndex(c => Math.floor(new Date(c.open_time).getTime()/1000) === ts);
				if (idx === -1) return;
				// –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä —Å–≤–µ—á–µ–π –≤–Ω–µ –≥—Ä–∞–Ω–∏—Ü –¥–∞—Ç–∞—Å–µ—Ç–∞
				const t = new Date(this.allCandles[idx].open_time);
				if (this.datasetStart && this.datasetEnd && (t < this.datasetStart || t > this.datasetEnd)) {
					this.toast('–°–≤–µ—á–∞ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞');
                        return;
                    }
				if (this.selectedIndices.has(idx)) this.selectedIndices.delete(idx);
				else {
					if (this.selectedIndices.size >= 6) { alert('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–∞–∫—Å–∏–º—É–º 6 —Å–≤–µ—á–µ–π'); return; }
					this.selectedIndices.add(idx);
				}
				this.updateSelected();
			}

			updateSelected() {
				safeSetTextContent('selected-count', this.selectedIndices.size);

                const indicator = document.getElementById('selected-indicator');
                if (indicator) {
                    if (this.selectedIndices.size > 0) {
                        safeSetTextContent('selected-count-indicator', this.selectedIndices.size);
                        indicator.style.display = 'block';
                    } else {
                        indicator.style.display = 'none';
                    }
                }

				const analyzeBtn = document.getElementById('analyze-btn'); 
				if (analyzeBtn) analyzeBtn.disabled = this.selectedIndices.size === 0;
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
				const generalAnalysisBtn = document.getElementById('load-general-analysis');
				if (generalAnalysisBtn) generalAnalysisBtn.disabled = this.selectedIndices.size === 0;
				this.selectedMarkers.clear();
				this.selectedHighlightPoints = [];
				[...this.selectedIndices].forEach((i, index) => {
					const t = Math.floor(new Date(this.allCandles[i].open_time).getTime()/1000);
					// –ë–æ–ª–µ–µ —è—Ä–∫–∏–µ –∏ –∑–∞–º–µ—Ç–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
					this.selectedMarkers.set(i, { 
						time: t, 
						position: 'aboveBar', 
						color: '#ff6b35', 
						shape: 'circle', 
						text: `${index + 1}`, 
						size: 1.5,
						textColor: '#ffffff',
						backgroundColor: '#ff6b35'
					});
					this.selectedHighlightPoints.push({ time: t, color: '#ff6b35', index: index + 1 });
				});
				this.applyMarkers();
				this.redrawOverlay();
				
				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
			}
			
			
			// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
			forceRestoreSelection() {
				if (this.selectedIndices && this.selectedIndices.size > 0) {
					this.updateSelected();
					setTimeout(() => {
						this.redrawOverlay();
						this.applyMarkers();
					}, 50);
				}
			}

			applyMarkers() {
				const sel = Array.from(this.selectedMarkers.values());
				const pats = Array.from(this.patternMarkers.values()).flat();
				this.candleSeries.setMarkers([...sel, ...pats]);
            }

            clearSelection() {
				this.selectedIndices.clear();
				this.selectedMarkers.clear();
				this.selectedHighlightPoints = [];
				this.applyMarkers();
				safeSetTextContent('selected-count', '0');
				const analyzeBtn = document.getElementById('analyze-btn');
				if (analyzeBtn) analyzeBtn.disabled = true;
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
				const generalAnalysisBtn = document.getElementById('load-general-analysis');
				if (generalAnalysisBtn) generalAnalysisBtn.disabled = true;
				this.redrawOverlay();
				
				// –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
			}

			resetView() {
                this.chart.timeScale().fitContent();
				// Apply zoom after reset
				setTimeout(() => {
					const range = this.chart.timeScale().getVisibleRange();
					if (range) {
						const pad = Math.floor((range.to - range.from) * 0.60);
						this.chart.timeScale().setVisibleRange({ from: range.from + pad, to: range.to - pad });
					}
				}, 50);
				this.patternMarkers.clear();
				this.applyMarkers();
				
				// –í–ê–ñ–ù–û: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
				if (this.selectedIndices && this.selectedIndices.size > 0) {
					this.updateSelected();
				}
				
				this.redrawOverlay();
            }

            toggleVolume() {
                this.volumeVisible = !this.volumeVisible;
                if (this.volumeVisible) {
					const v = this.allCandles.map(c => ({
						time: Math.floor(new Date(c.open_time).getTime() / 1000),
						value: +c.volume,
						color: (+c.close_price >= +c.open_price) ? 'rgba(34,197,94,0.25)' : 'rgba(239,68,68,0.25)'
					}));
					this.volumeSeries.setData(v);
                } else {
                    this.volumeSeries.setData([]);
				}
				
				// –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫
				const buttonText = this.volumeVisible ? '–°–∫—Ä—ã—Ç—å –æ–±—ä–µ–º' : '–ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ä–µ–º';
				const iconClass = this.volumeVisible ? 'fas fa-chart-bar' : 'fas fa-chart-bar';
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ toolbar
				const toggleVolumeBtn = document.getElementById('toggle-volume-btn');
				if (toggleVolumeBtn) {
					toggleVolumeBtn.title = buttonText;
					toggleVolumeBtn.innerHTML = `<i class="${iconClass}"></i> ${this.volumeVisible ? '–û–±—ä–µ–º' : '–û–±—ä–µ–º'}`;
				}
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
				const navVolume = document.getElementById('nav-volume');
				if (navVolume) {
					navVolume.innerHTML = `<i class="${iconClass}"></i><span>${this.volumeVisible ? '–û–±—ä–µ–º' : '–û–±—ä–µ–º'}</span>`;
				}
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ chart controls overlay
				const navAnalysisOverlay = document.getElementById('nav-analysis-overlay');
				if (navAnalysisOverlay) {
					navAnalysisOverlay.innerHTML = `<i class="fas fa-chart-line"></i><span>–ê–Ω–∞–ª–∏–∑</span>`;
				}
				
				this.toast(this.volumeVisible ? '–û–±—ä–µ–º –ø–æ–∫–∞–∑–∞–Ω' : '–û–±—ä–µ–º —Å–∫—Ä—ã—Ç');
			}

			toggleAnalysisPanel() {
				// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
				if (window.innerWidth <= 768) {
					// –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
					this.showAnalysisModal();
				} else {
					// –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
					const sidePanel = document.getElementById('side-panel');
					
					if (sidePanel) {
						const isVisible = sidePanel.classList.contains('active');
						
						if (isVisible) {
							// –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
							sidePanel.classList.remove('active');
							this.toast('–ê–Ω–∞–ª–∏–∑ —Å–∫—Ä—ã—Ç');
						} else {
							// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
							sidePanel.classList.add('active');
							this.toast('–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞–Ω');
						}
					}
				}
			}

			showAnalysisModal() {
				// –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
				let modal = document.getElementById('analysis-modal');
				if (!modal) {
					modal = document.createElement('div');
					modal.id = 'analysis-modal';
					modal.className = 'modal';
					modal.innerHTML = `
						<div class="modal-content">
							<div class="modal-header">
								<div class="modal-title">–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑</div>
								<button class="close-modal">&times;</button>
							</div>
							<div class="modal-body" id="analysis-modal-body">
								<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ -->
							</div>
						</div>
					`;
					document.body.appendChild(modal);
					
					// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
					modal.querySelector('.close-modal').addEventListener('click', () => this.hideAnalysisModal());
					modal.addEventListener('click', (e) => {
						if (e.target.id === 'analysis-modal') {
							this.hideAnalysisModal();
						}
					});
				}
				
				// –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
				const sidePanel = document.getElementById('side-panel');
				const modalBody = document.getElementById('analysis-modal-body');
				if (sidePanel && modalBody) {
					modalBody.innerHTML = sidePanel.innerHTML;
				}
				
				modal.style.display = 'block';
			}

			hideAnalysisModal() {
				const modal = document.getElementById('analysis-modal');
				if (modal) {
					modal.style.display = 'none';
				}
			}

            async analyze() {
                if (this.selectedIndices.size === 0) return;
                const order = [...this.selectedIndices].sort((a,b) => a-b);
                const candles = order.map(i => this.allCandles[i]);
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
                const payload = { 
                    num_candles: this.selectedIndices.size,
                    candles, 
                    timeframe: this.currentTimeframe,
                    symbol: this.currentSymbol,  // ‚Üê –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
                    no_cache: true
                };
                
                // UI state
                const btn = document.getElementById('analyze-btn');
                const loader = this.ensureLoader();
                if (btn) btn.disabled = true; 
                loader.style.display = 'flex';
                
                try {
                    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞...');
                    // –°–æ–∑–¥–∞–µ–º AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 –º–∏–Ω—É—Ç—ã —Ç–∞–π–º–∞—É—Ç
                    
                    const res = await fetch('/api/pattern/analyze', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', res.status);
                    
                    if (!res.ok) {
                        if (res.status === 408) {
                            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –º–µ–Ω—å—à–∏–π –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.');
                        } else if (res.status === 500) {
                            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                        } else {
                            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`);
                        }
                    }
                    
                    const data = await res.json();
                    console.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞:', data);
                    
                    if (!data.success) {
                        throw new Error(data.message || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞');
                    }
                    
                    this.renderResults(data);
                    this.displaySimpleAnalysis(data);
                    this.drawPatternMarkers(data.matched_patterns);
                    if (!data.matched_patterns || data.matched_patterns.length === 0) this.toast('–°–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    this.toast('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω');
                    
                    // Show chart controls after analysis
                    const chartControls = document.getElementById('chart-controls');
                    if (chartControls) chartControls.classList.add('visible');
                    this.switchToAnalysisMode();

                } catch (e) {
                    if (e.name === 'AbortError') {
                        this.toast('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –º–µ–Ω—å—à–∏–π –ø–µ—Ä–∏–æ–¥.');
                    } else {
                        this.toast('–û—à–∏–±–∫–∞: ' + e.message);
                    }
                    console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:', e);
                } finally {
                    if (btn) btn.disabled = this.selectedIndices.size === 0;
                    loader.style.display = 'none';
                }

            }

			renderResults(result) {
                safeSetTextContent('matches-found', result.statistics.matches_found);
                safeSetTextContent('pattern-length', result.pattern_info.pattern_len);
                
				const percents = result.statistics.distribution_percents || {};
				const avg = Object.keys(percents).length ? (Object.values(percents).reduce((a,b)=>a+b,0) / Object.keys(percents).length) : 0;
				safeSetTextContent('accuracy', (avg||0).toFixed(2) + '%');

				const patternInfoHTML = `
					<div class="stat"><span>–ù–∞—á–∞–ª–æ</span><span class="val">${result.pattern_info.pattern_start}</span></div>
					<div class="stat"><span>–ö–æ–Ω–µ—Ü</span><span class="val">${result.pattern_info.pattern_end}</span></div>
					<div class="stat"><span>–°–≤–µ—á–µ–π</span><span class="val">${result.pattern_info.pattern_len}</span></div>
				`;
				safeSetInnerHTML('pattern-info', patternInfoHTML);
				safeSetStyle('pattern-info-card', 'display', '');

				safeSetInnerHTML('matches', '');
				this.matchedRanges = [];
				(result.matched_patterns || []).forEach((pat, i) => {
					const first = pat[0];
					const last = pat[pat.length-1];
                    const change = result.price_changes ? result.price_changes[i] : 0;					
					this.matchedRanges.push([ Math.floor(new Date(first.date).getTime()/1000), Math.floor(new Date(last.date).getTime()/1000) ]);
					const el = document.createElement('div');
					el.className = 'match';
					el.setAttribute('data-pattern-index', i);
					el.innerHTML = `
						<div class="hdr">
							<div class="range">
								<span style="color: var(--accent); font-weight: 600;">–ü–∞—Ç—Ç–µ—Ä–Ω ${i + 1}</span>
								<br>
								<small style="color: var(--muted);">${new Date(first.date).toLocaleDateString()} ‚Äî ${new Date(last.date).toLocaleDateString()}</small>
							</div>
							<div class="badge ${change>=0?'up':'down'}">${change>=0?'+':''}${change.toFixed(2)}%</div>
                    </div>
					`;
					el.addEventListener('click', () => {
						// –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
						document.querySelectorAll('.match').forEach(m => m.classList.remove('active'));
						// –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ —Ç–µ–∫—É—â–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
						el.classList.add('active');
						
						this.currentMatchIndex = i;
						this.updateMatchIndexLabel();
						const [from, to] = this.matchedRanges[i];
						this.zoomTo(from, to);
					});
					matches.appendChild(el);
				});
				this.currentMatchIndex = this.matchedRanges.length ? 0 : -1;
				this.updateMatchIndexLabel();
			}

			drawPatternMarkers(matched) {
				this.patternMarkers.clear();
				// –ë–æ–ª–µ–µ —è—Ä–∫–∏–µ –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
				const colors = ['#00d4aa', '#ff4757', '#3742fa', '#ffa502', '#2ed573', '#ff3838'];
				this.matchedHighlightPoints = [];
				(matched || []).forEach((pat, pIdx) => {
					const col = colors[pIdx % colors.length];
					const arr = [];
					for (let i=0;i<pat.length;i++) {
						const t = Math.floor(new Date(pat[i].date).getTime()/1000);
						// –ë–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
						arr.push({ 
							time: t, 
							position: 'belowBar', 
							color: col, 
							shape: 'square', 
							text: `${pIdx+1}`, 
							size: 1.8,
							textColor: '#ffffff',
							backgroundColor: col
						});
						this.matchedHighlightPoints.push({ time: t, color: col, patternIndex: pIdx + 1 });
					}
					this.patternMarkers.set(pIdx, arr);
				});
				this.applyMarkers();
				this.redrawOverlay();
				if (matched && matched.length && matched[0].length) {
					const f = matched[0][0];
					const l = matched[0][matched[0].length-1];
					this.zoomTo(Math.floor(new Date(f.date).getTime()/1000), Math.floor(new Date(l.date).getTime()/1000));
				}
			}

			zoomTo(from, to) {
				const pad = Math.max(3*24*60*60, Math.floor((to-from)*0.5));
				this.chart.timeScale().setVisibleRange({ from: from - pad, to: to + pad });
				
				// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–≤–µ—Ä–ª–µ–π –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
				setTimeout(() => {
					this.redrawOverlay();
				}, 50);
			}

			// ===== Overlay helpers for highlighting candles =====
			ensureOverlay() {
				if (this.overlay) return this.overlay;
				const host = document.getElementById('chart');
				const canvas = document.createElement('canvas');
				canvas.style.position = 'absolute';
				canvas.style.left = '0';
				canvas.style.top = '0';
				canvas.style.pointerEvents = 'none';
				canvas.width = host.clientWidth; canvas.height = host.clientHeight;
				host.appendChild(canvas);
				this.overlay = canvas;
				return canvas;
			}

			resizeOverlay() {
				const host = document.getElementById('chart');
				if (!this.overlay) return;
				this.overlay.width = host.clientWidth;
				this.overlay.height = host.clientHeight;
			}

			redrawOverlay() {
				this.ensureOverlay();
				if (!this.overlay) return;
				
				const ctx = this.overlay.getContext('2d');
				ctx.clearRect(0,0,this.overlay.width,this.overlay.height);
				
				const ts = this.chart.timeScale();
				const barW = ts.getBarSpacing ? ts.getBarSpacing() : 12;
				const h = this.overlay.height;
				
				// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—á–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
				if (!this.selectedHighlightPoints || this.selectedHighlightPoints.length === 0) {
					// –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π, –Ω–æ –µ—Å—Ç—å –∏–Ω–¥–µ–∫—Å—ã, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö
					if (this.selectedIndices && this.selectedIndices.size > 0) {
						this.updateSelected();
					}
				}
				
				// –†–∏—Å—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å–Ω–∞—á–∞–ª–∞ (–±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–µ)
				for (const p of (this.matchedHighlightPoints || [])) {
					const x = ts.timeToCoordinate(p.time);
					if (x === null || x === undefined) continue;
					
					// –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
					const gradient = ctx.createLinearGradient(x - barW*0.8, 0, x + barW*0.8, 0);
					gradient.addColorStop(0, this.hexToRgba(p.color, 0.0));
					gradient.addColorStop(0.5, this.hexToRgba(p.color, 0.25));
					gradient.addColorStop(1, this.hexToRgba(p.color, 0.0));
					
					ctx.fillStyle = gradient;
					ctx.fillRect(Math.round(x - barW*0.8), 0, Math.round(barW*1.6), h);
					
					// –ë–æ–ª–µ–µ —è—Ä–∫–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
					ctx.strokeStyle = this.hexToRgba(p.color, 0.8);
					ctx.lineWidth = 2;
					ctx.strokeRect(Math.round(x - barW*0.8)+1, 1, Math.round(barW*1.6)-2, h-2);
					
					// –î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç
					const time = Date.now() / 1000;
					const pulse = Math.sin(time * 3) * 0.1 + 0.9;
					ctx.fillStyle = this.hexToRgba(p.color, 0.15 * pulse);
					ctx.fillRect(Math.round(x - barW*0.6), 0, Math.round(barW*1.2), h);
				}
				
				// –†–∏—Å—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—á–∏ (–µ—â–µ –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–µ)
				for (const p of (this.selectedHighlightPoints || [])) {
					const x = ts.timeToCoordinate(p.time);
					if (x === null || x === undefined) continue;
					
					// –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
					const gradient = ctx.createLinearGradient(x - barW*0.7, 0, x + barW*0.7, 0);
					gradient.addColorStop(0, 'rgba(255,107,53,0.0)');
					gradient.addColorStop(0.5, 'rgba(255,107,53,0.4)');
					gradient.addColorStop(1, 'rgba(255,107,53,0.0)');
					
					ctx.fillStyle = gradient;
					ctx.fillRect(Math.round(x - barW*0.7), 0, Math.round(barW*1.4), h);
					
					// –û—á–µ–Ω—å —è—Ä–∫–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
					ctx.strokeStyle = 'rgba(255,107,53,1.0)';
					ctx.lineWidth = 3;
					ctx.strokeRect(Math.round(x - barW*0.7)+1.5, 1.5, Math.round(barW*1.4)-3, h-3);
					
					// –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
					const time = Date.now() / 1000;
					const pulse = Math.sin(time * 4) * 0.2 + 0.8;
					ctx.fillStyle = `rgba(255,107,53,${0.3 * pulse})`;
					ctx.fillRect(Math.round(x - barW*0.5), 0, Math.round(barW*1.0), h);
				}
			}

			hexToRgba(hex, a) {
				// supports #rrggbb format
				const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
				if (!m) return `rgba(255,255,255,${a})`;
				const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
				return `rgba(${r},${g},${b},${a})`;
			}

			startAnimation() {
				const animate = () => {
					this.redrawOverlay();
					this.animationFrame = requestAnimationFrame(animate);
				};
				animate();
			}

			stopAnimation() {
				if (this.animationFrame) {
					cancelAnimationFrame(this.animationFrame);
					this.animationFrame = null;
				}
			}

			ensureLoader() {
				let el = document.querySelector('.loading');
				if (!el) {
					el = document.createElement('div'); el.className = 'loading';
					const sp = document.createElement('div'); sp.className = 'spinner'; el.appendChild(sp);
					document.body.appendChild(el);
				}
				return el;
			}

			toast(msg) {
				if (!this.toastEl) { this.toastEl = document.createElement('div'); this.toastEl.className = 'toast'; document.body.appendChild(this.toastEl); }
				this.toastEl.textContent = msg; this.toastEl.style.display = 'block';
				clearTimeout(this.toastTimer); this.toastTimer = setTimeout(() => { this.toastEl.style.display = 'none'; }, 2200);
			}

			// ===== Navigation helpers =====
			zoomToSelected() {
				if (!this.selectedIndices.size) { this.toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–µ—á–∏'); return; }
				
				// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ü–ï–†–ï–î –∑—É–º–æ–º
				this.updateSelected();
				this.applyMarkers();
				this.redrawOverlay();
				
				const sorted = [...this.selectedIndices].sort((a,b)=>a-b);
				const first = Math.floor(new Date(this.allCandles[sorted[0]].open_time).getTime()/1000);
				const last = Math.floor(new Date(this.allCandles[sorted[sorted.length-1]].open_time).getTime()/1000);
				
				this.zoomTo(first, last);
				
				// –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
				setTimeout(() => {
					this.updateSelected();
					this.applyMarkers();
					this.redrawOverlay();
				}, 100);
				
				setTimeout(() => {
					this.updateSelected();
					this.applyMarkers();
					this.redrawOverlay();
				}, 300);
			}

			gotoMatch(step) {
				if (!this.matchedRanges.length) { this.toast('–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç'); return; }
				if (this.currentMatchIndex === -1) this.currentMatchIndex = 0;
				else this.currentMatchIndex = (this.currentMatchIndex + step + this.matchedRanges.length) % this.matchedRanges.length;
				this.updateMatchIndexLabel();
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ
				document.querySelectorAll('.match').forEach(m => m.classList.remove('active'));
				const activeMatch = document.querySelector(`[data-pattern-index="${this.currentMatchIndex}"]`);
				if (activeMatch) activeMatch.classList.add('active');
				
				const [from, to] = this.matchedRanges[this.currentMatchIndex];
				this.zoomTo(from, to);
				
				// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–≤–µ—Ä–ª–µ–π –ø–æ—Å–ª–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
				setTimeout(() => {
					this.redrawOverlay();
					this.applyMarkers();
				}, 100);
			}

			updateMatchIndexLabel() {
				const label = this.matchedRanges.length ? `${this.currentMatchIndex+1}/${this.matchedRanges.length}` : '0/0';
				safeSetTextContent('match-index', label);
			}

			showPatternsModal() {
				const modal = document.getElementById('patterns-modal');
				const patternsList = document.getElementById('modal-patterns-list');
				const patternStats = document.getElementById('modal-pattern-stats');
				
				// Clear previous content
				patternsList.innerHTML = '';
				patternStats.innerHTML = '';
				
				// Add pattern statistics
				if (this.matchedRanges && this.matchedRanges.length > 0) {
					const selectedCount = this.selectedIndices.size;
					const patternLength = selectedCount;
					const matchesFound = this.matchedRanges.length;
					
					patternStats.innerHTML = `
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
							<div class="stat">
								<span style="color: var(--muted); font-size: 12px;">–í—ã–±—Ä–∞–Ω–æ —Å–≤–µ—á–µ–π</span>
								<span class="val" style="color: var(--accent); font-weight: 600;">${selectedCount}</span>
							</div>
							<div class="stat">
								<span style="color: var(--muted); font-size: 12px;">–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</span>
								<span class="val" style="color: var(--green); font-weight: 600;">${matchesFound}</span>
							</div>
						</div>
						<div style="font-size: 11px; color: var(--muted); text-align: center;">
							–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –Ω–µ–º—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
						</div>
					`;
					
					// Add patterns
					this.matchedRanges.forEach((range, index) => {
						const startDate = new Date(range[0] * 1000).toLocaleDateString();
						const endDate = new Date(range[1] * 1000).toLocaleDateString();
						
						const patternEl = document.createElement('div');
						patternEl.className = 'match';
						patternEl.innerHTML = `
							<div class="hdr">
								<div class="range">–ü–∞—Ç—Ç–µ—Ä–Ω ${index + 1}</div>
								<div class="badge up">${index + 1}</div>
							</div>
							<div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
								${startDate} ‚Äî ${endDate}
							</div>
						`;
						patternEl.addEventListener('click', () => {
							this.currentMatchIndex = index;
							this.updateMatchIndexLabel();
							this.zoomTo(range[0], range[1]);
							this.hidePatternsModal();
						});
						patternsList.appendChild(patternEl);
					});
				} else {
					patternStats.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–µ—á–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑</div>';
					patternsList.innerHTML = '';
				}
				
				modal.style.display = 'block';
			}

			hidePatternsModal() {
				const modal = document.getElementById('patterns-modal');
				modal.style.display = 'none';
			}

			showClearConfirmationModal() {

                localStorage.setItem('savedSymbol', this.currentSymbol);
                
                const modal = document.getElementById('clear-confirmation-modal');
				
				// Update statistics in modal
				safeSetTextContent('selected-count-modal', this.selectedIndices.size);
				safeSetTextContent('patterns-count-modal', this.matchedRanges.length);
				
				if (modal) modal.style.display = 'block';
			}

			hideClearConfirmationModal() {
				const modal = document.getElementById('clear-confirmation-modal');
				modal.style.display = 'none';
			}

			toggleChartControls() {
				const chartControls = document.getElementById('chart-controls');
				const toggleBtn = document.getElementById('toggle-controls-btn');
				const toggleIcon = toggleBtn.querySelector('i');
				
				if (chartControls.classList.contains('collapsed')) {
					chartControls.classList.remove('collapsed');
					toggleIcon.className = 'fas fa-chevron-down';
				} else {
					chartControls.classList.add('collapsed');
					toggleIcon.className = 'fas fa-chevron-up';
				}
			}

			async switchTimeframe(newTimeframe) {
                console.log(`üîÑ –°–º–µ–Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞: ${this.currentTimeframe} -> ${newTimeframe}`);
				// –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
				this.chartUpdater.stop();
                this.freshnessChecked = false;
                this.currentTimeframe = newTimeframe;
                
				
				// –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—á–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
				const hadSelection = this.selectedIndices.size > 0;
				this.patternMarkers.clear();
				this.matchedHighlightPoints = [];
				this.matchedRanges = [];
				this.currentMatchIndex = -1;
				
				// –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—á–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Ö –Ω–µ –±—ã–ª–æ
				if (!hadSelection) {
					this.selectedIndices.clear();
					this.selectedMarkers.clear();
					this.selectedHighlightPoints = [];
				}
				
				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
				const loader = this.ensureLoader();
				loader.style.display = 'flex';
				
				try {
					// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –Ω–æ–≤—ã–º —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–º
					await this.loadData();
					
					// –û–±–Ω–æ–≤–ª—è–µ–º UI
					safeSetTextContent('matches-found', '0');
					safeSetTextContent('pattern-length', '0');
					safeSetTextContent('accuracy', '0%');
					safeSetStyle('pattern-info-card', 'display', 'none');
					safeSetInnerHTML('matches', '');
					
					// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏
					if (hadSelection) {
						this.updateSelected();
					}
					
					// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ –≤ header
					const timeframeMap = {
						'1h': '1—á',
						'4h': '4—á',
						'1d': '1–î',
						'1w': '1–ù'
					};
					const kpiTF = document.querySelector('.kpi strong');
					if (kpiTF) kpiTF.textContent = timeframeMap[newTimeframe] || newTimeframe;
					
					this.toast(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ ${timeframeMap[newTimeframe] || newTimeframe}`);
				} catch (e) {
					this.toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
				} finally {
					loader.style.display = 'none';
				}
                if (this.allCandles.length > 0) {
                    this.chartUpdater.initialize(this.currentSymbol, this.currentTimeframe);
                }
			}

			switchToAnalysisMode() {
				// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞ —Å –≤—ã—Å–æ–∫–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
				this.isAnalysisMode = true;
				// –£–º–µ–Ω—å—à–∞–µ–º minBarSpacing –¥–ª—è –±–æ–ª–µ–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
				this.chart.applyOptions({
					timeScale: {
						minBarSpacing: 2 // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∞–Ω–∞–ª–∏–∑–∞ (–º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –≤ 7.5 —Ä–∞–∑ —Å–∏–ª—å–Ω–µ–µ)
					}
				});
				
				// –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π –≤ —Ä–µ–∂–∏–º–µ –∞–Ω–∞–ª–∏–∑–∞
				this.updateSelected();
			}

			switchToSelectionMode() {
				// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Å–≤–µ—á–µ–π —Å–æ —Å—Ä–µ–¥–Ω–µ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
				this.isAnalysisMode = false;
				// –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º minBarSpacing –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
				this.chart.applyOptions({
					timeScale: {
						minBarSpacing: 15, // –°—Ä–µ–¥–Ω–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞
						barSpacing: 60 // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
					}
				});
				this.chart.timeScale().fitContent(); // –ü–æ–¥–≥–æ–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫
			}

			setActiveTimeframe() {
				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –≤ UI
				document.querySelectorAll('[data-tf]').forEach(btn => {
					btn.classList.remove('active');
					if (btn.getAttribute('data-tf') === this.currentTimeframe) {
						btn.classList.add('active');
					}
				});
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ –≤ header
				const timeframeMap = {
					'1h': '1—á',
					'4h': '4—á',
					'1d': '1–î',
					'1w': '1–ù'
				};
				const kpiTF = document.querySelector('.kpi strong');
				if (kpiTF) kpiTF.textContent = timeframeMap[this.currentTimeframe] || this.currentTimeframe;
			}

			// ===== –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ =====
            async loadGeneralAnalysis() {
                const btn = document.getElementById('load-general-analysis');
                if (btn) btn.disabled = true;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                this.showGeneralAnalysisLoading();
                
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                    if (!this.allCandles || this.allCandles.length === 0) {
                        throw new Error('–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—á–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    if (this.selectedIndices.size === 0) {
                        throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–µ—á–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                    }
                    
                    // –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—ã—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ - –æ–Ω —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω—É–∂–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    await this.analyze();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:', error);
                    this.toast('–û—à–∏–±–∫–∞: ' + error.message);
                    // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    this.hideGeneralAnalysisLoading();
                } finally {
                    if (btn) btn.disabled = false;
                }
            }

            displaySimpleAnalysis(data) {
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                this.hideGeneralAnalysisLoading();
                
                console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞:', data);
                
                if (!data.performance_stats) {
                    console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö performance_stats –≤ –æ—Ç–≤–µ—Ç–µ');
                    return;
                }
                
                const perfStats = data.performance_stats;
                
                // –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö
                safeSetTextContent('total-candles', this.allCandles.length.toLocaleString());
                
                // –ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö
                const firstDate = new Date(this.allCandles[0].open_time).toLocaleDateString();
                const lastDate = new Date(this.allCandles[this.allCandles.length-1].open_time).toLocaleDateString();
                safeSetTextContent('data-period', `${firstDate} ‚Äî ${lastDate}`);
                
                // –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
                const prices = this.allCandles.map(c => parseFloat(c.close_price));
                const returns = [];
                for (let i = 1; i < prices.length; i++) {
                    returns.push((prices[i] - prices[i-1]) / prices[i-1]);
                }
                const volatility = returns.length > 0 ? Math.sqrt(returns.reduce((sum, r) => sum + r*r, 0) / returns.length) * 100 : 0;
                safeSetTextContent('volatility', volatility.toFixed(2) + '%');
                
                // –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º
                const volumes = this.allCandles.map(c => parseFloat(c.volume));
                const avgVolume = volumes.reduce((sum, v) => sum + v, 0) / volumes.length;
                safeSetTextContent('avg-volume', this.formatVolume(avgVolume));
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏–∑ performance_stats
                const bullishPercentage = perfStats.bullish_percentage || 0;
                const bearishPercentage = perfStats.bearish_percentage || 0;
                
                const bullishCountValue = Math.round((bullishPercentage / 100) * (perfStats.valid_patterns || 0));
                const bearishCountValue = Math.round((bearishPercentage / 100) * (perfStats.valid_patterns || 0));
                
                safeSetTextContent('bullish-count', bullishCountValue);
                safeSetTextContent('bearish-count', bearishCountValue);
                
                // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã
                setTimeout(() => {
                    const bullishBar = document.getElementById('bullish-bar');
                    const bearishBar = document.getElementById('bearish-bar');
                    
                    if (bullishBar) bullishBar.style.width = bullishPercentage + '%';
                    if (bearishBar) bearishBar.style.width = bearishPercentage + '%';
                }, 100);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                this.displayPerformanceStats(perfStats, data.statistics);
                
                this.toast('–ê–Ω–∞–ª–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω');
            }

            displayPerformanceStats(perfStats, statistics) {
                console.log('displayPerformanceStats –≤—ã–∑–≤–∞–Ω–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:', perfStats);
                
                let performanceCard = document.getElementById('performance-stats-card');
                if (!performanceCard) {
                    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                    const sidePanel = document.getElementById('side-panel');
                    const generalCard = document.getElementById('general-analysis-card');
                    
                    performanceCard = document.createElement('div');
                    performanceCard.id = 'performance-stats-card';
                    performanceCard.className = 'card';
                    performanceCard.innerHTML = `
                        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
                        <div class="performance-stats" id="performance-stats-content"></div>
                    `;
                    
                    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                    generalCard.parentNode.insertBefore(performanceCard, generalCard.nextSibling);
                }
                
                const content = document.getElementById('performance-stats-content');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (!perfStats || perfStats.valid_patterns === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; color: var(--muted); padding: 20px;">
                            –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                        </div>
                    `;
                    performanceCard.style.display = 'block';
                    return;
                }
                
                content.innerHTML = `
                    <div class="stat-list">
                        <div class="stat">
                            <span>–ù–∞–π–¥–µ–Ω–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</span>
                            <span class="val" style="color: var(--accent);">${perfStats.total_patterns || 0}</span>
                        </div>
                        <div class="stat">
                            <span>–í–∞–ª–∏–¥–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</span>
                            <span class="val" style="color: var(--green);">${perfStats.valid_patterns || 0}</span>
                        </div>
                        <div class="stat">
                            <span>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</span>
                            <span class="val" style="color: var(--green);">${perfStats.success_rate || 0}%</span>
                        </div>
                        <div class="stat">
                            <span>–ú–µ–¥–∏–∞–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</span>
                            <span class="val" style="color: ${(perfStats.median_change || 0) >= 0 ? 'var(--green)' : 'var(--red)'}">
                                ${(perfStats.median_change || 0) >= 0 ? '+' : ''}${(perfStats.median_change || 0).toFixed(2)}%
                            </span>
                        </div>
                        ${perfStats.top_20_percent_median ? `
                        <div class="stat">
                            <span>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç</span>
                            <span class="val" style="color: var(--green);">+${(perfStats.top_20_percent_median).toFixed(2)}%</span>
                        </div>
                        ` : ''}
                        ${perfStats.bottom_20_percent_median ? `
                        <div class="stat">
                            <span>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ </span>
                            <span class="val" style="color: var(--red);">${(perfStats.bottom_20_percent_median).toFixed(2)}%</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="performance-summary">
                        <div class="summary-item">
                            <span class="summary-label">–ë—ã—á—å–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:</span>
                            <span class="summary-value bullish">${perfStats.bullish_percentage || 0}%</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">–ú–µ–¥–≤–µ–∂—å–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:</span>
                            <span class="summary-value bearish">${perfStats.bearish_percentage || 0}%</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:</span>
                            <span class="summary-value">${perfStats.neutral_percentage || 0}%</span>
                        </div>
                    </div>
                `;
                
                performanceCard.style.display = 'block';
            }
			showGeneralAnalysisLoading() {
				const generalStats = document.getElementById('general-stats');
				if (generalStats) {
					generalStats.innerHTML = `
						<div class="general-analysis-loading">
							<i class="fas fa-spinner"></i>
							<span>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...</span>
						</div>
					`;
					
					// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
					setTimeout(() => {
						this.hideGeneralAnalysisLoading();
					}, 10000);
				}
			}

			hideGeneralAnalysisLoading() {
				const generalStats = document.getElementById('general-stats');
				if (generalStats) {
					const loading = generalStats.querySelector('.general-analysis-loading');
					if (loading) {
						loading.remove();
					}
				}
			}


			displayRecentPatterns(patterns) {
				const recentPatternsCard = document.getElementById('recent-patterns-card');
				const recentPatternsList = document.getElementById('recent-patterns-list');
				
				if (!patterns || patterns.length === 0) {
					recentPatternsCard.style.display = 'none';
					return;
				}
				
				recentPatternsList.innerHTML = '';
				
				patterns.forEach((pattern, index) => {
					const patternEl = document.createElement('div');
					patternEl.className = 'recent-pattern';
					
					const priceChangeClass = pattern.price_change >= 0 ? 'positive' : 'negative';
					const volumeChangeClass = pattern.volume_change >= 0 ? 'positive' : 'negative';
					
					patternEl.innerHTML = `
						<div class="recent-pattern-header">
							<div class="recent-pattern-dates">
								${new Date(pattern.start_date).toLocaleDateString()} ‚Äî ${new Date(pattern.end_date).toLocaleDateString()}
							</div>
							<div class="recent-pattern-direction ${pattern.direction}">
								${pattern.direction === 'bullish' ? '‚Üó' : '‚Üò'} ${pattern.direction}
							</div>
						</div>
						<div class="recent-pattern-stats">
							<div class="recent-pattern-stat">
								<span class="recent-pattern-stat-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã:</span>
								<span class="recent-pattern-stat-value ${priceChangeClass}">
									${pattern.price_change >= 0 ? '+' : ''}${pattern.price_change.toFixed(2)}%
								</span>
							</div>
							<div class="recent-pattern-stat">
								<span class="recent-pattern-stat-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–±—ä–µ–º–∞:</span>
								<span class="recent-pattern-stat-value ${volumeChangeClass}">
									${pattern.volume_change >= 0 ? '+' : ''}${pattern.volume_change.toFixed(1)}%
								</span>
							</div>
						</div>
					`;
					
					// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –ø–∞—Ç—Ç–µ—Ä–Ω—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
					patternEl.addEventListener('click', () => {
						this.zoomToPattern(pattern);
					});
					
					recentPatternsList.appendChild(patternEl);
				});
				
				recentPatternsCard.style.display = 'block';
			}

			zoomToPattern(pattern) {
				if (!pattern.candles || pattern.candles.length === 0) return;
				
				const firstCandle = pattern.candles[0];
				const lastCandle = pattern.candles[pattern.candles.length - 1];
				
				const startTime = Math.floor(new Date(firstCandle.date).getTime() / 1000);
				const endTime = Math.floor(new Date(lastCandle.date).getTime() / 1000);
				
				this.zoomTo(startTime, endTime);
				this.toast(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–∞—Ç—Ç–µ—Ä–Ω—É ${pattern.direction}`);
			}

			formatVolume(volume) {
				if (volume >= 1e9) return (volume / 1e9).toFixed(1) + 'B';
				if (volume >= 1e6) return (volume / 1e6).toFixed(1) + 'M';
				if (volume >= 1e3) return (volume / 1e3).toFixed(1) + 'K';
				return volume.toFixed(0);
			}

			async createMiniChart(data) {
				const miniChartContainer = document.getElementById('mini-chart-container');
				const canvas = document.getElementById('mini-chart');
				
				if (!canvas || !miniChartContainer) return;
				
				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
				miniChartContainer.style.display = 'block';
				
				try {
					// –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∞
					const response = await fetch(`/api/pattern/ohlcv?source=binance&timeframe=${this.currentTimeframe}&from=${this.getDateDaysAgo(30)}`);
					const chartData = await response.json();
					
					if (!chartData.success || !chartData.candles) return;
					
					// –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
					const ctx = canvas.getContext('2d');
					const width = canvas.width;
					const height = canvas.height;
					
					// –û—á–∏—â–∞–µ–º canvas
					ctx.clearRect(0, 0, width, height);
					
					// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
					const prices = chartData.candles.slice(-30).map(c => parseFloat(c.close_price));
					const minPrice = Math.min(...prices);
					const maxPrice = Math.max(...prices);
					const priceRange = maxPrice - minPrice;
					
					// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
					const padding = 10;
					const chartWidth = width - padding * 2;
					const chartHeight = height - padding * 2;
					
					// –†–∏—Å—É–µ–º —Ñ–æ–Ω
					ctx.fillStyle = '#0a0f14';
					ctx.fillRect(0, 0, width, height);
					
					// –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
					ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
					ctx.lineWidth = 1;
					for (let i = 0; i <= 4; i++) {
						const y = padding + (chartHeight / 4) * i;
						ctx.beginPath();
						ctx.moveTo(padding, y);
						ctx.lineTo(width - padding, y);
						ctx.stroke();
					}
					
					// –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é —Ü–µ–Ω—ã
					ctx.strokeStyle = '#f7931a';
					ctx.lineWidth = 2;
					ctx.beginPath();
					
					prices.forEach((price, index) => {
						const x = padding + (chartWidth / (prices.length - 1)) * index;
						const y = padding + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
						
						if (index === 0) {
							ctx.moveTo(x, y);
						} else {
							ctx.lineTo(x, y);
						}
					});
					
					ctx.stroke();
					
					// –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ–¥ –ª–∏–Ω–∏–µ–π
					const gradient = ctx.createLinearGradient(0, padding, 0, height - padding);
					gradient.addColorStop(0, 'rgba(247, 147, 26, 0.3)');
					gradient.addColorStop(1, 'rgba(247, 147, 26, 0.05)');
					
					ctx.fillStyle = gradient;
					ctx.lineTo(width - padding, height - padding);
					ctx.lineTo(padding, height - padding);
					ctx.closePath();
					ctx.fill();
					
					// –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∫–æ–Ω—Ü–∞—Ö
					const firstPrice = prices[0];
					const lastPrice = prices[prices.length - 1];
					
					ctx.fillStyle = '#f7931a';
					ctx.beginPath();
					ctx.arc(padding, padding + chartHeight - ((firstPrice - minPrice) / priceRange) * chartHeight, 3, 0, 2 * Math.PI);
					ctx.fill();
					
					ctx.fillStyle = lastPrice >= firstPrice ? '#22c55e' : '#ef4444';
					ctx.beginPath();
					ctx.arc(width - padding, padding + chartHeight - ((lastPrice - minPrice) / priceRange) * chartHeight, 3, 0, 2 * Math.PI);
					ctx.fill();
					
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∞:', error);
					miniChartContainer.style.display = 'none';
				}
			}

			getDateDaysAgo(days) {
				const date = new Date();
				date.setDate(date.getDate() - days);
				return date.toISOString().slice(0, 10);
			}

		}

		document.addEventListener('DOMContentLoaded', () => new PatternChart());
    </script>
</body>
</html>
