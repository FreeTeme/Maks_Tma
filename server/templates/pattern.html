<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/USDT — Поиск паттернов</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-0: #0f1419;
            --bg-1: #11161c;
            --bg-2: #131a21;
            --bg-3: #0b1015;
            --panel: #0f151b;
            --border: #1c2631;
            --muted: #8b99a8;
            --text: #e5edf5;
            --accent: #f7931a;
            --green: #22c55e;
            --red: #ef4444;
        }

        html, body { 
            height: 100%; 
            margin: 0;
            padding: 0;
        }
        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: radial-gradient(1200px 600px at 20% -10%, #0b1117 0%, #0a0f14 45%, #070b0f 100%);
            color: var(--text);
            overflow: hidden;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(17,22,28,0.85), rgba(17,22,28,0.65));
            backdrop-filter: blur(6px);
            flex-shrink: 0;
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        .back-btn {
            background: #1a222c;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        .back-btn:hover {
            background: #212a34;
            color: var(--accent);
        }
        .brand .logo {
            width: 24px; height: 24px; border-radius: 6px;
            background: linear-gradient(135deg, #ffb547, #f7931a);
            box-shadow: 0 2px 8px rgba(247,147,26,0.35);
        }
        .brand .title { 
            font-weight: 700; 
            letter-spacing: 0.2px; 
            font-size: 15px;
        }
        .kpis { 
            display: flex; 
            gap: 12px; 
            align-items: center;
            font-size: 12px;
        }
        .kpi { font-size: 11px; color: var(--muted); }
        .kpi strong { color: var(--text); margin-left: 4px; }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            overflow: hidden;
            flex: 1;
            margin: 12px;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, var(--bg-2), var(--bg-3));
            flex-shrink: 0;
        }
        .left-tools, .right-tools { display: flex; gap: 6px; align-items: center; }
        .btn {
            background: #1a222c;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.15s ease;
            white-space: nowrap;
        }
        .btn:hover { background: #212a34; }
        .btn.primary { background: var(--accent); border-color: #ffb547; color: #0c0f12; font-weight: 600; }
        .btn.primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.analyze { 
            background: #22c55e !important; 
            border-color: #16a34a !important; 
            color: #ffffff !important; 
            font-weight: 600; 
            padding: 8px 12px; 
            font-size: 13px; 
        }
        .btn.analyze:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background: #22c55e !important; 
        }
        .btn.analyze:hover { 
            background: #16a34a !important; 
            border-color: #15803d !important;
        }
        .btn.clear { 
            background: #dc2626 !important; 
            border-color: #b91c1c !important; 
            color: #ffffff !important; 
            font-weight: 600; 
        }
        .btn.clear:hover { 
            background: #b91c1c !important; 
            border-color: #991b1b !important;
        }
        .tf { display: flex; gap: 4px; }
        .tf .btn.active { background: #2a3542; border-color: #334153; }
        .sep { width: 1px; height: 22px; background: var(--border); }
        .counter { font-size: 12px; color: var(--muted); }
        .counter strong { color: var(--text); }

        .chart-wrap { 
            position: relative; 
            flex: 1; 
            min-height: 300px; 
        }
        #chart { width: 100%; height: 100%; }

        .side {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 0 12px 60px;
            overflow-y: auto;
        }
        .side.active {
            display: flex;
        }
        .card { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            padding: 10px; 
        }
        .card h3 { margin: 0 0 6px; font-size: 13px; color: var(--muted); font-weight: 600; }
        .stat-list { display: grid; gap: 6px; }
        .stat { display: flex; justify-content: space-between; font-size: 12px; }
        .stat .val { color: var(--text); font-weight: 600; }

        .matches { display: grid; gap: 8px; }
        .match {
            border: 1px solid var(--border);
            border-radius: 8px; 
            padding: 8px;
            background: #0f151b;
            cursor: pointer;
            transition: 0.15s ease;
        }
        .match:hover { background: #131a21; border-color: #2a3847; }
        .match .hdr { display: flex; justify-content: space-between; align-items: center; }
        .match .range { font-size: 11px; color: var(--muted); }
        .badge { padding: 2px 6px; border-radius: 999px; font-size: 11px; font-weight: 700; }
        .badge.up { background: rgba(34,197,94,0.15); color: var(--green); }
        .badge.down { background: rgba(239,68,68,0.15); color: var(--red); }

        .footer-note { font-size: 11px; color: var(--muted); text-align: center; padding-top: 4px; }

        /* Mobile bottom navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-1);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(17, 22, 28, 0.9);
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            font-size: 11px;
            color: var(--muted);
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn.active {
            color: var(--accent);
            background: rgba(247, 147, 26, 0.1);
        }
        .nav-btn i {
            font-size: 18px;
            margin-bottom: 2px;
        }

        /* Modal for patterns */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(7, 11, 15, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--panel);
            border-radius: 12px;
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        /* Clear Modal Styles */
        .clear-modal-content {
            max-width: 450px;
            text-align: center;
        }
        
        .clear-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }
        
        .clear-icon i {
            font-size: 32px;
            color: #ffffff;
        }
        
        .clear-modal-content h3 {
            margin: 0 0 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
        }
        
        .clear-modal-content p {
            margin: 0 0 24px;
            font-size: 14px;
            color: var(--muted);
            line-height: 1.5;
        }
        
        .clear-stats {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin: 0 0 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }
        
        .clear-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .btn.clear-confirm {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .btn.clear-confirm:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        }
        
        .btn.clear-cancel {
            background: var(--bg-2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn.clear-cancel:hover {
            background: var(--bg-3);
            border-color: #334153;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title {
            font-weight: 600;
            font-size: 16px;
        }
        .close-modal {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .close-modal:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        /* Overlay + toast */
        .loading {
            position: fixed; 
            inset: 0; 
            display: none; 
            align-items: center; 
            justify-content: center;
            background: rgba(3,6,9,0.55); 
            backdrop-filter: blur(2px); 
            z-index: 50;
        }
        .spinner { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: 3px solid rgba(255,255,255,0.12); 
            border-top-color: var(--accent); 
            animation: spin 0.9s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { 
            position: fixed; 
            bottom: 70px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #111821; 
            border: 1px solid #223041; 
            color: #e3edf7; 
            padding: 10px 14px; 
            border-radius: 10px; 
            font-size: 13px; 
            display: none; 
            z-index: 60;
            max-width: 80%;
            text-align: center;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .app {
                display: grid;
                grid-template-rows: auto 1fr;
            }
            
            .main {
                display: grid;
                grid-template-columns: 1fr 320px;
                gap: 12px;
                padding: 12px;
                overflow: hidden;
            }
            
            .panel {
                margin: 0;
            }
            
            .side {
                display: flex;
                padding: 0;
                overflow-y: auto;
            }
            
            .mobile-nav {
                display: none;
            }
            
            .topbar {
                padding: 16px 20px;
            }
            
            .brand .logo {
                width: 28px; 
                height: 28px;
            }
            
            .brand .title {
                font-size: 16px;
            }
            
            .kpis {
                gap: 16px;
                font-size: 13px;
            }
            
            .toolbar {
                padding: 10px 12px;
            }
            
            .btn {
                padding: 8px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 380px) {
            .toolbar {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .left-tools, .right-tools {
                flex-wrap: wrap;
            }
            
            .btn {
                font-size: 11px;
                padding: 5px 6px;
            }
            
            .counter {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="topbar">
            <div class="brand">
                <button class="back-btn" onclick="history.back()" title="Назад">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="logo"></div>
                <div class="title">BTC/USDT — Поиск паттернов</div>
            </div>
            <div class="kpis">
                <div class="kpi">ТФ:<strong>1D</strong></div>
                <div class="kpi">Данные:<strong>2015→</strong></div>
            </div>
        </div>

        <div class="main">
            <div class="panel">
                <div class="toolbar">
                    <div class="left-tools">
                        <div class="tf">
                            <button class="btn active" data-tf="1D">1D</button>
                            <button class="btn" data-tf="1W">1W</button>
                            <button class="btn" data-tf="1M">1M</button>
                        </div>
                        <div class="sep"></div>
                        <button id="toggle-volume-btn" class="btn">Объём</button>
                        <button id="reset-view-btn" class="btn">Сброс</button>
                    </div>
                    <div class="right-tools">
                        <div class="counter">Выбрано: <strong id="selected-count">0</strong>/6</div>
                        <button id="to-selected-btn" class="btn">К выбр.</button>
                        <div class="sep"></div>
                        <button id="prev-match-btn" class="btn">◀</button>
                        <span id="match-index" class="kpi" style="min-width:46px;text-align:center;">0/0</span>
                        <button id="next-match-btn" class="btn">▶</button>
                        <button id="clear-btn" class="btn clear">Очистить</button>
                        <button id="analyze-btn" class="btn analyze" disabled>Анализ</button>
                    </div>
                </div>
                <div class="chart-wrap"><div id="chart"></div></div>
            </div>

            <div class="side" id="side-panel">
                <div class="card">
                    <h3>Итоги</h3>
                    <div class="stat-list">
                        <div class="stat"><span>Найдено совпадений</span><span class="val" id="matches-found">0</span></div>
                        <div class="stat"><span>Длина паттерна</span><span class="val" id="pattern-length">0</span></div>
                        <div class="stat"><span>Средняя точность</span><span class="val" id="accuracy">0%</span></div>
                    </div>
                    <div class="footer-note">Выберите 1–6 свечей на графике и запустите анализ</div>
                </div>
                <div class="card" id="pattern-info-card" style="display:none">
                    <h3>Паттерн</h3>
                    <div class="stat-list" id="pattern-info"></div>
                </div>
                <div class="card">
                    <h3>Совпадения</h3>
                    <div class="matches" id="matches"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <button class="nav-btn" id="nav-analysis">
            <i class="fas fa-chart-line"></i>
            <span>Анализ</span>
        </button>
        <button class="nav-btn" id="nav-clear">
            <i class="fas fa-trash"></i>
            <span>Очистить</span>
        </button>
        <button class="nav-btn" id="nav-prev">
            <i class="fas fa-chevron-left"></i>
            <span>Назад</span>
        </button>
        <button class="nav-btn" id="nav-next">
            <i class="fas fa-chevron-right"></i>
            <span>Вперед</span>
        </button>
        <button class="nav-btn" id="nav-to-selected">
            <i class="fas fa-search"></i>
            <span>К выбранным</span>
        </button>
        <button class="nav-btn" id="nav-patterns">
            <i class="fas fa-shapes"></i>
            <span>Паттерны</span>
        </button>
    </div>

    <!-- Patterns Modal -->
    <div class="modal" id="patterns-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Найденные паттерны</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="pattern-stats" id="modal-pattern-stats" style="margin-bottom: 16px; padding: 12px; background: var(--bg-2); border-radius: 8px; border: 1px solid var(--border);">
                    <!-- Pattern statistics will be inserted here -->
                </div>
                <div id="modal-patterns-list">
                    <!-- Patterns will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Confirmation Modal -->
    <div class="modal" id="clear-confirmation-modal">
        <div class="modal-content clear-modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-trash-alt" style="margin-right: 8px; color: #dc2626;"></i>
                    Очистка выбора
                </div>
                <button class="close-modal" id="close-clear-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="clear-modal-content">
                    <div class="clear-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <h3>Обновить страницу?</h3>
                    <p>Это действие обновит страницу и сбросит все выбранные свечи и анализ. Вы сможете начать заново.</p>
                    <div class="clear-stats" id="clear-stats">
                        <div class="stat-item">
                            <span class="stat-label">Выбрано свечей:</span>
                            <span class="stat-value" id="selected-count-modal">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Найдено паттернов:</span>
                            <span class="stat-value" id="patterns-count-modal">0</span>
                        </div>
                    </div>
                    <div class="clear-actions">
                        <button class="btn clear-confirm" id="confirm-clear-btn">
                            <i class="fas fa-sync-alt"></i>
                            <span>Да, обновить</span>
                        </button>
                        <button class="btn clear-cancel" id="cancel-clear-btn">
                            <i class="fas fa-times"></i>
                            <span>Отмена</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
		class PatternChart {
            constructor() {
                this.chart = null;
                this.candleSeries = null;
                this.volumeSeries = null;
                this.volumeVisible = true;
                this.allCandles = [];
				this.selectedIndices = new Set();
				this.selectedMarkers = new Map();
				this.patternMarkers = new Map();
                this.initChart();
                this.loadData();
				this.bindUI();
				this.toastEl = null;
				this.overlay = null;
				this.matchedHighlightPoints = [];
				this.selectedHighlightPoints = [];
				this.currentMatchIndex = -1;
				this.matchedRanges = [];
            }

            initChart() {
				const el = document.getElementById('chart');
				this.chart = LightweightCharts.createChart(el, {
					width: el.clientWidth,
					height: el.clientHeight,
					layout: { backgroundColor: '#0a0f14', textColor: '#d6dee6', fontFamily: 'Inter' },
					grid: { vertLines: { color: 'rgba(32,42,54,0.85)' }, horzLines: { color: 'rgba(32,42,54,0.85)' } },
					crosshair: { mode: LightweightCharts.CrosshairMode.Magnet, vertLine: { color: '#3a4654' }, horzLine: { color: '#3a4654' } },
					rightPriceScale: { borderColor: '#243142' },
					timeScale: { borderColor: '#243142', rightOffset: 6, barSpacing: 40, minBarSpacing: 30 },
					handleScroll: { mouseWheel: true, pressedMouseMove: true },
					handleScale: { axisPressedMouseMove: { time: true, price: true } },
                });

                this.candleSeries = this.chart.addCandlestickSeries({
					upColor: '#21d07a',
					downColor: '#f04444',
					borderUpColor: '#1ac46f',
					borderDownColor: '#e73c3c',
					wickUpColor: '#24e084',
					wickDownColor: '#ff5050',
                    priceLineVisible: false,
                });
                this.volumeSeries = this.chart.addHistogramSeries({
                    priceScaleId: '',
					scaleMargins: { top: 0.8, bottom: 0 },
					priceFormat: { type: 'volume' },
				});

				this.chart.subscribeClick(this.onClick.bind(this));
				window.addEventListener('resize', () => { this.chart.applyOptions({ width: el.clientWidth }); this.resizeOverlay(); this.redrawOverlay(); });
				this.ensureOverlay();
				this.chart.timeScale().subscribeVisibleTimeRangeChange(() => this.redrawOverlay());
            }

            async loadData() {
                try {
					// Узнаём реальные границы датасета на сервере и синхронизируемся
					let dsStart = new Date('2018-01-01T00:00:00Z');
					let dsEnd = new Date();
					try {
						const b = await fetch('/api/pattern_bounds');
						if (b.ok) {
							const j = await b.json();
							if (j.success) { dsStart = new Date(j.start + 'T00:00:00Z'); dsEnd = new Date(j.end + 'T00:00:00Z'); }
						}
					} catch(_) {}
					this.datasetStart = dsStart; this.datasetEnd = dsEnd;
					// Загружаем реальные свечи с сервера
					const api = await fetch(`/api/ohlcv?source=binance&from=${dsStart.toISOString().slice(0,10)}&to=${dsEnd.toISOString().slice(0,10)}`);
					if (!api.ok) throw new Error('Не удалось загрузить OHLCV');
					const aj = await api.json();
					if (!aj.success) throw new Error(aj.message || 'Ошибка загрузки OHLCV');
					this.allCandles = aj.candles || [];

					if (!Array.isArray(this.allCandles) || this.allCandles.length === 0) {
						throw new Error('Пустой набор свечей');
					}
					// Нормализация типов
					this.allCandles = this.allCandles.map(c => ({
						open_time: c.open_time,
						close_time: c.close_time,
						open_price: Number(c.open_price),
						close_price: Number(c.close_price),
						high: Number(c.high),
						low: Number(c.low),
						volume: Number(c.volume),
					}));
					const k = this.allCandles.map(c => ({
						time: Math.floor(new Date(c.open_time).getTime() / 1000),
						open: c.open_price, high: c.high, low: c.low, close: c.close_price,
					}));
					this.candleSeries.setData(k);

					const v = this.allCandles.map(c => ({
						time: Math.floor(new Date(c.open_time).getTime() / 1000),
						value: c.volume,
						color: (c.close_price >= c.open_price) ? 'rgba(34,197,94,0.5)' : 'rgba(239,68,68,0.5)'
					}));
					this.volumeSeries.setData(v);
                    this.chart.timeScale().fitContent();
                    setTimeout(() => { try { this.chart.timeScale().fitContent(); } catch(_){} }, 0);
					// Zoom-in to make candles visually larger (60% closer for easier interaction)
					setTimeout(() => {
						const range = this.chart.timeScale().getVisibleRange();
						if (range) {
							const pad = Math.floor((range.to - range.from) * 0.60);
							this.chart.timeScale().setVisibleRange({ from: range.from + pad, to: range.to - pad });
						}
						this.redrawOverlay();
					}, 100);
				} catch (e) {
					console.error(e);
					alert('Не удалось загрузить исторические данные.');
				}
			}

			generateData(startDate = new Date('2018-01-01T00:00:00Z'), endDate = new Date()) {
				const out = [];
				let d = new Date(startDate);
				let price = 300;
				while (d <= endDate) {
					const vol = 10000 + Math.random()*50000;
					const volat = 0.025;
                    const open = price;
					const delta = (Math.random()-0.5)*volat;
					const close = open * (1 + delta);
					const high = Math.max(open, close) * (1 + Math.random()*volat*0.6);
					const low = Math.min(open, close) * (1 - Math.random()*volat*0.6);
					out.push({
						open_time: d.toISOString(),
						close_time: new Date(d.getTime()+24*60*60*1000-1).toISOString(),
						open_price: open.toFixed(2), close_price: close.toFixed(2),
						high: high.toFixed(2), low: low.toFixed(2), volume: vol.toFixed(2)
					});
					price = close;
					d.setUTCDate(d.getUTCDate()+1);
				}
				return out;
			}

			bindUI() {
				document.getElementById('analyze-btn').addEventListener('click', () => this.analyze());
                document.getElementById('clear-btn').addEventListener('click', () => this.showClearConfirmationModal());
				document.getElementById('reset-view-btn').addEventListener('click', () => this.resetView());
                document.getElementById('toggle-volume-btn').addEventListener('click', () => this.toggleVolume());
				document.getElementById('to-selected-btn').addEventListener('click', () => this.zoomToSelected());
				document.getElementById('prev-match-btn').addEventListener('click', () => this.gotoMatch(-1));
				document.getElementById('next-match-btn').addEventListener('click', () => this.gotoMatch(1));
				document.querySelectorAll('[data-tf]').forEach(b => b.addEventListener('click', (e) => {
					document.querySelectorAll('[data-tf]').forEach(x => x.classList.remove('active'));
                        e.target.classList.add('active');
					// (Таймфреймы-стаб, данные дневные)
				}));

				// Mobile navigation buttons
				document.getElementById('nav-analysis').addEventListener('click', () => this.analyze());
				document.getElementById('nav-clear').addEventListener('click', () => this.showClearConfirmationModal());
				document.getElementById('nav-prev').addEventListener('click', () => this.gotoMatch(-1));
				document.getElementById('nav-next').addEventListener('click', () => this.gotoMatch(1));
				document.getElementById('nav-to-selected').addEventListener('click', () => this.zoomToSelected());
				document.getElementById('nav-patterns').addEventListener('click', () => this.showPatternsModal());

				// Clear confirmation modal buttons
				document.getElementById('confirm-clear-btn').addEventListener('click', () => {
					window.location.reload();
				});
				document.getElementById('cancel-clear-btn').addEventListener('click', () => this.hideClearConfirmationModal());
				document.getElementById('close-clear-modal').addEventListener('click', () => this.hideClearConfirmationModal());

				// Modal close button
				document.querySelector('.close-modal').addEventListener('click', () => this.hidePatternsModal());
				
				// Close modal when clicking outside
				document.getElementById('patterns-modal').addEventListener('click', (e) => {
					if (e.target.id === 'patterns-modal') {
						this.hidePatternsModal();
					}
				});
				document.getElementById('clear-confirmation-modal').addEventListener('click', (e) => {
					if (e.target.id === 'clear-confirmation-modal') {
						this.hideClearConfirmationModal();
					}
				});
            }

			onClick(param) {
                if (!param || !param.time) return;
				const ts = param.time;
				const idx = this.allCandles.findIndex(c => Math.floor(new Date(c.open_time).getTime()/1000) === ts);
				if (idx === -1) return;
				// Блокируем выбор свечей вне границ датасета
				const t = new Date(this.allCandles[idx].open_time);
				if (this.datasetStart && this.datasetEnd && (t < this.datasetStart || t > this.datasetEnd)) {
					this.toast('Свеча вне диапазона датасета');
                        return;
                    }
				if (this.selectedIndices.has(idx)) this.selectedIndices.delete(idx);
				else {
					if (this.selectedIndices.size >= 6) { alert('Можно выбрать максимум 6 свечей'); return; }
					this.selectedIndices.add(idx);
				}
				this.updateSelected();
			}

			updateSelected() {
				document.getElementById('selected-count').textContent = this.selectedIndices.size;
				document.getElementById('analyze-btn').disabled = this.selectedIndices.size === 0;
				this.selectedMarkers.clear();
				this.selectedHighlightPoints = [];
				[...this.selectedIndices].forEach(i => {
					const t = Math.floor(new Date(this.allCandles[i].open_time).getTime()/1000);
					this.selectedMarkers.set(i, { time: t, position: 'aboveBar', color: '#ffd54a', shape: 'circle', text: '●', size: 1.2 });
					this.selectedHighlightPoints.push({ time: t, color: '#ffd54a' });
				});
				this.applyMarkers();
				this.redrawOverlay();
			}

			applyMarkers() {
				const sel = Array.from(this.selectedMarkers.values());
				const pats = Array.from(this.patternMarkers.values()).flat();
				this.candleSeries.setMarkers([...sel, ...pats]);
            }

            clearSelection() {
				this.selectedIndices.clear();
				this.selectedMarkers.clear();
				this.selectedHighlightPoints = [];
				this.applyMarkers();
				document.getElementById('selected-count').textContent = '0';
				document.getElementById('analyze-btn').disabled = true;
				this.redrawOverlay();
			}

			resetView() {
                this.chart.timeScale().fitContent();
				// Apply zoom after reset
				setTimeout(() => {
					const range = this.chart.timeScale().getVisibleRange();
					if (range) {
						const pad = Math.floor((range.to - range.from) * 0.60);
						this.chart.timeScale().setVisibleRange({ from: range.from + pad, to: range.to - pad });
					}
				}, 50);
				this.patternMarkers.clear();
				this.applyMarkers();
				this.redrawOverlay();
            }

            toggleVolume() {
                this.volumeVisible = !this.volumeVisible;
                if (this.volumeVisible) {
					const v = this.allCandles.map(c => ({
						time: Math.floor(new Date(c.open_time).getTime() / 1000),
						value: +c.volume,
						color: (+c.close_price >= +c.open_price) ? 'rgba(34,197,94,0.5)' : 'rgba(239,68,68,0.5)'
					}));
					this.volumeSeries.setData(v);
                } else {
                    this.volumeSeries.setData([]);
				}
			}

			async analyze() {
				if (this.selectedIndices.size === 0) return;
				const order = [...this.selectedIndices].sort((a,b) => a-b);
				const candles = order.map(i => this.allCandles[i]);
				const payload = { num_candles: candles.length, candles };
				// UI state
				const btn = document.getElementById('analyze-btn');
				const loader = this.ensureLoader();
				btn.disabled = true; loader.style.display = 'flex';
				try {
					const res = await fetch('/analyze_pattern', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
					const data = await res.json();
					if (!res.ok || !data.success) throw new Error(data.message || 'Ошибка анализа');
					this.renderResults(data);
					this.drawPatternMarkers(data.matched_patterns);
					if (!data.matched_patterns || data.matched_patterns.length === 0) this.toast('Совпадения не найдены');
					this.toast('Анализ завершён');
				} catch (e) {
					this.toast('Ошибка: ' + e.message);
                } finally {
					btn.disabled = this.selectedIndices.size === 0;
					loader.style.display = 'none';
                }
            }

			renderResults(result) {
                document.getElementById('matches-found').textContent = result.statistics.matches_found;
                document.getElementById('pattern-length').textContent = result.pattern_info.pattern_len;
				const percents = result.statistics.distribution_percents || {};
				const avg = Object.keys(percents).length ? (Object.values(percents).reduce((a,b)=>a+b,0) / Object.keys(percents).length) : 0;
				document.getElementById('accuracy').textContent = (avg||0).toFixed(2) + '%';

				const pi = document.getElementById('pattern-info');
				pi.innerHTML = `
					<div class="stat"><span>Начало</span><span class="val">${result.pattern_info.pattern_start}</span></div>
					<div class="stat"><span>Конец</span><span class="val">${result.pattern_info.pattern_end}</span></div>
					<div class="stat"><span>Свечей</span><span class="val">${result.pattern_info.pattern_len}</span></div>
				`;
				document.getElementById('pattern-info-card').style.display = '';

				const matches = document.getElementById('matches');
				matches.innerHTML = '';
				this.matchedRanges = [];
				(result.matched_patterns || []).forEach((pat, i) => {
					const first = pat[0];
					const last = pat[pat.length-1];
					const change = ((last.close - first.open) / first.open) * 100;
					this.matchedRanges.push([ Math.floor(new Date(first.date).getTime()/1000), Math.floor(new Date(last.date).getTime()/1000) ]);
					const el = document.createElement('div');
					el.className = 'match';
					el.innerHTML = `
						<div class="hdr">
							<div class="range">${new Date(first.date).toLocaleDateString()} — ${new Date(last.date).toLocaleDateString()}</div>
							<div class="badge ${change>=0?'up':'down'}">${change>=0?'+':''}${change.toFixed(2)}%</div>
                    </div>
					`;
					el.addEventListener('click', () => {
						this.currentMatchIndex = i;
						this.updateMatchIndexLabel();
						const [from, to] = this.matchedRanges[i];
						this.zoomTo(from, to);
					});
					matches.appendChild(el);
				});
				this.currentMatchIndex = this.matchedRanges.length ? 0 : -1;
				this.updateMatchIndexLabel();
			}

			drawPatternMarkers(matched) {
				this.patternMarkers.clear();
				const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#ffd166', '#a78bfa', '#f97316'];
				this.matchedHighlightPoints = [];
				(matched || []).forEach((pat, pIdx) => {
					const col = colors[pIdx % colors.length];
					const arr = [];
					for (let i=0;i<pat.length;i++) {
						const t = Math.floor(new Date(pat[i].date).getTime()/1000);
						arr.push({ time: t, position: 'belowBar', color: col, shape: 'square', text: `P${pIdx+1}`, size: 1.4 });
						this.matchedHighlightPoints.push({ time: t, color: col });
					}
					this.patternMarkers.set(pIdx, arr);
				});
				this.applyMarkers();
				this.redrawOverlay();
				if (matched && matched.length && matched[0].length) {
					const f = matched[0][0];
					const l = matched[0][matched[0].length-1];
					this.zoomTo(Math.floor(new Date(f.date).getTime()/1000), Math.floor(new Date(l.date).getTime()/1000));
				}
			}

			zoomTo(from, to) {
				const pad = Math.max(3*24*60*60, Math.floor((to-from)*0.5));
				this.chart.timeScale().setVisibleRange({ from: from - pad, to: to + pad });
			}

			// ===== Overlay helpers for highlighting candles =====
			ensureOverlay() {
				if (this.overlay) return this.overlay;
				const host = document.getElementById('chart');
				const canvas = document.createElement('canvas');
				canvas.style.position = 'absolute';
				canvas.style.left = '0';
				canvas.style.top = '0';
				canvas.style.pointerEvents = 'none';
				canvas.width = host.clientWidth; canvas.height = host.clientHeight;
				host.appendChild(canvas);
				this.overlay = canvas;
				return canvas;
			}

			resizeOverlay() {
				const host = document.getElementById('chart');
				if (!this.overlay) return;
				this.overlay.width = host.clientWidth;
				this.overlay.height = host.clientHeight;
			}

			redrawOverlay() {
				this.ensureOverlay();
				if (!this.overlay) return;
				const ctx = this.overlay.getContext('2d');
				ctx.clearRect(0,0,this.overlay.width,this.overlay.height);
				const ts = this.chart.timeScale();
				const barW = ts.getBarSpacing ? ts.getBarSpacing() : 12;
				const h = this.overlay.height;
				// draw selected first (gold), then matches
				for (const p of (this.selectedHighlightPoints || [])) {
					const x = ts.timeToCoordinate(p.time);
					if (x === null || x === undefined) continue;
					ctx.fillStyle = 'rgba(255,213,74,0.10)';
					ctx.fillRect(Math.round(x - barW*0.6), 0, Math.round(barW*1.2), h);
					ctx.strokeStyle = 'rgba(255,213,74,0.6)';
					ctx.lineWidth = 1;
					ctx.strokeRect(Math.round(x - barW*0.6)+0.5, 0.5, Math.round(barW*1.2)-1, h-1);
				}
				for (const p of (this.matchedHighlightPoints || [])) {
					const x = ts.timeToCoordinate(p.time);
					if (x === null || x === undefined) continue;
					ctx.fillStyle = this.hexToRgba(p.color, 0.12);
					ctx.fillRect(Math.round(x - barW*0.6), 0, Math.round(barW*1.2), h);
					ctx.strokeStyle = this.hexToRgba(p.color, 0.35);
					ctx.lineWidth = 1;
					ctx.strokeRect(Math.round(x - barW*0.6)+0.5, 0.5, Math.round(barW*1.2)-1, h-1);
				}
			}

			hexToRgba(hex, a) {
				// supports #rrggbb format
				const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
				if (!m) return `rgba(255,255,255,${a})`;
				const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
				return `rgba(${r},${g},${b},${a})`;
			}

			ensureLoader() {
				let el = document.querySelector('.loading');
				if (!el) {
					el = document.createElement('div'); el.className = 'loading';
					const sp = document.createElement('div'); sp.className = 'spinner'; el.appendChild(sp);
					document.body.appendChild(el);
				}
				return el;
			}

			toast(msg) {
				if (!this.toastEl) { this.toastEl = document.createElement('div'); this.toastEl.className = 'toast'; document.body.appendChild(this.toastEl); }
				this.toastEl.textContent = msg; this.toastEl.style.display = 'block';
				clearTimeout(this.toastTimer); this.toastTimer = setTimeout(() => { this.toastEl.style.display = 'none'; }, 2200);
			}

			// ===== Navigation helpers =====
			zoomToSelected() {
				if (!this.selectedIndices.size) { this.toast('Сначала выберите свечи'); return; }
				const sorted = [...this.selectedIndices].sort((a,b)=>a-b);
				const first = Math.floor(new Date(this.allCandles[sorted[0]].open_time).getTime()/1000);
				const last = Math.floor(new Date(this.allCandles[sorted[sorted.length-1]].open_time).getTime()/1000);
				this.zoomTo(first, last);
			}

			gotoMatch(step) {
				if (!this.matchedRanges.length) { this.toast('Совпадений нет'); return; }
				if (this.currentMatchIndex === -1) this.currentMatchIndex = 0;
				else this.currentMatchIndex = (this.currentMatchIndex + step + this.matchedRanges.length) % this.matchedRanges.length;
				this.updateMatchIndexLabel();
				const [from, to] = this.matchedRanges[this.currentMatchIndex];
				this.zoomTo(from, to);
			}

			updateMatchIndexLabel() {
				const el = document.getElementById('match-index');
				if (!el) return;
				el.textContent = this.matchedRanges.length ? `${this.currentMatchIndex+1}/${this.matchedRanges.length}` : '0/0';
			}

			showPatternsModal() {
				const modal = document.getElementById('patterns-modal');
				const patternsList = document.getElementById('modal-patterns-list');
				const patternStats = document.getElementById('modal-pattern-stats');
				
				// Clear previous content
				patternsList.innerHTML = '';
				patternStats.innerHTML = '';
				
				// Add pattern statistics
				if (this.matchedRanges && this.matchedRanges.length > 0) {
					const selectedCount = this.selectedIndices.size;
					const patternLength = selectedCount;
					const matchesFound = this.matchedRanges.length;
					
					patternStats.innerHTML = `
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
							<div class="stat">
								<span style="color: var(--muted); font-size: 12px;">Выбрано свечей</span>
								<span class="val" style="color: var(--accent); font-weight: 600;">${selectedCount}</span>
							</div>
							<div class="stat">
								<span style="color: var(--muted); font-size: 12px;">Найдено совпадений</span>
								<span class="val" style="color: var(--green); font-weight: 600;">${matchesFound}</span>
							</div>
						</div>
						<div style="font-size: 11px; color: var(--muted); text-align: center;">
							Кликните на паттерн для перехода к нему на графике
						</div>
					`;
					
					// Add patterns
					this.matchedRanges.forEach((range, index) => {
						const startDate = new Date(range[0] * 1000).toLocaleDateString();
						const endDate = new Date(range[1] * 1000).toLocaleDateString();
						
						const patternEl = document.createElement('div');
						patternEl.className = 'match';
						patternEl.innerHTML = `
							<div class="hdr">
								<div class="range">Паттерн ${index + 1}</div>
								<div class="badge up">${index + 1}</div>
							</div>
							<div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
								${startDate} — ${endDate}
							</div>
						`;
						patternEl.addEventListener('click', () => {
							this.currentMatchIndex = index;
							this.updateMatchIndexLabel();
							this.zoomTo(range[0], range[1]);
							this.hidePatternsModal();
						});
						patternsList.appendChild(patternEl);
					});
				} else {
					patternStats.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">Сначала выберите свечи и запустите анализ</div>';
					patternsList.innerHTML = '';
				}
				
				modal.style.display = 'block';
			}

			hidePatternsModal() {
				const modal = document.getElementById('patterns-modal');
				modal.style.display = 'none';
			}

			showClearConfirmationModal() {
				const modal = document.getElementById('clear-confirmation-modal');
				
				// Update statistics in modal
				document.getElementById('selected-count-modal').textContent = this.selectedIndices.size;
				document.getElementById('patterns-count-modal').textContent = this.matchedRanges.length;
				
				modal.style.display = 'block';
			}

			hideClearConfirmationModal() {
				const modal = document.getElementById('clear-confirmation-modal');
				modal.style.display = 'none';
			}

		}

		document.addEventListener('DOMContentLoaded', () => new PatternChart());
    </script>
</body>
</html>
