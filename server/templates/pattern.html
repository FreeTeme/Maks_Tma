<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/USDT ‚Äî –ü–æ–∏—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-0: #0f1419;
            --bg-1: #11161c;
            --bg-2: #131a21;
            --bg-3: #0b1015;
            --panel: #0f151b;
            --border: #1c2631;
            --muted: #8b99a8;
            --text: #e5edf5;
            --accent: #f7931a;
            --green: #22c55e;
            --red: #ef4444;
        }

        html, body { 
            height: 100%; 
            margin: 0;
            padding: 0;
        }
        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: radial-gradient(1200px 600px at 20% -10%, #0b1117 0%, #0a0f14 45%, #070b0f 100%);
            color: var(--text);
            overflow: hidden;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(17,22,28,0.85), rgba(17,22,28,0.65));
            backdrop-filter: blur(6px);
            flex-shrink: 0;
            flex-wrap: wrap; /* –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            gap: 10px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        }

        .brand { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-shrink: 0;
        }

        .kpis { 
            display: flex; 
            gap: 12px; 
            align-items: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–∏–º–≤–æ–ª–∞ */
        .symbol-selector {
            margin-left: 15px;
            flex-shrink: 0;
        }

        .symbol-select {
            background: #1a222c;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            min-width: 120px;
        }

        .symbol-select option {
            background: var(--bg-2);
            color: var(--text);
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            overflow: hidden;
            flex: 1;
            margin: 12px;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, var(--bg-2), var(--bg-3));
            flex-shrink: 0;
        }
        .left-tools, .right-tools { display: flex; gap: 6px; align-items: center; }
        .left-tools { justify-content: space-between; width: 100%; flex-wrap: wrap; }
        .right-tools { flex-wrap: nowrap; }
        .btn {
            background: #1a222c;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.15s ease;
            white-space: nowrap;
        }
        .tf .btn { flex: 1; }
        .btn:hover { background: #212a34; }
        .btn.primary { background: var(--accent); border-color: #ffb547; color: #0c0f12; font-weight: 600; }
        .btn.primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.analyze { 
            background: #22c55e !important; 
            border-color: #16a34a !important; 
            color: #ffffff !important; 
            font-weight: 600; 
            padding: 8px 12px; 
            font-size: 13px; 
        }
        .btn.analyze:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background: #22c55e !important; 
        }
        .btn.analyze:hover { 
            background: #16a34a !important; 
            border-color: #15803d !important;
        }
        .btn.clear { 
            background: #dc2626 !important; 
            border-color: #b91c1c !important; 
            color: #ffffff !important; 
            font-weight: 600; 
        }
        .btn.clear:hover { 
            background: #b91c1c !important; 
            border-color: #991b1b !important;
        }
        .tf { display: flex; gap: 6px; flex: 1; }
        .tf .btn.active { background: #2a3542; border-color: #334153; }
        .sep { width: 1px; height: 22px; background: var(--border); }
        .counter { font-size: 12px; color: var(--muted); }
        .counter strong { color: var(--text); }

        .chart-wrap { 
            position: relative; 
            flex: 1; 
            min-height: 300px; 
        }
        #chart { 
            width: 100%; 
            height: 100%; 
            touch-action: pan-x pan-y pinch-zoom;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .side {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 0 12px 60px;
            overflow-y: auto;
        }
        .side.active {
            display: flex;
        }
        .card { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            padding: 10px; 
        }
        .card h3 { margin: 0 0 6px; font-size: 13px; color: var(--muted); font-weight: 600; }
        .stat-list { display: grid; gap: 6px; }
        .stat { display: flex; justify-content: space-between; font-size: 12px; }
        .stat .val { color: var(--text); font-weight: 600; }

        .matches { display: grid; gap: 8px; }
        .match {
            border: 1px solid var(--border);
            border-radius: 8px; 
            padding: 8px;
            background: #0f151b;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .match:hover { 
            background: #131a21; 
            border-color: #2a3847; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .match::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        .match:hover::before {
            left: 100%;
        }
        .match.active {
            background: linear-gradient(135deg, #1a222c, #131a21);
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(247, 147, 26, 0.3);
            transform: translateY(-2px);
        }
        .match.active::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--accent);
            font-weight: bold;
            font-size: 14px;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π */
        .selected-candles-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b35, #ff8c42);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 6px 16px rgba(255, 107, 53, 0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4); }
        }
        .match .hdr { display: flex; justify-content: space-between; align-items: center; }
        .match .range { font-size: 11px; color: var(--muted); }
        .badge { 
            padding: 4px 8px; 
            border-radius: 999px; 
            font-size: 11px; 
            font-weight: 700; 
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .badge.up { 
            background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.1)); 
            color: var(--green); 
            border-color: rgba(34,197,94,0.3);
            box-shadow: 0 2px 8px rgba(34,197,94,0.2);
        }
        .badge.down { 
            background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.1)); 
            color: var(--red); 
            border-color: rgba(239,68,68,0.3);
            box-shadow: 0 2px 8px rgba(239,68,68,0.2);
        }

        .footer-note { font-size: 11px; color: var(--muted); text-align: center; padding-top: 4px; }
        
        /* –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ */
        .pattern-distribution {
            margin: 12px 0;
            display: grid;
            gap: 8px;
        }
        
        .distribution-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .distribution-label {
            flex: 1;
            color: var(--muted);
            font-weight: 500;
        }
        
        .distribution-bar {
            flex: 2;
            height: 8px;
            background: var(--bg-2);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .distribution-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
            position: relative;
        }
        
        .distribution-fill.bullish {
            background: linear-gradient(90deg, #22c55e, #16a34a);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
        }
        
        .distribution-fill.bearish {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }
        
        .distribution-value {
            min-width: 30px;
            text-align: right;
            color: var(--text);
            font-weight: 600;
            font-size: 11px;
        }
        
        /* –ù–µ–¥–∞–≤–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã */
        .recent-patterns {
            display: grid;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .recent-pattern {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .recent-pattern:hover {
            background: var(--bg-3);
            border-color: #334153;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .recent-pattern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s ease;
        }
        
        .recent-pattern:hover::before {
            left: 100%;
        }
        
        .recent-pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .recent-pattern-dates {
            font-size: 11px;
            color: var(--muted);
        }
        
        .recent-pattern-direction {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .recent-pattern-direction.bullish {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .recent-pattern-direction.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .recent-pattern-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 11px;
        }
        
        .recent-pattern-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recent-pattern-stat-label {
            color: var(--muted);
        }
        
        .recent-pattern-stat-value {
            color: var(--text);
            font-weight: 600;
        }
        
        .recent-pattern-stat-value.positive {
            color: var(--green);
        }
        
        .recent-pattern-stat-value.negative {
            color: var(--red);
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ */
        .general-analysis-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--muted);
        }
        
        .general-analysis-loading i {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }
        
        /* –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ */
        .mini-chart-container {
            margin: 12px 0;
            padding: 8px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
        }
        
        .mini-chart-container canvas {
            border-radius: 4px;
            background: var(--bg-3);
        }
        
        .mini-chart-label {
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px;
            font-weight: 500;
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ */
        .performance-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: grid;
            gap: 8px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .summary-label {
            color: var(--muted);
            font-weight: 500;
        }
        
        .summary-value {
            font-weight: 600;
            font-size: 13px;
        }
        
        .summary-value.bullish {
            color: var(--green);
        }
        
        .summary-value.bearish {
            color: var(--red);
        }

        
        .chart-controls {
            display: none;
            position: absolute;
            bottom: 12px;
            left: 12px;
            right: 12px;
            background: rgba(17, 22, 28, 0.95);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            z-index: 50;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        .chart-controls.visible {
            display: flex;
            flex-direction: row;
            gap: 8px;
            align-items: center;
        }
        .chart-controls.collapsed {
            left: 50%;
            right: auto;
            transform: translateX(-50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chart-controls.collapsed .control-btn {
            display: none;
        }
        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 14px;
            background: #1a222c;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: 500;
            flex: 1;
        }
        .control-btn:hover {
            background: #212a34;
            border-color: #334153;
        }
        .control-btn i {
            font-size: 14px;
            width: 18px;
            text-align: center;
        }
        .toggle-controls-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: var(--accent);
            border: 1px solid #ffb547;
            border-radius: 8px;
            color: #0c0f12;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            min-width: 38px;
            flex-shrink: 0;
        }
        .toggle-controls-btn:hover {
            background: #ffb547;
        }
        .chart-controls.collapsed .toggle-controls-btn {
            border-radius: 50%;
            width: 100%;
            height: 100%;
            min-width: 48px;
        }

        /* Mobile bottom navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-1);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px 16px;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(17, 22, 28, 0.9);
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 24px;
            font-size: 13px;
            color: #ffffff;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            font-weight: 600;
        }
        .nav-btn.active {
            color: var(--accent);
            background: rgba(247, 147, 26, 0.1);
        }
        .nav-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        #nav-analysis {
            background: #22c55e !important;
            border: 1px solid #16a34a;
        }
        #nav-analysis:hover {
            background: #16a34a !important;
        }
        #nav-volume {
            background: #1a222c !important;
            border: 1px solid var(--border);
        }
        #nav-volume:hover {
            background: #212a34 !important;
        }
        #nav-clear {
            background: #dc2626 !important;
            border: 1px solid #b91c1c;
        }
        #nav-clear:hover {
            background: #b91c1c !important;
        }

        /* Modal for patterns */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(7, 11, 15, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--panel);
            border-radius: 12px;
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        /* Clear Modal Styles */
        .clear-modal-content {
            max-width: 450px;
            text-align: center;
        }
        
        .clear-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }
        
        .clear-icon i {
            font-size: 32px;
            color: #ffffff;
        }
        
        .clear-modal-content h3 {
            margin: 0 0 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
        }
        
        .clear-modal-content p {
            margin: 0 0 24px;
            font-size: 14px;
            color: var(--muted);
            line-height: 1.5;
        }
        
        .clear-stats {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin: 0 0 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }
        
        .clear-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .btn.clear-confirm {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .btn.clear-confirm:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        }
        
        .btn.clear-cancel {
            background: var(--bg-2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn.clear-cancel:hover {
            background: var(--bg-3);
            border-color: #334153;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title {
            font-weight: 600;
            font-size: 16px;
        }
        .close-modal {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .close-modal:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        /* Overlay + toast */
        .loading {
            position: fixed; 
            inset: 0; 
            display: none; 
            align-items: center; 
            justify-content: center;
            background: rgba(3,6,9,0.55); 
            backdrop-filter: blur(2px); 
            z-index: 50;
        }
        .spinner { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: 3px solid rgba(255,255,255,0.12); 
            border-top-color: var(--accent); 
            animation: spin 0.9s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { 
            position: fixed; 
            bottom: 70px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #111821; 
            border: 1px solid #223041; 
            color: #e3edf7; 
            padding: 10px 14px; 
            border-radius: 10px; 
            font-size: 13px; 
            display: none; 
            z-index: 60;
            max-width: 80%;
            text-align: center;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .app {
                display: grid;
                grid-template-rows: auto 1fr;
            }
            
            .main {
                display: grid;
                grid-template-columns: 1fr 320px;
                gap: 12px;
                padding: 12px;
                overflow: hidden;
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
            #nav-analysis-overlay {
                display: none !important;
            }
            
            .panel {
                margin: 0;
            }
            
            .side {
                display: flex;
                padding: 0;
                overflow-y: auto;
            }
            
            .mobile-nav {
                display: none;
            }
            
            .topbar {
                padding: 16px 20px;
            }
            
            .brand .logo {
                width: 28px; 
                height: 28px;
            }
            
            .brand .title {
                font-size: 16px;
            }
            
            .kpis {
                gap: 16px;
                font-size: 13px;
            }
            
            .toolbar {
                padding: 10px 12px;
            }
            
            .btn {
                padding: 8px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            .chart-controls {
                bottom: 80px;
            }
            
            .chart-controls.collapsed {
                bottom: 80px;
            }
            
            .control-btn span {
                display: none;
            }
            
            .control-btn {
                padding: 8px;
                min-width: 40px;
                justify-content: center;
            }
            
            /* Hide desktop action buttons on mobile (use mobile-nav instead) */
            #toggle-volume-btn, #analyze-btn, #clear-btn {
                display: none !important;
            }
        }

        @media (max-width: 380px) {
            .toolbar {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .left-tools, .right-tools {
                flex-wrap: wrap;
            }
            
            .btn {
                font-size: 11px;
                padding: 5px 6px;
            }
            
            .counter {
                font-size: 11px;
            }
            
            .chart-controls {
                gap: 6px;
                padding: 8px;
                left: 8px;
                right: 8px;
            }
            
            .chart-controls.collapsed {
                width: 44px;
                height: 44px;
            }
            
            .control-btn {
                padding: 6px;
                min-width: 36px;
            }
            
            .toggle-controls-btn {
                padding: 6px;
                min-width: 34px;
                font-size: 14px;
            }
            
            .chart-controls.collapsed .toggle-controls-btn {
                min-width: 44px;
            }
        }

        .symbol-selector {
            margin-left: 15px;
        }

        .symbol-select {
            background: #1a222c;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            min-width: 120px;
        }

        .symbol-select option {
            background: var(--bg-2);
            color: var(--text);
        }

        .update-status {
            font-size: 12px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="topbar">
            <div class="brand">
                <div class="logo"></div>
                <!-- –í —Ä–∞–∑–¥–µ–ª–µ .brand, –ø–æ—Å–ª–µ .title -->
                <div class="title" id="page-title">–ü–æ–∏—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</div>
                <div class="symbol-selector">
                    <select id="symbol-select" class="symbol-select">
                        <option value="BTC#USDT">BTC/USDT</option>
                        <option value="ETH#USDT">ETH/USDT</option>
                        <option value="XRP#USDT">XRP/USDT</option>
                        <option value="SOL#USDT">SOL/USDT</option>
                        <option value="BNB#USDT">BNB/USDT</option>
                        <option value="TRX#USDT">TRX/USDT</option>
                        <option value="ADA#USDT">ADA/USDT</option>
                        <option value="SUI#USDT">SUI/USDT</option>
                        <option value="LINK#USDT">LINK/USDT</option>
                        <option value="LTC#USDT">LTC/USDT</option>
                        <option value="TON#USDT">TON/USDT</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="main">
            <div class="panel">
                <div class="toolbar">
                    <div class="left-tools">
                        <div class="tf">
                            <button class="btn" data-tf="1h">1 —á–∞—Å</button>
                            <button class="btn" data-tf="4h">4 —á–∞—Å–∞</button>
                            <button class="btn active" data-tf="1d">1 –¥–µ–Ω—å</button>
                            <button class="btn" data-tf="1w">1 –Ω–µ–¥–µ–ª—è</button>
                        </div>
                        <div class="right-tools">
                            <button id="toggle-volume-btn" class="btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ–±—ä–µ–º">
                                <i class="fas fa-chart-bar"></i> –û–±—ä–µ–º
                            </button>
                            <!-- <button id="reset-view-btn" class="btn">–°–±—Ä–æ—Å</button> -->
                            <button id="analyze-btn" class="btn analyze" disabled>
                                <i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏–∑
                            </button>
                            <button id="clear-btn" class="btn clear">
                                <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                            <!-- <button id="test-update-btn" class="btn" style="background: #8b5cf6;">
                                <i class="fas fa-bolt"></i> –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            </button> -->
                        </div>
                    </div>
                </div>
                <div class="chart-wrap">
                    <div id="chart"></div>
                    <!-- Chart Controls Overlay -->
                    <div class="chart-controls" id="chart-controls">
                        <button class="control-btn" id="nav-prev">
                            <i class="fas fa-chevron-left"></i>
                            <span>–ù–∞–∑–∞–¥</span>
                        </button>
                        <button class="control-btn" id="nav-next">
                            <i class="fas fa-chevron-right"></i>
                            <span>–í–ø–µ—Ä–µ–¥</span>
                        </button>
                        <button class="control-btn" id="nav-to-selected">
                            <i class="fas fa-search"></i>
                            <span>–ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º</span>
                        </button>
                        <button class="control-btn" id="nav-analysis-overlay">
                            <i class="fas fa-chart-line"></i>
                            <span>–ê–Ω–∞–ª–∏–∑</span>
                        </button>
                        <button class="control-btn" id="nav-patterns">
                            <i class="fas fa-shapes"></i>
                            <span>–ü–∞—Ç—Ç–µ—Ä–Ω—ã</span>
                        </button>
                        <button class="toggle-controls-btn" id="toggle-controls-btn" title="–°–≤–µ—Ä–Ω—É—Ç—å/–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="side" id="side-panel">
                <!-- –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ -->
                <div class="card" id="general-analysis-card">
                    <h3>–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</h3>
                    <div class="stat-list" id="general-stats">
                        <div class="stat"><span>–í—Å–µ–≥–æ —Å–≤–µ—á–µ–π</span><span class="val" id="total-candles">-</span></div>
                        <div class="stat"><span>–ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö</span><span class="val" id="data-period">-</span></div>
                        <div class="stat"><span>–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</span><span class="val" id="volatility">-</span></div>
                        <div class="stat"><span>–°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º</span><span class="val" id="avg-volume">-</span></div>
                    </div>
                    <div class="pattern-distribution">
                        <div class="distribution-item">
                            <span class="distribution-label">–ë—ã—á—å–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</span>
                            <div class="distribution-bar">
                                <div class="distribution-fill bullish" id="bullish-bar"></div>
                            </div>
                            <span class="distribution-value" id="bullish-count">0</span>
                        </div>
                        <div class="distribution-item">
                            <span class="distribution-label">–ú–µ–¥–≤–µ–∂—å–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</span>
                            <div class="distribution-bar">
                                <div class="distribution-fill bearish" id="bearish-bar"></div>
                            </div>
                            <span class="distribution-value" id="bearish-count">0</span>
                        </div>
                    </div>
                    <div class="mini-chart-container" id="mini-chart-container" style="display: none;">
                        <canvas id="mini-chart" width="280" height="80"></canvas>
                        <div class="mini-chart-label">–¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</div>
                    </div>
                    <!-- <button class="btn analyze" id="load-general-analysis" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-chart-pie"></i> –ê–Ω–∞–ª–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
                    </button> -->
                </div>
                
                <!-- –ù–µ–¥–∞–≤–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã -->
                <div class="card" id="recent-patterns-card" style="display:none">
                    <h3>–ù–µ–¥–∞–≤–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</h3>
                    <div class="recent-patterns" id="recent-patterns-list"></div>
                </div>
                
                <div class="card">
                    <h3>–ò—Ç–æ–≥–∏ –∞–Ω–∞–ª–∏–∑–∞</h3>
                    <div class="stat-list">
                        <div class="stat"><span>–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</span><span class="val" id="matches-found">0</span></div>
                        <div class="stat"><span>–î–ª–∏–Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞</span><span class="val" id="pattern-length">0</span></div>
                    </div>
                    <div class="footer-note">–í—ã–±–µ—Ä–∏—Ç–µ 1‚Äì6 —Å–≤–µ—á–µ–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑</div>
                </div>
                <div class="card" id="pattern-info-card" style="display:none">
                    <h3>–ü–∞—Ç—Ç–µ—Ä–Ω</h3>
                    <div class="stat-list" id="pattern-info"></div>
                </div>
                <div class="card">
                    <h3>–°–æ–≤–ø–∞–¥–µ–Ω–∏—è</h3>
                    <div class="matches" id="matches"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <button class="nav-btn" id="nav-volume">
            <i class="fas fa-chart-bar"></i>
            <span>–û–±—ä–µ–º</span>
        </button>
        <button class="nav-btn" id="nav-analysis">
            <i class="fas fa-chart-line"></i>
            <span>–ê–Ω–∞–ª–∏–∑</span>
        </button>
        <button class="nav-btn" id="nav-clear">
            <i class="fas fa-trash"></i>
            <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
        </button>
    </div>

    <!-- Patterns Modal -->
    <div class="modal" id="patterns-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="pattern-stats" id="modal-pattern-stats" style="margin-bottom: 16px; padding: 12px; background: var(--bg-2); border-radius: 8px; border: 1px solid var(--border);">
                    <!-- Pattern statistics will be inserted here -->
                </div>
                <div id="modal-patterns-list">
                    <!-- Patterns will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Confirmation Modal -->
    <div class="modal" id="clear-confirmation-modal">
        <div class="modal-content clear-modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-trash-alt" style="margin-right: 8px; color: #dc2626;"></i>
                    –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
                </div>
                <button class="close-modal" id="close-clear-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="clear-modal-content">
                    <div class="clear-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <h3>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?</h3>
                    <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Å–±—Ä–æ—Å–∏—Ç –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—á–∏ –∏ –∞–Ω–∞–ª–∏–∑. –í—ã —Å–º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.</p>
                    <div class="clear-actions">
                        <button class="btn clear-confirm" id="confirm-clear-btn">
                            <i class="fas fa-sync-alt"></i>
                            <span>–î–∞, –æ–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                        <button class="btn clear-cancel" id="cancel-clear-btn">
                            <i class="fas fa-times"></i>
                            <span>–û—Ç–º–µ–Ω–∞</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
		// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è textContent
        function safeSetTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        function safeSetInnerHTML(elementId, html) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = html;
            }
        }

        function safeSetStyle(elementId, property, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style[property] = value;
            }
        }

class SmartChartUpdater {
    constructor(chartInstance) {
        this.chart = chartInstance;
        this.lastKnownTimestamp = null;
        this.updateIntervals = {
            '1h': 3600000,    // 1 —á–∞—Å
            '4h': 14400000,   // 4 —á–∞—Å–∞  
            '1d': 86400000,   // 1 –¥–µ–Ω—å
            '1w': 604800000   // 1 –Ω–µ–¥–µ–ª—è
        };
        this.isUpdating = false;
        this.updateTimer = null;
        this.retryCount = 0;
        this.maxRetries = 2;
        this.symbol = 'BTC#USDT';
        this.timeframe = '1d';
        this.hasPerformedInitialUpdate = false;
        this.lastUpdateTime = null;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    initialize(symbol, timeframe) {
        console.log(`üîÑ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø: ${symbol}, ${timeframe}`);
        this.symbol = symbol;
        this.timeframe = timeframe;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∞–π–º—Å—Ç–∞–º–ø
        if (this.chart.allCandles && this.chart.allCandles.length > 0) {
            this.lastKnownTimestamp = this.chart.allCandles[this.chart.allCandles.length - 1].open_time;
            console.log(`üìÖ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–≤–µ—á–∞: ${this.lastKnownTimestamp}`);
        }
        
        // –ó–ê–ü–£–°–ö–ê–ï–ú –¢–û–õ–¨–ö–û –ü–ï–†–í–ò–ß–ù–£–Æ –ü–†–û–í–ï–†–ö–£
        this.performInitialUpdate();
    }

    // –ü–µ—Ä–≤–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async performInitialUpdate() {
        if (this.hasPerformedInitialUpdate) {
            console.log('‚è≠Ô∏è –ü–µ—Ä–≤–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
            return;
        }

        console.log('üîç –í–´–ü–û–õ–ù–ï–ù–ò–ï –ü–ï–†–í–ò–ß–ù–û–ì–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø...');
        
        try {
            const freshness = this.checkDataFreshness();
            console.log(`üîç –°—Ç–∞—Ç—É—Å —Å–≤–µ–∂–µ—Å—Ç–∏: ${freshness}`);
            
            if (freshness === 'stale') {
                console.log('üîÑ –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
                await this.guaranteedDataRefresh();
            } else {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–∏–µ, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–±–æ–ª—å—à–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...');
                const updateCheck = await this.checkForUpdates();
                
                if (updateCheck.has_updates && updateCheck.new_candles_count > 0) {
                    console.log(`üÜï –ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${updateCheck.new_candles_count} —Å–≤–µ—á–µ–π`);
                    await this.loadAndApplyUpdates();
                } else {
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã');
                }
            }
            
            this.hasPerformedInitialUpdate = true;
            this.lastUpdateTime = new Date();
            this.retryCount = 0;
            
            // –ó–ê–ü–£–°–ö–ê–ï–ú –î–û–õ–ì–û–°–†–û–ß–ù–´–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –ü–ï–†–í–ò–ß–ù–û–ì–û
            this.startLongTermUpdates();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –ø–µ—Ä–≤–∏—á–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', error);
            this.hasPerformedInitialUpdate = true;
        }
    }

    // –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ä–µ–¥–∫–∏–µ)
    startLongTermUpdates() {
        if (this.updateTimer) {
            clearInterval(this.updateTimer);
        }
        
        const longTermIntervals = {
            '1h': 300000,    // 5 –º–∏–Ω—É—Ç
            '4h': 900000,    // 15 –º–∏–Ω—É—Ç  
            '1d': 3600000,   // 1 —á–∞—Å
            '1w': 43200000   // 12 —á–∞—Å–æ–≤
        };
        
        const interval = longTermIntervals[this.timeframe] || 3600000;
        console.log(`‚è∞ –ó–∞–ø—É—Å–∫ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ ${interval/60000} –º–∏–Ω—É—Ç`);
        
        this.updateTimer = setInterval(() => {
            this.smartUpdate();
        }, interval);
    }

    // –£–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫)
    async smartUpdate() {
        if (this.isUpdating) {
            console.log('‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —Ä–∞–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        if (this.lastUpdateTime && (Date.now() - this.lastUpdateTime < 60000)) {
            console.log('‚è∞ –°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
            return;
        }
        
        this.isUpdating = true;
        
        try {
            console.log('üîç –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...');
            const updateCheck = await this.checkForUpdates();
            
            if (updateCheck.has_updates && updateCheck.new_candles_count > 0) {
                console.log(`üÜï –ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${updateCheck.new_candles_count} —Å–≤–µ—á–µ–π`);
                await this.loadAndApplyUpdates();
            } else {
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã (–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)');
            }
            
            this.lastUpdateTime = new Date();
            this.retryCount = 0;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', error);
            this.retryCount++;
            
            if (this.retryCount >= this.maxRetries) {
                console.error('üö® –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ');
                this.stop();
            }
        } finally {
            this.isUpdating = false;
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
    checkDataFreshness() {
        if (!this.lastKnownTimestamp) return 'unknown';
        
        const lastKnown = new Date(this.lastKnownTimestamp);
        const now = new Date();
        const diffHours = (now - lastKnown) / (1000 * 60 * 60);
        
        console.log(`‚è∞ –í–æ–∑—Ä–∞—Å—Ç –¥–∞–Ω–Ω—ã—Ö: ${diffHours.toFixed(1)} —á–∞—Å–æ–≤`);
        
        // –ë–û–õ–ï–ï –õ–û–Ø–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
        const maxAgeHours = {
            '1h': 2,    // 2 —á–∞—Å–∞ –¥–ª—è —á–∞—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            '4h': 4,    // 4 —á–∞—Å–∞ –¥–ª—è 4-—á–∞—Å–æ–≤—ã—Ö
            '1d': 6,    // 6 —á–∞—Å–æ–≤ –¥–ª—è –¥–Ω–µ–≤–Ω—ã—Ö
            '1w': 24    // 24 —á–∞—Å–∞ –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω—ã—Ö
        };
        
        const maxAge = maxAgeHours[this.timeframe] || 6;
        
        if (diffHours > maxAge) {
            console.log(`üîÑ –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ ${maxAge} —á–∞—Å–æ–≤`);
            return 'stale';
        } else {
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã');
            return 'fresh';
        }
    }

    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    async guaranteedDataRefresh() {
        console.log('üîÑ –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•...');
        
        try {
            this.updateDataStatus('updating', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
            
            const response = await fetch('/api/pattern/refresh_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbol: this.symbol,
                    timeframe: this.timeframe
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –£–°–ü–ï–®–ù–û:', result);
                
                // –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–ú –î–ê–ù–ù–´–ï –ù–ê –ì–†–ê–§–ò–ö–ï
                await this.reloadChartData();
                
                // –°–ë–†–ê–°–´–í–ê–ï–ú –¢–ê–ô–ú–°–¢–ê–ú–ü –î–õ–Ø –ü–†–û–í–ï–†–ö–ò
                this.lastKnownTimestamp = null;
                if (this.chart.allCandles && this.chart.allCandles.length > 0) {
                    this.lastKnownTimestamp = this.chart.allCandles[this.chart.allCandles.length - 1].open_time;
                }
                
                // this.updateDataStatus('fresh', `–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${result.fresh_data_count} –∑–∞–ø–∏—Å–µ–π`);
                
            } else {
                throw new Error(result.message || 'Unknown error');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
            this.updateDataStatus('stale', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            throw error;
        }
    }

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞
    async reloadChartData() {
        console.log('üîÑ –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ì–†–ê–§–ò–ö–ê...');
        
        if (!this.chart.loadData) {
            throw new Error('Chart loadData method not available');
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        const hadSelection = this.chart.selectedIndices && this.chart.selectedIndices.size > 0;
        const selectedIndices = hadSelection ? [...this.chart.selectedIndices] : [];
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        await this.chart.loadData();
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        if (hadSelection && selectedIndices.length > 0) {
            this.chart.selectedIndices.clear();
            selectedIndices.forEach(idx => {
                if (idx < this.chart.allCandles.length) {
                    this.chart.selectedIndices.add(idx);
                }
            });
            this.chart.updateSelected();
            console.log(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ: ${this.chart.selectedIndices.size} —Å–≤–µ—á–µ–π`);
        }
        
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    async loadAndApplyUpdates() {
        try {
            const newData = await this.loadIncrementalData();
            
            if (newData && newData.has_updates && newData.new_candles && newData.new_candles.length > 0) {
                await this.updateChartWithNewData(newData.new_candles);
                this.lastKnownTimestamp = newData.latest_timestamp;
                
                console.log(`‚úÖ –ì—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω: ${newData.new_candles.length} –Ω–æ–≤—ã—Ö —Å–≤–µ—á–µ–π`);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    async checkForUpdates() {
        try {
            if (!this.lastKnownTimestamp) {
                return { has_updates: false, message: 'No last known timestamp' };
            }

            const url = `/api/pattern/check_updates?symbol=${encodeURIComponent(this.symbol)}&timeframe=${this.timeframe}&last_known=${encodeURIComponent(this.lastKnownTimestamp)}`;
            console.log('üîó URL –ø—Ä–æ–≤–µ—Ä–∫–∏:', url);
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            return result;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
            return { has_updates: false, error: error.message };
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async loadIncrementalData() {
        try {
            if (!this.lastKnownTimestamp) {
                return { has_updates: false, message: 'No last known timestamp' };
            }

            const url = `/api/pattern/incremental_update?symbol=${encodeURIComponent(this.symbol)}&timeframe=${this.timeframe}&last_known=${encodeURIComponent(this.lastKnownTimestamp)}`;
            console.log('üîó URL –∑–∞–≥—Ä—É–∑–∫–∏:', url);
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            return result;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
            return { has_updates: false, error: error.message };
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    async updateChartWithNewData(newCandles) {
        if (!this.chart || !this.chart.allCandles) {
            console.error('‚ùå –ì—Ä–∞—Ñ–∏–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            return;
        }
        
        console.log(`üîÑ –î–æ–±–∞–≤–ª—è–µ–º ${newCandles.length} –Ω–æ–≤—ã—Ö —Å–≤–µ—á–µ–π`);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–≤–µ—á–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–∞–Ω–Ω—ã–º
        let addedCount = 0;
        newCandles.forEach(newCandle => {
            const exists = this.chart.allCandles.some(candle => 
                candle.open_time === newCandle.open_time
            );
            
            if (!exists) {
                this.chart.allCandles.push(newCandle);
                addedCount++;
            }
        });
        
        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} –Ω–æ–≤—ã—Ö —Å–≤–µ—á–µ–π –∏–∑ ${newCandles.length}`);
        
        if (addedCount === 0) {
            console.log('‚ÑπÔ∏è –í—Å–µ —Å–≤–µ—á–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –≥—Ä–∞—Ñ–∏–∫–µ');
            return;
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
        this.chart.allCandles.sort((a, b) => new Date(a.open_time) - new Date(b.open_time));
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const candleData = this.chart.allCandles.map(c => ({
            time: Math.floor(new Date(c.open_time).getTime() / 1000),
            open: parseFloat(c.open_price),
            high: parseFloat(c.high),
            low: parseFloat(c.low),
            close: parseFloat(c.close_price),
        }));
        
        const volumeData = this.chart.allCandles.map(c => ({
            time: Math.floor(new Date(c.open_time).getTime() / 1000),
            value: parseFloat(c.volume),
            color: (parseFloat(c.close_price) >= parseFloat(c.open_price)) ? 'rgba(34,197,94,0.25)' : 'rgba(239,68,68,0.25)'
        }));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
        try {
            this.chart.candleSeries.setData(candleData);
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–≤–µ—á–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            
            if (this.chart.volumeVisible) {
                this.chart.volumeSeries.setData(volumeData);
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º
            if (addedCount > 0) {
                const lastCandle = this.chart.allCandles[this.chart.allCandles.length - 1];
                const lastTime = Math.floor(new Date(lastCandle.open_time).getTime() / 1000);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                this.chart.chart.timeScale().setVisibleRange({
                    from: lastTime - 7 * 24 * 60 * 60, // 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
                    to: lastTime + 24 * 60 * 60 // +1 –¥–µ–Ω—å
                });
                
                console.log('üéØ –ì—Ä–∞—Ñ–∏–∫ —Å–¥–≤–∏–Ω—É—Ç –∫ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º');
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
            this.chart.redrawOverlay();
            
            console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞:', error);
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–∞–Ω–Ω—ã—Ö
    updateDataStatus(status, message = '') {
        console.log(`üìä –°—Ç–∞—Ç—É—Å –¥–∞–Ω–Ω—ã—Ö: ${status} - ${message}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        const statusElement = document.getElementById('update-status');
        if (statusElement) {
            if (status === 'updating') {
                statusElement.innerHTML = '<i class="fas fa-sync fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
                statusElement.style.display = 'flex';
            } else if (status === 'fresh') {
                statusElement.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                statusElement.style.display = 'flex';
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            } else {
                statusElement.style.display = 'none';
            }
        }
        
        if (this.chart.toast) {
            this.chart.toast(message);
        }
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    stop() {
        if (this.updateTimer) {
            console.log('‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π');
            clearInterval(this.updateTimer);
            this.updateTimer = null;
        }
    }

    // –°–º–µ–Ω–∞ —Å–∏–º–≤–æ–ª–∞/—Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
    changeSymbol(symbol, timeframe) {
        this.symbol = symbol;
        this.timeframe = timeframe;
        this.lastKnownTimestamp = null;
        this.hasPerformedInitialUpdate = false;
        this.stop();
        this.performInitialUpdate();
    }
}

class PatternChart {
    constructor() {
        this.chart = null;
        this.candleSeries = null;
        this.volumeSeries = null;
        this.volumeVisible = true;
        this.allCandles = [];
        this.selectedIndices = new Set();
        this.selectedMarkers = new Map();
        this.patternMarkers = new Map();
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const savedTimeframe = localStorage.getItem('savedTimeframe');
        this.currentTimeframe = savedTimeframe || '1d';
        
        // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        if (savedTimeframe) {
            localStorage.removeItem('savedTimeframe');
        }

        const savedSymbol = localStorage.getItem('savedSymbol');
        this.currentSymbol = savedSymbol || 'BTC#USDT';
        
        // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        if (savedSymbol) {
            localStorage.removeItem('savedSymbol');
        }
        
        this.dataInitiallyLoaded = false;
        this.chartUpdater = new SmartChartUpdater(this);
        
        this.initChart();
        this.loadData();
        this.bindUI();
        this.toastEl = null;
        this.overlay = null;
        this.matchedHighlightPoints = [];
        this.selectedHighlightPoints = [];
        this.currentMatchIndex = -1;
        this.matchedRanges = [];
        this.isAnalysisMode = false;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    initChart() {
        const el = document.getElementById('chart');
        this.chart = LightweightCharts.createChart(el, {
            width: el.clientWidth,
            height: el.clientHeight,
            layout: { backgroundColor: '#0a0f14', textColor: '#d6dee6', fontFamily: 'Inter' },
            grid: { vertLines: { color: 'rgba(32,42,54,0.85)' }, horzLines: { color: 'rgba(32,42,54,0.85)' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Magnet, vertLine: { color: '#3a4654' }, horzLine: { color: '#3a4654' } },
            rightPriceScale: { borderColor: '#243142' },
            timeScale: { 
                borderColor: '#243142', 
                rightOffset: 6, 
                barSpacing: 14,
                minBarSpacing: 3,
                fixLeftEdge: false,
                fixRightEdge: false,
                lockVisibleTimeRangeOnResize: true,
                shiftVisibleRangeOnNewBar: true,
                timeVisible: true,
                secondsVisible: false
            },
            handleScroll: { 
                mouseWheel: true, 
                pressedMouseMove: true,
                horzTouchDrag: true,
                vertTouchDrag: true
            },
            handleScale: { 
                axisPressedMouseMove: { time: true, price: true },
                axisDoubleClickReset: { time: true, price: true },
                mouseWheel: true,
                pinch: true
            },
            kineticScroll: {
                touch: true,
                mouse: true
            }
        });
        
        this.candleSeries = this.chart.addCandlestickSeries({
            upColor: '#21d07a',
            downColor: '#f04444',
            borderUpColor: '#1ac46f',
            borderDownColor: '#e73c3c',
            wickUpColor: '#24e084',
            wickDownColor: '#ff5050',
            priceLineVisible: false,
        });
        
        // –£–ª—É—á—à–µ–Ω–Ω—ã–π –∑—É–º –º—ã—à—å—é: –∑—É–º –∫ –∫—É—Ä—Å–æ—Ä—É, –±–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π, —Å –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ Shift+–∫–æ–ª–µ—Å–∏–∫—É
        (function enhanceWheelZoom(chart, el) {
            const baseZoom = 1.08; // –º—è–≥—á–µ
            let lastTs = 0;
            el.addEventListener('wheel', (evt) => {
                const now = Date.now();
                if (now - lastTs < 16) return; // ~60fps
                lastTs = now;
                const ts = chart.timeScale();
                if (!ts) return;

                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Ä–∞–±–æ—Ç–∞–µ–º —Å–∞–º–∏
                evt.preventDefault();

                const range = ts.getVisibleRange && ts.getVisibleRange();
                if (!range || typeof range.from !== 'number' || typeof range.to !== 'number') return;

                const total = range.to - range.from;

                // 1) –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞: Shift+–∫–æ–ª–µ—Å–æ –ò–õ–ò –∫–æ–ª–µ—Å–æ-–≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ (deltaX)
                const isPanX = evt.shiftKey || (Math.abs(evt.deltaX) > Math.abs(evt.deltaY));
                if (isPanX) {
                    const raw = Math.abs(evt.deltaX) > Math.abs(evt.deltaY) ? evt.deltaX : evt.deltaY;
                    const direction = Math.sign(raw) || 1; // + –≤–ø—Ä–∞–≤–æ, - –≤–ª–µ–≤–æ
                    const step = Math.min(2.5, Math.max(0.5, Math.abs(raw) / 180));
                    const shift = total * 0.06 * step * direction;
                    ts.setVisibleRange({ from: range.from + shift, to: range.to + shift });
                    return;
                }

                // –ó—É–º –∫ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
                const cursorX = (typeof evt.offsetX === 'number') ? evt.offsetX : 0;
                let focusTime = undefined;
                if (typeof ts.coordinateToTime === 'function') {
                    focusTime = ts.coordinateToTime(cursorX);
                }
                if (typeof focusTime !== 'number') {
                    // –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–∫—É —Ñ–æ–∫—É—Å–∞ ‚Äî –∑—É–º –ø—Ä–æ—Å—Ç–æ –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞
                    focusTime = (range.from + range.to) / 2;
                }

                // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑—É–º–∞ —Å —É—á—ë—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ Ctrl/‚åò –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                const magnitude = Math.min(2.0, Math.max(0.5, Math.abs(evt.deltaY) / 240));
                const turbo = (evt.ctrlKey || evt.metaKey) ? 1.2 : 1.0;
                const zoomFactor = Math.pow(baseZoom * turbo, magnitude);
                const zoomIn = evt.deltaY < 0; // –∫–æ–ª—ë—Å–∏–∫–æ –≤–≤–µ—Ä—Ö ‚Äî –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ

                const left = Math.max(1e-6, focusTime - range.from);
                const right = Math.max(1e-6, range.to - focusTime);

                let newLeft, newRight;
                if (zoomIn) {
                    newLeft = left / zoomFactor;
                    newRight = right / zoomFactor;
                } else {
                    newLeft = left * zoomFactor;
                    newRight = right * zoomFactor;
                }

                // –û–≥—Ä–∞–Ω–∏—á–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞, —á—Ç–æ–±—ã –Ω–µ ¬´–∑–∞–ª–∏–ø–∞—Ç—å¬ª
                const minSpan = Math.max(2, total * 0.0005);
                const newFrom = focusTime - newLeft;
                const newTo = focusTime + newRight;
                if ((newTo - newFrom) < minSpan) return;

                ts.setVisibleRange({ from: newFrom, to: newTo });
            }, { passive: false });
        })(this.chart, el);
        
        this.volumeSeries = this.chart.addHistogramSeries({
            priceScaleId: '',
            scaleMargins: { top: 0.85, bottom: 0 },
            priceFormat: { type: 'volume' },
        });

        this.chart.subscribeClick(this.onClick.bind(this));
        window.addEventListener('resize', () => { 
            this.chart.applyOptions({ width: el.clientWidth }); 
            this.resizeOverlay(); 
            this.redrawOverlay(); 
        });
        
        this.ensureOverlay();
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
        this.chart.timeScale().subscribeVisibleTimeRangeChange(() => {
            setTimeout(() => this.redrawOverlay(), 10);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
        this.animationFrame = null;
        this.startAnimation();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async loadData() {
        try {
            console.log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${this.currentSymbol}, –¢–§: ${this.currentTimeframe}`);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã —Å 2017 –≥–æ–¥–∞
            const dsStart = new Date('2017-01-01T00:00:00Z');
            const dsEnd = new Date();
            
            // –î–æ–±–∞–≤–ª—è–µ–º 1 –¥–µ–Ω—å –∫ –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç–µ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
            const nextDay = new Date(dsEnd);
            nextDay.setDate(dsEnd.getDate() + 1);
            
            console.log(`üìÖ –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö: ${dsStart.toISOString().slice(0,10)} - ${nextDay.toISOString().slice(0,10)}`);
            
            // –û–ß–ò–°–¢–ö–ê –ü–†–ï–î–´–î–£–©–ò–• –î–ê–ù–ù–´–•
            this.allCandles = [];
            this.candleSeries.setData([]);
            this.volumeSeries.setData([]);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å–≤–µ—á–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
            const api = await fetch(
                `/api/pattern/ohlcv?source=binance` +
                `&from=${dsStart.toISOString().slice(0,10)}` +
                `&to=${nextDay.toISOString().slice(0,10)}` +
                `&timeframe=${this.currentTimeframe}` +
                `&symbol=${this.currentSymbol}`
            );
            
            if (!api.ok) {
                throw new Error(`HTTP ${api.status}: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å OHLCV`);
            }
            
            const aj = await api.json();
            if (!aj.success) {
                throw new Error(aj.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ OHLCV');
            }
            
            this.allCandles = aj.candles || [];

            if (!Array.isArray(this.allCandles) || this.allCandles.length === 0) {
                throw new Error('–ü—É—Å—Ç–æ–π –Ω–∞–±–æ—Ä —Å–≤–µ—á–µ–π');
            }
            
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.allCandles.length} —Å–≤–µ—á–µ–π`);
            
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤
            this.allCandles = this.allCandles.map(c => ({
                open_time: c.open_time,
                close_time: c.close_time,
                open_price: Number(c.open_price),
                close_price: Number(c.close_price),
                high: Number(c.high),
                low: Number(c.low),
                volume: Number(c.volume),
            }));
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            const k = this.allCandles.map(c => ({
                time: Math.floor(new Date(c.open_time).getTime() / 1000),
                open: c.open_price, 
                high: c.high, 
                low: c.low, 
                close: c.close_price,
            }));
            
            this.candleSeries.setData(k);

            const v = this.allCandles.map(c => ({
                time: Math.floor(new Date(c.open_time).getTime() / 1000),
                value: c.volume,
                color: (c.close_price >= c.open_price) ? 'rgba(34,197,94,0.25)' : 'rgba(239,68,68,0.25)'
            }));
            
            this.volumeSeries.setData(v);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –¥–∞—Ç–∞—Å–µ—Ç–∞
            this.datasetStart = new Date(this.allCandles[0].open_time);
            this.datasetEnd = new Date(this.allCandles[this.allCandles.length - 1].open_time);
            
            console.log(`üìä –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö: ${this.datasetStart.toLocaleDateString()} - ${this.datasetEnd.toLocaleDateString()}`);
            
            // –ü–æ–¥–≥–æ–Ω—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥ –¥–∞–Ω–Ω—ã–µ
            this.chart.timeScale().fitContent();
            
            setTimeout(() => { 
                try { 
                    this.chart.timeScale().fitContent(); 
                } catch(e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ–Ω–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞:', e);
                } 
            }, 0);
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≤–µ—á–µ–π
            setTimeout(() => {
                try {
                    const range = this.chart.timeScale().getVisibleRange();
                    if (range) {
                        const totalRange = range.to - range.from;
                        const visibleRange = totalRange * 0.5; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 50% –¥–∞–Ω–Ω—ã—Ö (–±–æ–ª–µ–µ –æ—Ç–¥–∞–ª—ë–Ω–Ω–æ)
                        this.chart.timeScale().setVisibleRange({
                            from: range.to - visibleRange,
                            to: range.to
                        });
                    }
                    this.redrawOverlay();
                } catch(e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞:', e);
                }
            }, 100);
            
            // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            if (this.allCandles.length > 0) {
                console.log('üöÄ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π');
                
                // –ü–ï–†–í–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–í–ï–ñ–ï–°–¢–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
                if (!this.dataInitiallyLoaded) {
                    this.dataInitiallyLoaded = true;
                    await this.initialFreshnessCheck();
                }
                
                // –ó–ê–ü–£–°–ö –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø
                this.chartUpdater.initialize(this.currentSymbol, this.currentTimeframe);
            }
            
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            this.toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: ' + e.message);
        }
    }
    // –ü–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
    async initialFreshnessCheck() {
        console.log('üîç –ü–ï–†–í–ò–ß–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–í–ï–ñ–ï–°–¢–ò –î–ê–ù–ù–´–•...');
        
        const freshness = this.chartUpdater.checkDataFreshness();
        
        if (freshness === 'stale') {
            console.log('üîÑ –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
            
            // –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –£–°–¢–ê–†–ï–í–®–ò–• –î–ê–ù–ù–´–•
            try {
                await this.chartUpdater.guaranteedDataRefresh();
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
            } catch (error) {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
            }
        }
    }

    // –ü—Ä–∏–≤—è–∑–∫–∞ UI —Å–æ–±—ã—Ç–∏–π
    bindUI() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        const analyzeBtn = document.getElementById('analyze-btn'); 
        if (analyzeBtn) analyzeBtn.addEventListener('click', () => this.analyze());
        
        const clearBtn = document.getElementById('clear-btn'); 
        if (clearBtn) clearBtn.addEventListener('click', () => this.showClearConfirmationModal());
        
        const toggleVolumeBtn = document.getElementById('toggle-volume-btn'); 
        if (toggleVolumeBtn) toggleVolumeBtn.addEventListener('click', () => this.toggleVolume());
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
        document.querySelectorAll('[data-tf]').forEach(b => b.addEventListener('click', (e) => {
            document.querySelectorAll('[data-tf]').forEach(x => x.classList.remove('active'));
            e.target.classList.add('active');
            const newTF = e.target.getAttribute('data-tf');
            if (newTF !== this.currentTimeframe) {
                this.switchTimeframe(newTF);
            }
        }));

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        const navVolume = document.getElementById('nav-volume'); 
        if (navVolume) navVolume.addEventListener('click', () => this.toggleVolume());
        
        const navAnalysis = document.getElementById('nav-analysis'); 
        if (navAnalysis) navAnalysis.addEventListener('click', () => this.analyze());
        
        const navClear = document.getElementById('nav-clear'); 
        if (navClear) navClear.addEventListener('click', () => this.showClearConfirmationModal());
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–º
        const navPrev = document.getElementById('nav-prev'); 
        if (navPrev) navPrev.addEventListener('click', () => this.gotoMatch(-1));
        
        const navNext = document.getElementById('nav-next'); 
        if (navNext) navNext.addEventListener('click', () => this.gotoMatch(1));
        
        const navToSelected = document.getElementById('nav-to-selected'); 
        if (navToSelected) navToSelected.addEventListener('click', () => this.zoomToSelected());
        
        const navAnalysisOverlay = document.getElementById('nav-analysis-overlay'); 
        if (navAnalysisOverlay) navAnalysisOverlay.addEventListener('click', () => this.toggleAnalysisPanel());
        
        const navPatterns = document.getElementById('nav-patterns'); 
        if (navPatterns) navPatterns.addEventListener('click', () => this.showPatternsModal());
        
        const toggleControlsBtn = document.getElementById('toggle-controls-btn'); 
        if (toggleControlsBtn) toggleControlsBtn.addEventListener('click', () => this.toggleChartControls());
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–∏–º–≤–æ–ª–∞
        const symbolSelect = document.getElementById('symbol-select');
        if (symbolSelect) {
            symbolSelect.value = this.currentSymbol;
            symbolSelect.addEventListener('change', (e) => {
                this.switchSymbol(e.target.value);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        document.getElementById('confirm-clear-btn').addEventListener('click', () => {
            localStorage.setItem('savedTimeframe', this.currentTimeframe);
            localStorage.setItem('savedSymbol', this.currentSymbol);
            window.location.reload();
        });
        
        document.getElementById('cancel-clear-btn').addEventListener('click', () => this.hideClearConfirmationModal());
        document.getElementById('close-clear-modal').addEventListener('click', () => this.hideClearConfirmationModal());
        document.querySelector('.close-modal').addEventListener('click', () => this.hidePatternsModal());
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
        document.getElementById('patterns-modal').addEventListener('click', (e) => {
            if (e.target.id === 'patterns-modal') {
                this.hidePatternsModal();
            }
        });
        
        document.getElementById('clear-confirmation-modal').addEventListener('click', (e) => {
            if (e.target.id === 'clear-confirmation-modal') {
                this.hideClearConfirmationModal();
            }
        });
        
        // –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const manualRefreshBtn = document.getElementById('manual-refresh-btn');
        if (manualRefreshBtn) {
            manualRefreshBtn.addEventListener('click', () => this.manualRefreshData());
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –≤ UI
        this.setActiveTimeframe();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
    onClick(param) {
        if (!param || !param.time) return;
        const ts = param.time;
        const idx = this.allCandles.findIndex(c => Math.floor(new Date(c.open_time).getTime()/1000) === ts);
        if (idx === -1) return;
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä —Å–≤–µ—á–µ–π –≤–Ω–µ –≥—Ä–∞–Ω–∏—Ü –¥–∞—Ç–∞—Å–µ—Ç–∞
        const t = new Date(this.allCandles[idx].open_time);
        if (this.datasetStart && this.datasetEnd && (t < this.datasetStart || t > this.datasetEnd)) {
            this.toast('–°–≤–µ—á–∞ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞');
            return;
        }
        
        if (this.selectedIndices.has(idx)) {
            this.selectedIndices.delete(idx);
        } else {
            if (this.selectedIndices.size >= 6) { 
                this.toast('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–∞–∫—Å–∏–º—É–º 6 —Å–≤–µ—á–µ–π'); 
                return; 
            }
            this.selectedIndices.add(idx);
        }
        this.updateSelected();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π
    updateSelected() {
        safeSetTextContent('selected-count', this.selectedIndices.size);
        const analyzeBtn = document.getElementById('analyze-btn'); 
        if (analyzeBtn) analyzeBtn.disabled = this.selectedIndices.size === 0;
        
        this.selectedMarkers.clear();
        this.selectedHighlightPoints = [];
        [...this.selectedIndices].forEach((i, index) => {
            const t = Math.floor(new Date(this.allCandles[i].open_time).getTime()/1000);
            this.selectedMarkers.set(i, { 
                time: t, 
                position: 'aboveBar', 
                color: '#3b82f6', 
                shape: 'circle', 
                text: `${index + 1}`, 
                size: 1.5,
                textColor: '#ffffff',
                backgroundColor: '#3b82f6'
            });
            this.selectedHighlightPoints.push({ time: t, color: '#3b82f6', index: index + 1 });
        });
        this.applyMarkers();
        this.redrawOverlay();
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
    applyMarkers() {
        const sel = Array.from(this.selectedMarkers.values());
        const pats = Array.from(this.patternMarkers.values()).flat();
        this.candleSeries.setMarkers([...sel, ...pats]);
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
    clearSelection() {
        this.selectedIndices.clear();
        this.selectedMarkers.clear();
        this.selectedHighlightPoints = [];
        this.applyMarkers();
        safeSetTextContent('selected-count', '0');
        const analyzeBtn = document.getElementById('analyze-btn');
        if (analyzeBtn) analyzeBtn.disabled = true;
        this.redrawOverlay();
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞
    toggleVolume() {
        this.volumeVisible = !this.volumeVisible;
        if (this.volumeVisible) {
            const v = this.allCandles.map(c => ({
                time: Math.floor(new Date(c.open_time).getTime() / 1000),
                value: +c.volume,
                color: (+c.close_price >= +c.open_price) ? 'rgba(34,197,94,0.25)' : 'rgba(239,68,68,0.25)'
            }));
            this.volumeSeries.setData(v);
        } else {
            this.volumeSeries.setData([]);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫
        const buttonText = this.volumeVisible ? '–°–∫—Ä—ã—Ç—å –æ–±—ä–µ–º' : '–ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ä–µ–º';
        const iconClass = this.volumeVisible ? 'fas fa-chart-bar' : 'fas fa-chart-bar';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ toolbar
        const toggleVolumeBtn = document.getElementById('toggle-volume-btn');
        if (toggleVolumeBtn) {
            toggleVolumeBtn.title = buttonText;
            toggleVolumeBtn.innerHTML = `<i class="${iconClass}"></i> ${this.volumeVisible ? '–û–±—ä–µ–º' : '–û–±—ä–µ–º'}`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        const navVolume = document.getElementById('nav-volume');
        if (navVolume) {
            navVolume.innerHTML = `<i class="${iconClass}"></i><span>${this.volumeVisible ? '–û–±—ä–µ–º' : '–û–±—ä–µ–º'}</span>`;
        }
        
        this.toast(this.volumeVisible ? '–û–±—ä–µ–º –ø–æ–∫–∞–∑–∞–Ω' : '–û–±—ä–µ–º —Å–∫—Ä—ã—Ç');
    }

    // –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
    async analyze() {
        if (this.selectedIndices.size === 0) return;
        const order = [...this.selectedIndices].sort((a,b) => a-b);
        const candles = order.map(i => this.allCandles[i]);
        
        const payload = { 
            num_candles: this.selectedIndices.size,
            candles, 
            timeframe: this.currentTimeframe,
            symbol: this.currentSymbol,
            no_cache: true
        };
        
        // UI state
        const btn = document.getElementById('analyze-btn');
        const loader = this.ensureLoader();
        if (btn) btn.disabled = true; 
        loader.style.display = 'flex';
        
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞...');
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000);
            
            const res = await fetch('/api/pattern/analyze', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(payload),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', res.status);
            
            if (!res.ok) {
                if (res.status === 408) {
                    throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –º–µ–Ω—å—à–∏–π –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.');
                } else if (res.status === 500) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                } else {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`);
                }
            }
            
            const data = await res.json();
            console.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞:', data);
            
            if (!data.success) {
                throw new Error(data.message || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞');
            }
            
            this.renderResults(data);
            this.drawPatternMarkers(data.matched_patterns);
            if (!data.matched_patterns || data.matched_patterns.length === 0) this.toast('–°–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            this.toast('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω');
            
            // Show chart controls after analysis
            const chartControls = document.getElementById('chart-controls');
            if (chartControls) chartControls.classList.add('visible');
            this.switchToAnalysisMode();

        } catch (e) {
            if (e.name === 'AbortError') {
                this.toast('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –º–µ–Ω—å—à–∏–π –ø–µ—Ä–∏–æ–¥.');
            } else {
                this.toast('–û—à–∏–±–∫–∞: ' + e.message);
            }
            console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:', e);
        } finally {
            if (btn) btn.disabled = this.selectedIndices.size === 0;
            loader.style.display = 'none';
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
    renderResults(result) {
        console.log("üéØ –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...", result);
        
        safeSetTextContent('matches-found', result.statistics.matches_found);
        safeSetTextContent('pattern-length', result.pattern_info.pattern_len);
        
        const percents = result.statistics.distribution_percents || {};
        const avg = Object.keys(percents).length ? (Object.values(percents).reduce((a,b)=>a+b,0) / Object.keys(percents).length) : 0;
        safeSetTextContent('accuracy', (avg||0).toFixed(2) + '%');

        const patternInfoHTML = `
            <div class="stat"><span>–ù–∞—á–∞–ª–æ</span><span class="val">${new Date(result.pattern_info.pattern_start).toLocaleDateString()}</span></div>
            <div class="stat"><span>–ö–æ–Ω–µ—Ü</span><span class="val">${new Date(result.pattern_info.pattern_end).toLocaleDateString()}</span></div>
            <div class="stat"><span>–°–≤–µ—á–µ–π</span><span class="val">${result.pattern_info.pattern_len}</span></div>
            <div class="stat"><span>–¢–∞–π–º—Ñ—Ä–µ–π–º</span><span class="val">${result.pattern_info.timeframe}</span></div>
        `;
        safeSetInnerHTML('pattern-info', patternInfoHTML);
        safeSetStyle('pattern-info-card', 'display', '');

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        safeSetInnerHTML('matches', '');
        this.matchedRanges = [];
        
        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        (result.matched_patterns || []).forEach((pat, i) => {
            const first = pat[0];
            const last = pat[pat.length-1];
            const change = result.price_changes ? result.price_changes[i] : 0;
            
            this.matchedRanges.push([ 
                Math.floor(new Date(first.date).getTime()/1000), 
                Math.floor(new Date(last.date).getTime()/1000) 
            ]);
            
            const el = document.createElement('div');
            el.className = 'match';
            el.setAttribute('data-pattern-index', i);
            el.innerHTML = `
                <div class="hdr">
                    <div class="range">
                        <span style="color: var(--accent); font-weight: 600;">–ü–∞—Ç—Ç–µ—Ä–Ω ${i + 1}</span>
                        <br>
                        <small style="color: var(--muted);">${new Date(first.date).toLocaleDateString()} ‚Äî ${new Date(last.date).toLocaleDateString()}</small>
                    </div>
                    <div class="badge ${change>=0?'up':'down'}">${change>=0?'+':''}${change.toFixed(2)}%</div>
                </div>
            `;
            el.addEventListener('click', () => {
                document.querySelectorAll('.match').forEach(m => m.classList.remove('active'));
                el.classList.add('active');
                
                this.currentMatchIndex = i;
                this.updateMatchIndexLabel();
                const [from, to] = this.matchedRanges[i];
                this.zoomTo(from, to);
            });
            document.getElementById('matches').appendChild(el);
        });
        
        this.currentMatchIndex = this.matchedRanges.length ? 0 : -1;
        this.updateMatchIndexLabel();

        // –í–ê–ñ–ù–û: –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–±—â—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ü–û–°–õ–ï–î–ù–ï–ô
        setTimeout(() => {
            this.renderGeneralAnalysis(result);
        }, 100);
        
        console.log("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω—ã");
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±—â–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±—â–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    renderGeneralAnalysis(result) {
        console.log("üìä –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –æ–±—â–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...", result);
        
        const performanceStats = result.performance_stats;
        if (!performanceStats) {
            console.error('‚ùå Performance stats not found in result:', result);
            this.showGeneralAnalysisError('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }

        console.log("üìà Performance stats:", performanceStats);

        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –æ–±—â–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        let analysisCard = document.getElementById('general-analysis-card');
        if (!analysisCard) {
            analysisCard = document.createElement('div');
            analysisCard.className = 'card';
            analysisCard.id = 'general-analysis-card';
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–æ side-panel
            const sidePanel = document.getElementById('side-panel');
            if (sidePanel) {
                // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–æ–π –∏–ª–∏ –≤ –Ω–∞—á–∞–ª–æ
                const firstCard = sidePanel.querySelector('.card');
                if (firstCard) {
                    sidePanel.insertBefore(analysisCard, firstCard);
                } else {
                    sidePanel.prepend(analysisCard);
                }
                console.log("‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∞ –∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞");
            } else {
                console.error('‚ùå Side panel not found');
                return;
            }
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        analysisCard.innerHTML = `
            <h3><i class="fas fa-chart-pie"></i> –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</h3>
            <div class="performance-summary">
                <div class="summary-item">
                    <span class="summary-label">–ú–µ–¥–∏–∞–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:</span>
                    <span class="summary-value ${performanceStats.median_change >= 0 ? 'bullish' : 'bearish'}">
                        ${performanceStats.median_change >= 0 ? '+' : ''}${performanceStats.median_change || 0}%
                    </span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å:</span>
                    <span class="summary-value bullish">${performanceStats.success_rate || 0}%</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">–ú–µ–¥–∏–∞–Ω–∞ —Ä–∞—Å—Ç—É—â–∏—Ö:</span>
                    <span class="summary-value bullish">+${performanceStats.median_bullish || 0}%</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">–ú–µ–¥–∏–∞–Ω–∞ –ø–∞–¥–∞—é—â–∏—Ö:</span>
                    <span class="summary-value bearish">${performanceStats.median_bearish || 0}%</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">–í—Å–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:</span>
                    <span class="summary-value">${performanceStats.total_patterns || 0}</span>
                </div>
            </div>
            
            <div class="pattern-distribution">
                <h4 style="margin: 15px 0 8px 0; font-size: 12px; color: var(--muted);">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</h4>
                <div class="distribution-item">
                    <span class="distribution-label">–ë—ã—á—å–∏</span>
                    <div class="distribution-bar">
                        <div class="distribution-fill bullish" style="width: ${performanceStats.bullish_percentage || 0}%"></div>
                    </div>
                    <span class="distribution-value">${performanceStats.bullish_percentage || 0}%</span>
                </div>
                <div class="distribution-item">
                    <span class="distribution-label">–ú–µ–¥–≤–µ–∂—å–∏</span>
                    <div class="distribution-bar">
                        <div class="distribution-fill bearish" style="width: ${performanceStats.bearish_percentage || 0}%"></div>
                    </div>
                    <span class="distribution-value">${performanceStats.bearish_percentage || 0}%</span>
                </div>
            </div>
            
            <div class="footer-note" style="margin-top: 12px; border-top: 1px solid var(--border); padding-top: 8px;">
                <small>–ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ ${performanceStats.valid_patterns || 0} –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è—Ö</small>
            </div>
        `;

        console.log("‚úÖ –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–∞");
    }
    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
    showGeneralAnalysisError(message) {
        let analysisCard = document.getElementById('general-analysis-card');
        if (!analysisCard) {
            analysisCard = document.createElement('div');
            analysisCard.className = 'card';
            analysisCard.id = 'general-analysis-card';
            
            const sidePanel = document.getElementById('side-panel');
            if (sidePanel) {
                const firstCard = sidePanel.querySelector('.card');
                if (firstCard) {
                    sidePanel.insertBefore(analysisCard, firstCard);
                } else {
                    sidePanel.prepend(analysisCard);
                }
            }
        }
        
        analysisCard.innerHTML = `
            <h3><i class="fas fa-chart-pie"></i> –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</h3>
            <div style="text-align: center; padding: 20px; color: var(--muted);">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                <p>${message}</p>
            </div>
        `;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    drawPatternMarkers(matched) {
        // –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã-–∫–≤–∞–¥—Ä–∞—Ç—ã –∏ –Ω–æ–º–µ—Ä–∞: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª–∏–Ω–∏–∏ –Ω–∞ –æ–≤–µ—Ä–ª–µ–µ
        this.patternMarkers.clear();
        this.matchedHighlightPoints = [];
        (matched || []).forEach((pat, pIdx) => {
            for (let i=0;i<pat.length;i++) {
                const t = Math.floor(new Date(pat[i].date).getTime()/1000);
                this.matchedHighlightPoints.push({ time: t });
            }
        });
        // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω-–º–∞—Ä–∫–µ—Ä—ã –≤ setMarkers ‚Äî —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
        this.redrawOverlay();
        if (matched && matched.length && matched[0].length) {
            const f = matched[0][0];
            const l = matched[0][matched[0].length-1];
            this.zoomTo(Math.floor(new Date(f.date).getTime()/1000), Math.floor(new Date(l.date).getTime()/1000));
        }
    }

    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –æ–±–ª–∞—Å—Ç–∏
    zoomTo(from, to) {
        const pad = Math.max(3*24*60*60, Math.floor((to-from)*0.5));
        this.chart.timeScale().setVisibleRange({ from: from - pad, to: to + pad });
        
        setTimeout(() => {
            this.redrawOverlay();
        }, 50);
    }

    // ===== Overlay helpers for highlighting candles =====
    ensureOverlay() {
        if (this.overlay) return this.overlay;
        const host = document.getElementById('chart');
        const canvas = document.createElement('canvas');
        canvas.style.position = 'absolute';
        canvas.style.left = '0';
        canvas.style.top = '0';
        canvas.style.pointerEvents = 'none';
        canvas.style.zIndex = '5';
        canvas.width = host.clientWidth; canvas.height = host.clientHeight;
        host.appendChild(canvas);
        this.overlay = canvas;
        return canvas;
    }

    resizeOverlay() {
        const host = document.getElementById('chart');
        if (!this.overlay) return;
        this.overlay.width = host.clientWidth;
        this.overlay.height = host.clientHeight;
    }

    redrawOverlay() {
        this.ensureOverlay();
        if (!this.overlay) return;
        
        const ctx = this.overlay.getContext('2d');
        ctx.clearRect(0,0,this.overlay.width,this.overlay.height);
        
        const ts = this.chart.timeScale();
        const barW = ts.getBarSpacing ? ts.getBarSpacing() : 12;
        const h = this.overlay.height;
        
        // –†–∏—Å—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å–∏–Ω–∏–º–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º–∏ –ª–∏–Ω–∏—è–º–∏ (–º–µ–Ω–µ–µ –∑–∞–º–µ—Ç–Ω–æ)
        for (const p of (this.matchedHighlightPoints || [])) {
            const x = ts.timeToCoordinate(p.time);
            if (x === null || x === undefined) continue;
            ctx.save();
            ctx.strokeStyle = 'rgba(59,130,246,0.42)';
            ctx.lineWidth = 3;
            ctx.setLineDash([]);
            ctx.beginPath();
            ctx.moveTo(Math.round(x) + 0.5, 0);
            ctx.lineTo(Math.round(x) + 0.5, h);
            ctx.stroke();
            ctx.restore();
        }
        // –ë–æ–ª—å—à–µ –Ω–µ –≤—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é —Å–≤–µ—á–∏ –ø–æ–ª–æ—Å–∞–º–∏
    }

    hexToRgba(hex, a) {
        const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (!m) return `rgba(255,255,255,${a})`;
        const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
        return `rgba(${r},${g},${b},${a})`;
    }

    startAnimation() {
        const animate = () => {
            this.redrawOverlay();
            this.animationFrame = requestAnimationFrame(animate);
        };
        animate();
    }

    stopAnimation() {
        if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
            this.animationFrame = null;
        }
    }

    ensureLoader() {
        let el = document.querySelector('.loading');
        if (!el) {
            el = document.createElement('div'); el.className = 'loading';
            const sp = document.createElement('div'); sp.className = 'spinner'; el.appendChild(sp);
            document.body.appendChild(el);
        }
        return el;
    }

    toast(msg) {
        if (!this.toastEl) { this.toastEl = document.createElement('div'); this.toastEl.className = 'toast'; document.body.appendChild(this.toastEl); }
        this.toastEl.textContent = msg; this.toastEl.style.display = 'block';
        clearTimeout(this.toastTimer); this.toastTimer = setTimeout(() => { this.toastEl.style.display = 'none'; }, 2200);
    }

    // ===== Navigation helpers =====
    zoomToSelected() {
        if (!this.selectedIndices.size) { this.toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–µ—á–∏'); return; }
        
        this.updateSelected();
        this.applyMarkers();
        this.redrawOverlay();
        
        const sorted = [...this.selectedIndices].sort((a,b)=>a-b);
        const first = Math.floor(new Date(this.allCandles[sorted[0]].open_time).getTime()/1000);
        const last = Math.floor(new Date(this.allCandles[sorted[sorted.length-1]].open_time).getTime()/1000);
        
        this.zoomTo(first, last);
        
        setTimeout(() => {
            this.updateSelected();
            this.applyMarkers();
            this.redrawOverlay();
        }, 100);
        
        setTimeout(() => {
            this.updateSelected();
            this.applyMarkers();
            this.redrawOverlay();
        }, 300);
    }

    gotoMatch(step) {
        if (!this.matchedRanges.length) { this.toast('–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç'); return; }
        if (this.currentMatchIndex === -1) this.currentMatchIndex = 0;
        else this.currentMatchIndex = (this.currentMatchIndex + step + this.matchedRanges.length) % this.matchedRanges.length;
        this.updateMatchIndexLabel();
        
        document.querySelectorAll('.match').forEach(m => m.classList.remove('active'));
        const activeMatch = document.querySelector(`[data-pattern-index="${this.currentMatchIndex}"]`);
        if (activeMatch) activeMatch.classList.add('active');
        
        const [from, to] = this.matchedRanges[this.currentMatchIndex];
        this.zoomTo(from, to);
        
        setTimeout(() => {
            this.redrawOverlay();
            this.applyMarkers();
        }, 100);
    }

    updateMatchIndexLabel() {
        const label = this.matchedRanges.length ? `${this.currentMatchIndex+1}/${this.matchedRanges.length}` : '0/0';
        safeSetTextContent('match-index', label);
    }

    showPatternsModal() {
        const modal = document.getElementById('patterns-modal');
        const patternsList = document.getElementById('modal-patterns-list');
        const patternStats = document.getElementById('modal-pattern-stats');
        
        patternsList.innerHTML = '';
        patternStats.innerHTML = '';
        
        if (this.matchedRanges && this.matchedRanges.length > 0) {
            const selectedCount = this.selectedIndices.size;
            const patternLength = selectedCount;
            const matchesFound = this.matchedRanges.length;
            
            patternStats.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
                    <div class="stat">
                        <span style="color: var(--muted); font-size: 12px;">–í—ã–±—Ä–∞–Ω–æ —Å–≤–µ—á–µ–π</span>
                        <span class="val" style="color: var(--accent); font-weight: 600;">${selectedCount}</span>
                    </div>
                    <div class="stat">
                        <span style="color: var(--muted); font-size: 12px;">–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</span>
                        <span class="val" style="color: var(--green); font-weight: 600;">${matchesFound}</span>
                    </div>
                </div>
                <div style="font-size: 11px; color: var(--muted); text-align: center;">
                    –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –Ω–µ–º—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
                </div>
            `;
            
            this.matchedRanges.forEach((range, index) => {
                const startDate = new Date(range[0] * 1000).toLocaleDateString();
                const endDate = new Date(range[1] * 1000).toLocaleDateString();
                
                const patternEl = document.createElement('div');
                patternEl.className = 'match';
                patternEl.innerHTML = `
                    <div class="hdr">
                        <div class="range">–ü–∞—Ç—Ç–µ—Ä–Ω ${index + 1}</div>
                        <div class="badge up">${index + 1}</div>
                    </div>
                    <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                        ${startDate} ‚Äî ${endDate}
                    </div>
                `;
                patternEl.addEventListener('click', () => {
                    this.currentMatchIndex = index;
                    this.updateMatchIndexLabel();
                    this.zoomTo(range[0], range[1]);
                    this.hidePatternsModal();
                });
                patternsList.appendChild(patternEl);
            });
        } else {
            patternStats.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–µ—á–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑</div>';
            patternsList.innerHTML = '';
        }
        
        modal.style.display = 'block';
    }

    hidePatternsModal() {
        const modal = document.getElementById('patterns-modal');
        modal.style.display = 'none';
    }

    showClearConfirmationModal() {
        localStorage.setItem('savedSymbol', this.currentSymbol);
        const modal = document.getElementById('clear-confirmation-modal');
        safeSetTextContent('selected-count-modal', this.selectedIndices.size);
        safeSetTextContent('patterns-count-modal', this.matchedRanges.length);
        if (modal) modal.style.display = 'block';
    }

    hideClearConfirmationModal() {
        const modal = document.getElementById('clear-confirmation-modal');
        modal.style.display = 'none';
    }

    toggleChartControls() {
        const chartControls = document.getElementById('chart-controls');
        const toggleBtn = document.getElementById('toggle-controls-btn');
        const toggleIcon = toggleBtn.querySelector('i');
        
        if (chartControls.classList.contains('collapsed')) {
            chartControls.classList.remove('collapsed');
            toggleIcon.className = 'fas fa-chevron-down';
        } else {
            chartControls.classList.add('collapsed');
            toggleIcon.className = 'fas fa-chevron-up';
        }
    }

    toggleAnalysisPanel() {
        if (window.innerWidth <= 768) {
            this.showAnalysisModal();
        } else {
            const sidePanel = document.getElementById('side-panel');
            if (sidePanel) {
                const isVisible = sidePanel.classList.contains('active');
                if (isVisible) {
                    sidePanel.classList.remove('active');
                    this.toast('–ê–Ω–∞–ª–∏–∑ —Å–∫—Ä—ã—Ç');
                } else {
                    sidePanel.classList.add('active');
                    this.toast('–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞–Ω');
                }
            }
        }
    }

    showAnalysisModal() {
        let modal = document.getElementById('analysis-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'analysis-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑</div>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body" id="analysis-modal-body">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.querySelector('.close-modal').addEventListener('click', () => this.hideAnalysisModal());
            modal.addEventListener('click', (e) => {
                if (e.target.id === 'analysis-modal') {
                    this.hideAnalysisModal();
                }
            });
        }
        
        const sidePanel = document.getElementById('side-panel');
        const modalBody = document.getElementById('analysis-modal-body');
        if (sidePanel && modalBody) {
            modalBody.innerHTML = sidePanel.innerHTML;
        }
        
        modal.style.display = 'block';
    }

    hideAnalysisModal() {
        const modal = document.getElementById('analysis-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // –°–º–µ–Ω–∞ —Å–∏–º–≤–æ–ª–∞
    async switchSymbol(newSymbol) {
        if (newSymbol === this.currentSymbol) return;
        
        console.log(`üîÑ –°–º–µ–Ω–∞ —Å–∏–º–≤–æ–ª–∞: ${this.currentSymbol} -> ${newSymbol}`);
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        this.chartUpdater.stop();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–µ–∂–µ—Å—Ç–∏
        this.dataInitiallyLoaded = false;
        
        this.currentSymbol = newSymbol;
        
        // –û—á–∏—â–∞–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ
        this.clearSelection();
        this.patternMarkers.clear();
        this.matchedHighlightPoints = [];
        this.matchedRanges = [];
        this.currentMatchIndex = -1;
        
        // –û—á–∏—â–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
        this.candleSeries.setData([]);
        this.volumeSeries.setData([]);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const loader = this.ensureLoader();
        loader.style.display = 'flex';
        
        try {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const symbolDisplay = newSymbol.replace('#', '/');
            document.getElementById('page-title').textContent = `${symbolDisplay} ‚Äî –ü–æ–∏—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤`;
            
            // –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–ú –î–ê–ù–ù–´–ï –° –ù–û–í–´–ú –°–ò–ú–í–û–õ–û–ú
            await this.loadData();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
            safeSetTextContent('matches-found', '0');
            safeSetTextContent('pattern-length', '0');
            safeSetTextContent('accuracy', '0%');
            safeSetStyle('pattern-info-card', 'display', 'none');
            safeSetInnerHTML('matches', '');
            safeSetInnerHTML('general-analysis-card', '');
            
            this.toast(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${symbolDisplay}`);
            
            // –ó–ê–ü–£–°–ö–ê–ï–ú –°–ò–°–¢–ï–ú–£ –û–ë–ù–û–í–õ–ï–ù–ò–ô –î–õ–Ø –ù–û–í–û–ì–û –°–ò–ú–í–û–õ–ê
            this.chartUpdater.initialize(this.currentSymbol, this.currentTimeframe);
            
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Å–∏–º–≤–æ–ª–∞:', e);
            this.toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
        } finally {
            loader.style.display = 'none';
        }
    }
 
    // –°–º–µ–Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
    async switchTimeframe(newTimeframe) {
        console.log(`üîÑ –°–º–µ–Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞: ${this.currentTimeframe} -> ${newTimeframe}`);
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        this.chartUpdater.stop();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–µ–∂–µ—Å—Ç–∏
        this.dataInitiallyLoaded = false;
        
        this.currentTimeframe = newTimeframe;
        
        // –û—á–∏—â–∞–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ
        this.clearSelection();
        this.patternMarkers.clear();
        this.matchedHighlightPoints = [];
        this.matchedRanges = [];
        this.currentMatchIndex = -1;
        
        // –û—á–∏—â–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
        this.candleSeries.setData([]);
        this.volumeSeries.setData([]);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const loader = this.ensureLoader();
        loader.style.display = 'flex';
        
        try {
            // –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–ú –î–ê–ù–ù–´–ï –° –ù–û–í–´–ú –¢–ê–ô–ú–§–†–ï–ô–ú–û–ú
            await this.loadData();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
            safeSetTextContent('matches-found', '0');
            safeSetTextContent('pattern-length', '0');
            safeSetTextContent('accuracy', '0%');
            safeSetStyle('pattern-info-card', 'display', 'none');
            safeSetInnerHTML('matches', '');
            safeSetInnerHTML('general-analysis-card', '');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            const timeframeMap = {
                '1h': '1—á',
                '4h': '4—á', 
                '1d': '1–î',
                '1w': '1–ù'
            };
            const kpiTF = document.querySelector('.kpi strong');
            if (kpiTF) kpiTF.textContent = timeframeMap[newTimeframe] || newTimeframe;
            
            this.toast(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ ${timeframeMap[newTimeframe] || newTimeframe}`);
            
            // –ó–ê–ü–£–°–ö–ê–ï–ú –°–ò–°–¢–ï–ú–£ –û–ë–ù–û–í–õ–ï–ù–ò–ô –î–õ–Ø –ù–û–í–û–ì–û –¢–ê–ô–ú–§–†–ï–ô–ú–ê
            this.chartUpdater.initialize(this.currentSymbol, this.currentTimeframe);
            
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞:', e);
            this.toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
        } finally {
            loader.style.display = 'none';
        }
    }
    switchToAnalysisMode() {
        this.isAnalysisMode = true;
        this.chart.applyOptions({
            timeScale: {
                minBarSpacing: 2,
                barSpacing: 12
            }
        });
        this.updateSelected();
    }

    switchToSelectionMode() {
        this.isAnalysisMode = false;
        this.chart.applyOptions({
            timeScale: {
                minBarSpacing: 15,
                barSpacing: 60
            }
        });
        this.chart.timeScale().fitContent();
    }

    setActiveTimeframe() {
        document.querySelectorAll('[data-tf]').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-tf') === this.currentTimeframe) {
                btn.classList.add('active');
            }
        });
        
        const timeframeMap = {
            '1h': '1—á',
            '4h': '4—á',
            '1d': '1–î', 
            '1w': '1–ù'
        };
        const kpiTF = document.querySelector('.kpi strong');
        if (kpiTF) kpiTF.textContent = timeframeMap[this.currentTimeframe] || this.currentTimeframe;
    }

    // –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    async manualRefreshData() {
        const loader = this.ensureLoader();
        loader.style.display = 'flex';
        
        try {
            await this.chartUpdater.manualRefresh();
            this.toast('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
            this.toast('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
        } finally {
            loader.style.display = 'none';
        }
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function safeSetTextContent(elementId, text) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = text;
    }
}

function safeSetInnerHTML(elementId, html) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = html;
    }
}

function safeSetStyle(elementId, property, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style[property] = value;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => new PatternChart());
    </script>
</body>
</html>
