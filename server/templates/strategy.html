<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Strategy Tester</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --surface: #1a222c;
            --surface-dark: #111827;
            --surface-light: #2d3748;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #374151;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 0;
        }

        /* Header */
        .app-header {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .logo-section h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
        }

        .logo-section p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Main Layout - Full Width */
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0;
            padding: 1rem;
            gap: 1rem;
            overflow: hidden;
        }

        .left-panel {
            flex: 0 0 350px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            min-width: 300px;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 600px;
            overflow: hidden;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 1.25rem;
            box-shadow: var(--shadow);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Controls */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        select, input {
            padding: 0.5rem 0.75rem;
            background: var(--surface-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Buttons */
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Chart - Full Size */
        .chart-container {
            flex: 1;
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            min-height: 300px;
        }

        #chart {
            width: 100%;
            height: 100%;
        }

        .chart-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.375rem;
            z-index: 10;
        }

        .chart-btn {
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.375rem 0.625rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .chart-btn:hover {
            background: var(--surface-dark);
        }

        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .metric-card {
            background: var(--surface-dark);
            border-radius: 6px;
            padding: 1rem;
            border: 1px solid var(--border);
            text-align: center;
        }

        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .metric-value.profit { color: var(--success); }
        .metric-value.loss { color: var(--danger); }
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Trades List */
        .trades-section {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .trades-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--surface-dark);
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
        }

        .trades-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .trade-type {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .trade-type.buy {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .trade-type.sell {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Loading */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(17, 24, 39, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--surface-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .status-badge.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-badge.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .left-panel {
                flex: 0 0 320px;
            }
            
            .right-panel {
                min-width: 500px;
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .left-panel {
                flex: 0 0 auto;
                max-height: 400px;
            }
            
            .right-panel {
                flex: 1;
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .app-header {
                padding: 0.5rem 1rem;
            }
            
            .main-content {
                padding: 0.5rem;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-dark);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--surface-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-section">
                <h1>Multi Strategy Tester</h1>
                <p>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π</p>
            </div>
        </header>

        <main class="main-content">
            <!-- Left Panel - Controls -->
            <div class="left-panel">
                <div class="card">
                    <h3 class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h3>
                    <div class="control-group">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="strategySelect">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</label>
                                <select id="strategySelect">
                                    <option value="SMA_CROSSOVER">SMA Crossover (20)</option>
                                    <option value="RSI_STRATEGY">RSI Overbought/Oversold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="symbolSelect">–¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞</label>
                                <select id="symbolSelect">
                                    <option value="BTCUSDT">BTC/USDT</option>
                                    <option value="ETHUSDT">ETH/USDT</option>
                                    <option value="SOLUSDT">SOL/USDT</option>
                                    <option value="XRPUSDT">XRP/USDT</option>
                                    <option value="BNBUSDT">BNB/USDT</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timeframeSelect">–¢–∞–π–º—Ñ—Ä–µ–π–º</label>
                                <select id="timeframeSelect">
                                    <option value="1h">1 —á–∞—Å</option>
                                    <option value="4h">4 —á–∞—Å–∞</option>
                                    <option value="1d">1 –¥–µ–Ω—å</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="initialDeposit">–ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç ($)</label>
                                <input type="number" id="initialDeposit" value="100000" min="1000" step="1000">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ—Ä–≥–æ–≤–ª–∏</h3>
                    <div class="control-group">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tpPercent">Take Profit (%)</label>
                                <input type="number" id="tpPercent" value="4.0" min="0.1" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="slPercent">Stop Loss (%)</label>
                                <input type="number" id="slPercent" value="2.0" min="0.1" step="0.1">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="maxCandles">–ú–∞–∫—Å. —Å–≤–µ—á–µ–π —É–¥–µ—Ä–∂–∞–Ω–∏—è</label>
                                <input type="number" id="maxCandles" value="5" min="1" max="20">
                            </div>
                            <div class="form-group">
                                <label for="commissionPct">–ö–æ–º–∏—Å—Å–∏—è (%)</label>
                                <input type="number" id="commissionPct" value="0.05" min="0" step="0.001">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">–ü–µ—Ä–∏–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                    <div class="control-group">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="startDate">–ù–∞—á–∞–ª–æ</label>
                                <input type="date" id="startDate">
                            </div>
                            <div class="form-group">
                                <label for="endDate">–ö–æ–Ω–µ—Ü</label>
                                <input type="date" id="endDate">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                    <div class="control-group">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="slippagePct">–ü—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (%)</label>
                                <input type="number" id="slippagePct" value="0.05" min="0" step="0.001">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="runTestBtn" class="btn btn-primary">
                        <span>‚ñ∂Ô∏è</span>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç
                    </button>
                    <button id="analyticsReportBtn" class="btn btn-secondary" disabled>
                        <span>üìä</span>
                        –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                    </button>
                </div>
            </div>

            <!-- Right Panel - Chart & Results -->
            <div class="right-panel">
                <div class="chart-container">
                    <div id="chart"></div>
                    <div class="chart-controls">
                        <button class="chart-btn" id="zoomInBtn" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
                        <button class="chart-btn" id="zoomOutBtn" title="–£–º–µ–Ω—å—à–∏—Ç—å">-</button>
                        <button class="chart-btn" id="fitContentBtn" title="–í–ø–∏—Å–∞—Ç—å –≤ —ç–∫—Ä–∞–Ω">‚Üî</button>
                    </div>
                    <div class="loading-overlay" id="loadingIndicator" style="display: none;">
                        <div class="spinner"></div>
                        <p>–í—ã–ø–æ–ª–Ω—è–µ–º –±—ç–∫—Ç–µ—Å—Ç...</p>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="card" style="overflow-y: auto;">
                    <div id="resultsContent">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">üöÄ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç</p>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç"</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        class StrategyTesterUI {
            constructor() {
                this.chart = null;
                this.candleSeries = null;
                this.smaSeries = null;
                this.currentTrades = [];
                this.lastTestResult = null;

                this.initChart();
                this.bindEvents();
                this.setDefaultDates();
                this.setupChartControls();
            }

            setDefaultDates() {
                const today = new Date();
                const oneYearAgo = new Date(today);
                oneYearAgo.setFullYear(today.getFullYear() - 1);

                document.getElementById('endDate').value = today.toISOString().split('T')[0];
                document.getElementById('startDate').value = oneYearAgo.toISOString().split('T')[0];
            }

            initChart() {
                const container = document.getElementById('chart');
                this.chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: container.clientHeight,
                    layout: {
                        background: { color: '#0f1419' },
                        textColor: '#d1d5db'
                    },
                    grid: {
                        vertLines: { color: '#1f2937' },
                        horzLines: { color: '#1f2937' }
                    },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false,
                        borderColor: '#2d3748'
                    },
                    rightPriceScale: { borderColor: '#2d3748' },
                });

                this.candleSeries = this.chart.addCandlestickSeries({
                    upColor: '#22c55e',
                    downColor: '#ef4444',
                    borderVisible: false,
                    wickUpColor: '#22c55e',
                    wickDownColor: '#ef4444'
                });

                this.smaSeries = this.chart.addLineSeries({
                    color: '#60a5fa',
                    lineWidth: 2,
                    priceLineVisible: false
                });

                window.addEventListener('resize', () => {
                    this.chart.applyOptions({
                        width: container.clientWidth,
                        height: container.clientHeight
                    });
                });
            }

            setupChartControls() {
                document.getElementById('zoomInBtn').addEventListener('click', () => {
                    this.chart.timeScale().scrollPosition += 10;
                });

                document.getElementById('zoomOutBtn').addEventListener('click', () => {
                    this.chart.timeScale().scrollPosition -= 10;
                });

                document.getElementById('fitContentBtn').addEventListener('click', () => {
                    this.chart.timeScale().fitContent();
                });
            }

            bindEvents() {
                document.getElementById('runTestBtn').addEventListener('click', () => this.runTest());
                document.getElementById('analyticsReportBtn').addEventListener('click', () => this.showAnalyticalReport());
            }

            async runTest() {
                this.showLoading(true);
                document.getElementById('analyticsReportBtn').disabled = true;

                try {
                    const params = {
                        symbol: document.getElementById('symbolSelect').value,
                        timeframe: document.getElementById('timeframeSelect').value,
                        start_date: document.getElementById('startDate').value,
                        end_date: document.getElementById('endDate').value,
                        initial_deposit: Number(document.getElementById('initialDeposit').value),
                        tp_percent: Number(document.getElementById('tpPercent').value),
                        sl_percent: Number(document.getElementById('slPercent').value),
                        max_candles: Number(document.getElementById('maxCandles').value),
                        commission_pct: Number(document.getElementById('commissionPct').value) / 100,
                        slippage_pct: Number(document.getElementById('slippagePct').value) / 100,
                        strategy: document.getElementById('strategySelect').value
                    };

                    const resp = await fetch('/api/strategy/test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(params)
                    });

                    const result = await resp.json();

                    if (!result.success) {
                        alert(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${result.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                        return;
                    }

                    this.lastTestResult = result;
                    this.currentTrades = result.trades || [];

                    await this.loadAndDrawChart(params);
                    this.displayResults(result);
                    document.getElementById('analyticsReportBtn').disabled = false;

                } catch (err) {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                } finally {
                    this.showLoading(false);
                }
            }

            async loadAndDrawChart({ symbol, timeframe, start_date, end_date }) {
                try {
                    const url = `/api/pattern/ohlcv?symbol=${symbol}&timeframe=${timeframe}&from=${start_date}&to=${end_date}`;
                    const resp = await fetch(url);
                    const data = await resp.json();

                    if (!data.success || !data.candles?.length) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–µ—á–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞');
                        return;
                    }

                    const candles = data.candles.map(c => ({
                        time: Math.floor(new Date(c.open_time).getTime() / 1000),
                        open: Number(c.open_price),
                        high: Number(c.high),
                        low: Number(c.low),
                        close: Number(c.close_price),
                    }));

                    const sma = this.calculateSMA(candles, 20);

                    this.candleSeries.setData(candles);
                    this.smaSeries.setData(sma);

                    this.addTradeMarkers();

                    this.chart.timeScale().fitContent();

                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', err);
                }
            }

            calculateSMA(candles, period) {
                const sma = [];
                for (let i = period - 1; i < candles.length; i++) {
                    let sum = 0;
                    for (let j = 0; j < period; j++) sum += candles[i - j].close;
                    sma.push({ time: candles[i].time, value: sum / period });
                }
                return sma;
            }

            addTradeMarkers() {
                if (!this.currentTrades.length) return;

                const markers = [];

                this.currentTrades.forEach((trade, idx) => {
                    const entryTime = Math.floor(new Date(trade.entry_time).getTime() / 1000);
                    const exitTime = Math.floor(new Date(trade.exit_time).getTime() / 1000);

                    // –í—Ö–æ–¥
                    markers.push({
                        time: entryTime,
                        position: 'aboveBar',
                        color: trade.type === 'BUY' ? '#22c55e' : '#ef4444',
                        shape: 'circle',
                        size: 2,
                        text: `${trade.type} #${idx+1}`
                    });

                    // –í—ã—Ö–æ–¥
                    markers.push({
                        time: exitTime,
                        position: 'belowBar',
                        color: trade.pnl_pct >= 0 ? '#22c55e' : '#ef4444',
                        shape: trade.exit_type === 'TP' ? 'arrowUp' :
                               trade.exit_type === 'SL' ? 'arrowDown' : 'square',
                        size: 1,
                        text: `${trade.pnl_pct >= 0 ? '+' : ''}${trade.pnl_pct.toFixed(1)}%`
                    });
                });

                this.candleSeries.setMarkers(markers);
            }

            displayResults(result) {
                const s = result.statistics;
                const strategyName = result.strategy_used === 'SMA_CROSSOVER' 
                    ? 'SMA Crossover' 
                    : 'RSI Strategy';

                let html = `
                    <div class="card-title" style="margin-bottom: 1.5rem;">
                        ${strategyName} ‚Ä¢ ${result.symbol} ‚Ä¢ ${result.timeframe}
                    </div>

                    <div class="results-grid">
                        <div class="metric-card">
                            <div class="metric-value ${s.total_return_percent >= 0 ? 'profit' : 'loss'}">
                                ${s.total_return_percent.toFixed(2)}%
                            </div>
                            <div class="metric-label">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-value ${s.buy_hold_return >= 0 ? 'profit' : 'loss'}">
                                ${s.buy_hold_return.toFixed(2)}%
                            </div>
                            <div class="metric-label">Buy & Hold</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-value ${s.comparison_vs_bh >= 0 ? 'profit' : 'loss'}">
                                ${s.comparison_vs_bh >= 0 ? '+' : ''}${s.comparison_vs_bh.toFixed(1)}%
                            </div>
                            <div class="metric-label">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ / –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-value">
                                $${s.final_deposit.toLocaleString('en-US', {minimumFractionDigits: 0})}
                            </div>
                            <div class="metric-label">–ò—Ç–æ–≥ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-value">
                                $${s.buy_hold_value.toLocaleString('en-US', {minimumFractionDigits: 0})}
                            </div>
                            <div class="metric-label">–ò—Ç–æ–≥ Buy & Hold</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-value">
                                ${s.total_trades}
                            </div>
                            <div class="metric-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-value ${s.win_rate >= 50 ? 'profit' : 'loss'}">
                                ${s.win_rate.toFixed(1)}%
                            </div>
                            <div class="metric-label">–í–∏–Ω—Ä–µ–π—Ç</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-value ${Math.abs(s.max_drawdown) > 20 ? 'loss' : 'neutral'}">
                                ${s.max_drawdown.toFixed(1)}%
                            </div>
                            <div class="metric-label">–ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞</div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 0.75rem; color: var(--text-primary);">–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ (${result.trades.length})</h4>
                        <div class="trades-section">
                            <table class="trades-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–í—Ö–æ–¥</th>
                                        <th>–í—ã—Ö–æ–¥</th>
                                        <th>P&L %</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                result.trades.forEach((trade, idx) => {
                    html += `
                        <tr onclick="ui.showTradeDetail(${idx})" style="cursor: pointer;">
                            <td>${idx + 1}</td>
                            <td><span class="trade-type ${trade.type.toLowerCase()}">${trade.type}</span></td>
                            <td>${new Date(trade.entry_time).toLocaleDateString('ru-RU')}</td>
                            <td>${new Date(trade.exit_time).toLocaleDateString('ru-RU')}</td>
                            <td style="color: ${trade.pnl_pct >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                                ${trade.pnl_pct >= 0 ? '+' : ''}${trade.pnl_pct.toFixed(2)}%
                            </td>
                            <td>
                                <span class="status-badge ${trade.exit_type === 'TP' ? 'success' : trade.exit_type === 'SL' ? 'danger' : 'warning'}">
                                    ${trade.exit_type}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('resultsContent').innerHTML = html;
            }

            showTradeDetail(idx) {
                const t = this.currentTrades[idx];
                if (!t) return;

                let msg = `–°–¥–µ–ª–∫–∞ #${idx+1}\n\n`;
                msg += `–¢–∏–ø: ${t.type}\n`;
                msg += `–í—Ö–æ–¥: ${new Date(t.entry_time).toLocaleString('ru-RU')}\n`;
                msg += `–í—ã—Ö–æ–¥: ${new Date(t.exit_time).toLocaleString('ru-RU')}\n`;
                msg += `–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: ${t.entry_price.toFixed(4)}\n`;
                msg += `–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞: ${t.exit_price.toFixed(4)}\n`;
                msg += `P&L: ${t.pnl_pct >= 0 ? '+' : ''}${t.pnl_pct.toFixed(2)}%  (net)\n`;
                msg += `Gross P&L: ${t.gross_pnl_pct.toFixed(2)}%\n`;
                msg += `–°—Ç–∞—Ç—É—Å: ${t.exit_type}\n`;
                msg += `–£–¥–µ—Ä–∂–∞–Ω–æ: ${t.candles_held} —Å–≤–µ—á–µ–π\n`;

                if (t.sma_value) {
                    msg += `SMA(20): ${t.sma_value.toFixed(2)}\n`;
                    msg += `–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç SMA: ${t.price_vs_sma.toFixed(2)}%\n`;
                }
                if (t.rsi_value) {
                    msg += `RSI(14): ${t.rsi_value.toFixed(2)}`;
                }

                alert(msg);
            }

            showAnalyticalReport() {
                if (!this.lastTestResult) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ');
                    return;
                }

                const s = this.lastTestResult.statistics;
                const strat = this.lastTestResult.strategy_used === 'SMA_CROSSOVER'
                    ? 'SMA(20) –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ'
                    : 'RSI(14) –∑–æ–Ω—ã –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏';
                const symbol = this.lastTestResult.symbol;
                const tf = this.lastTestResult.timeframe;

                let text = `<strong>–°—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> ${strat}<br>`;
                text += `<strong>–ê–∫—Ç–∏–≤ / –¢–∞–π–º—Ñ—Ä–µ–π–º:</strong> ${symbol} ${tf}<br><br>`;

                const retColor = s.total_return_percent >= 0 ? '#22c55e' : '#ef4444';
                text += `<strong>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å:</strong> <span style="color:${retColor};font-weight:bold;">${s.total_return_percent.toFixed(2)}%</span><br>`;

                let mood = s.total_return_percent > 40 ? '–æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π'
                         : s.total_return_percent > 15 ? '—Ö–æ—Ä–æ—à–∏–π'
                         : s.total_return_percent > 0  ? '–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ —Å–∫—Ä–æ–º–Ω—ã–π'
                         : s.total_return_percent > -10 ? '–æ–∫–æ–ª–æ –Ω—É–ª—è / —à—É–º–∞'
                         : '—Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±—ã—Ç–æ—á–Ω—ã–π';

                text += `–û—Ü–µ–Ω–∫–∞: <em>${mood}</em>.<br><br>`;

                if (s.win_rate >= 60) {
                    text += `<span style="color:#86efac">–í—ã—Å–æ–∫–∏–π –≤–∏–Ω—Ä–µ–π—Ç (${s.win_rate}%) ‚Äî —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫.</span><br>`;
                } else if (s.win_rate < 45) {
                    text += `<span style="color:#fca5a5">–ù–∏–∑–∫–∏–π –≤–∏–Ω—Ä–µ–π—Ç (${s.win_rate}%) —Ç—Ä–µ–±—É–µ—Ç –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–≥–æ R:R.</span><br>`;
                }

                const bhDiff = s.comparison_vs_bh;
                if (Math.abs(bhDiff) < 10) {
                    text += `–†–µ–∑—É–ª—å—Ç–∞—Ç –±–ª–∏–∑–æ–∫ –∫ Buy&Hold.<br>`;
                } else if (bhDiff > 15) {
                    text += `<span style="color:#86efac">–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –ª—É—á—à–µ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ —É–¥–µ—Ä–∂–∞–Ω–∏—è (+${bhDiff.toFixed(1)}%).</span><br>`;
                } else if (bhDiff < -15) {
                    text += `<span style="color:#fca5a5">–ó–∞–º–µ—Ç–Ω–æ —Ö—É–∂–µ Buy&Hold (${bhDiff.toFixed(1)}%).</span><br>`;
                }

                const dd = s.max_drawdown;
                if (Math.abs(dd) > 30) {
                    text += `<span style="color:#fca5a5">–ü—Ä–æ—Å–∞–¥–∫–∞ ${dd.toFixed(1)}% ‚Äî –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è.</span><br>`;
                } else if (Math.abs(dd) > 18) {
                    text += `–ü—Ä–æ—Å–∞–¥–∫–∞ ${dd.toFixed(1)}% ‚Äî —É–º–µ—Ä–µ–Ω–Ω–æ –≤—ã—Å–æ–∫–∞—è.<br>`;
                } else {
                    text += `<span style="color:#86efac">–ü—Ä–æ—Å–∞–¥–∫–∞ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º (${dd.toFixed(1)}%).</span><br>`;
                }

                text += '<br><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> ';
                if (s.total_return_percent > 25 && Math.abs(dd) < 20 && s.win_rate > 55) {
                    text += '<span style="color:#60a5fa;font-weight:bold;">–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ. –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ.</span>';
                } else if (s.total_return_percent > 8 && bhDiff > 5) {
                    text += '–ï—Å—Ç—å —Å–º—ã—Å–ª –¥–æ—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.';
                } else {
                    text += '–ù–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö edge –Ω–µ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä—å—ë–∑–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞.';
                }

                // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position:fixed; inset:0; background:rgba(0,0,0,0.8);
                    display:flex; align-items:center; justify-content:center; z-index:9999;
                `;

                const box = document.createElement('div');
                box.style.cssText = `
                    background:#1a222c; border-radius:12px; max-width:640px; width:92%;
                    max-height:90vh; overflow-y:auto; padding:32px; position:relative;
                    border:1px solid #2d3748; color:#e2e8f0; line-height:1.6;
                `;

                const close = document.createElement('button');
                close.textContent = '√ó';
                close.style.cssText = `
                    position:absolute; top:12px; right:20px; background:none; border:none;
                    font-size:36px; color:#94a3b8; cursor:pointer;
                `;
                close.onclick = () => modal.remove();

                const title = document.createElement('h2');
                title.textContent = '–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ';
                title.style.cssText = 'margin:0 0 24px; color:#60a5fa; text-align:center;';

                const content = document.createElement('div');
                content.innerHTML = text;

                box.append(close, title, content);
                modal.appendChild(box);
                document.body.appendChild(modal);

                modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
            }

            showLoading(show) {
                document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
                document.getElementById('runTestBtn').disabled = show;
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let ui;
        document.addEventListener('DOMContentLoaded', () => {
            ui = new StrategyTesterUI();
        });
    </script>
</body>
</html>